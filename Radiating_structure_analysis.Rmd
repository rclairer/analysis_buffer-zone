---
title: "Radiating_structure_analysis"
author: "Claire_Rosemond"
date: "October 9, 2016"
output: html_document
---

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r working_dir}

setwd("C:/Users/rclairer/Dropbox (Paxton)/Paxton Team Folder/CRFL - Artificial Reefs/Buffer_Zone/analysis_buffer-zone")

```

```{r setup}
opts_chunk$set(echo = FALSE)
invisible(sapply(list.files(path = "R", pattern = "R$", full.names = TRUE), source)) # find functions and other dependencies in .R files
```

```{r get_data}

### FISH DATA ### --------------------------------------------------------------
detach("package:plyr", unload=TRUE)
library(dplyr)
library(lubridate)
library(reshape2)

fish_data <- read.csv ("Fish/4_clean_data/fish_clean_data_output_structure.csv")
fish_data_structure <- filter(fish_data, Structure_Present == "Yes")
fish_data_no <- filter(fish_data, Structure_Present != "Yes")
fish_data_no$Structure_Present <- "No"

fish_data_both <- rbind(fish_data_structure, fish_data_no)

fish_meta_both <- combine_data_meta (data = fish_data_both, 
                                file_meta = "Metadata/Fish/Fish_Codes_CRFL-AR.csv", 
                                merge_by = "Species_Code") 
fish_meta_both <- filter(fish_meta_both, Pelagic.Demersal == "Demersal")
fish_meta_both <- filter(fish_meta_both, Water_Col_Position != "R_S_W", Water_Col_Position != "S_W", Water_Col_Position != "W")

fish_biom_both<-make_fish_biomass_col(data = fish_meta_both)



fish_meta_structure <- combine_data_meta (data = fish_data_structure, 
                                file_meta = "Metadata/Fish/Fish_Codes_CRFL-AR.csv", 
                                merge_by = "Species_Code") 
fish_meta_structure <- filter(fish_meta_structure, Pelagic.Demersal == "Demersal")
fish_meta_structure <- filter(fish_meta_structure, Water_Col_Position != "R_S_W", Water_Col_Position != "S_W", Water_Col_Position != "W")


fish_meta_no <- combine_data_meta (data = fish_data_no, 
                                file_meta = "Metadata/Fish/Fish_Codes_CRFL-AR.csv", 
                                merge_by = "Species_Code") 
fish_meta_no <- filter(fish_meta_no, Pelagic.Demersal == "Demersal")
#fish_meta_no <- filter(fish_meta_no, Water_Col_Position == "R")
fish_meta_no<-filter(fish_meta_no, Water_Col_Position != "R_S_W", Water_Col_Position != "S_W", Water_Col_Position != "W")


fish_biom_structure<-make_fish_biomass_col(data = fish_meta_structure)
fish_biom_no<-make_fish_biomass_col(data = fish_meta_no)
####################################################################

#fish_subset <- subset_data (data = fish_biom,
                          #sub_cat = "Pelagic.Demersal", #sub_cat = "Snapper.Grouper",
                          #sub_val = "Demersal") # YES for yes

## make fish abundance matrix
#fish_biom -> data

#data$group <- data[,"Species_Code"] # change to family or function_group as needed
#data$group <- data[,"Family"]
#data$group <- data[,"Functional_Group"]

#data$group <- data[,"Family"] #### FAMILY AND FUNCTIONAL GROUP DON"T WORK AS IS BECAUSE THERE ARE FISH WITHOUT FAMILIES AND FUNCTIONAL GROUPS MATCHING THEM...NEEDS FIXING"

#new2 <- data %>% group_by(group, ID, Site, Subsite, Date, Transect_Type, Sampling_Period, Transect_Number) %>% summarise(data_abund = sum(Abundance))
#new3 <- dcast(new2, ID + Site + Subsite + Date + Transect_Type + Sampling_Period + Transect_Number ~ group) 

#hi2 <- data %>% group_by(group, ID, Site, Subsite, Date, Transect_Type, Sampling_Period, Transect_Number, Structure_Present, Radiating_Structure) %>% summarise(data_abund = sum(Abundance))
#hi3 <- dcast(new2, ID + Site + Subsite + Date + Transect_Type + Sampling_Period + Transect_Number + Structure_Present + Radiating_Structure ~ group) 

#new3[is.na(new3)]<-0
#new4 = new3[rowSums(new3[,8:ncol(new3)]) !=0,] # remove rows where there were no fish on the transect - need this for species, family, and functional group levels
#fish_abund_matrix <- new4

fish_abund_matrix_both <- calc_fish_abund_matrix (data = fish_biom_both, 
                                     tax_level = "Species_Code")
#                                       #tax_level = "Family")



fish_abund_matrix_structure <- calc_fish_abund_matrix (data = fish_biom_structure, 
                                     tax_level = "Species_Code")
#                                       #tax_level = "Family")


fish_abund_matrix_no <- calc_fish_abund_matrix (data = fish_biom_no, 
                                     tax_level = "Species_Code")
#                                       #tax_level = "Family")

fish_biom_matrix_both <- calc_fish_biom_matrix (data = fish_biom_both, 
                                         tax_level = "Species_Code")
#                                            #tax_level = "Family")
#                                           tax_level = "Functional_Group")



fish_biom_matrix_structure <- calc_fish_biom_matrix (data = fish_biom_structure, 
                                         tax_level = "Species_Code")
#                                            #tax_level = "Family")
#                                           tax_level = "Functional_Group")

fish_biom_matrix_no <- calc_fish_biom_matrix (data = fish_biom_no, 
                                         tax_level = "Species_Code")
#                                            #tax_level = "Family")
#                                           tax_level = "Functional_Group")



#fish_abund_matrix <- rbind(fish_abund_matrix_structure, fish_abund_matrix_no)

#fish_biom_matrix <- rbind(fish_biom_matrix_structure, fish_biom_matrix_no)
# If at species level, bring meta data back in --> can't do if in wide format obviously!
#library(plyr)
#fish_abund <- rename(fish_abund, c("group"="Species_Code"))
#fish_abund <- combine_data_meta(data = fish_abund, 
                  #file_meta = "Metadata/Fish/Fish_Codes.csv",
                  #merge_by = "Species_Code")

#fish <- fish_abund_matrix # select either abundance or biomass matrix

#fish <- remove_rare_species (data = fish) # remove rare species if desired

#rm(fish_data, fish_meta, fish_biom, fish_subset, fish_abund_matrix, fish_biom_matrix) # remove dataframes


### COMPLEXITY DATA ### -------------------------------------------------------
#comp <-read.table("Complexity/3_Clean_Data/comp_site_change.csv", header=T, sep=',')


### TEMPEATURE DATA ### -------------------------------------------------------
#temp <-read.table("Temperature/3_Clean_Data/temp_site_change.csv", header=T, sep=',')


### SITES METADATA ### ------------------------------------------------------------
#sites <-read.table("Metadata/Sites/CRFL-AR_SITES_Master_2016-06-30_new.csv", header=T, sep=',')

### MERGE DATA ### ------------------------------------------------------------

#library(plyr)

#join1 <- join(fish, temp, by = c("Site", "Subsite", "Date", "Transect_Type","Transect_Number"))
#join2 <- join(join1, comp, by = c("Site", "Subsite", "Date", "Transect_Type","Transect_Number"))
#join3 <- join(join2, sites, by = c("Site", "Subsite")) 

#join4 <- cbind(join3[,1:8], join3[,91:114], join3[,9:90]) #FOR SPECIES crude way of rearranging so that columns are in decent order; it duplicates ID and names it ID.1 for the duplicate so delete that column later on 
#join4 <- cbind(join3[,1:9], join3[,37:60], join3[,10:36]) #FOR FAMILY 
#join4 <- cbind(join3[,1:9], join3[,17:40], join3[,10:16]) #FOR FUNCTIONAL GROUP 

# new ones
#join4 <- cbind(join3[,1:7], join3[,88:111], join3[,8:87]) # species
#join4 <- cbind(join3[,1:7], join3[,40:ncol(join3)], join3[,8:39]) # family
#join4 <- cbind(join3[,1:7], join3[,16:ncol(join3)], join3[8:15]) #Functional group

#join5 <- join4[,-c(8, 12)] # FOR SPECIES
#join5 <- join4[,-c(8,12)] # FOR FAMILY 
#join5 <- join4[,-c(8,12)] # FOR FUNCTIONAL GROUP

#data <- join5


#rm(list= ls()[!(ls() %in% c('data'))]) # removes everything except selected data frame(s) 


## Filter data if necessary ## -------------------------------
#data <- filter(data, Reef_type == "Natural")
#data <- filter(data, Reef_type == "Artificial")
 #data <- filter(data, Depth_general == "Shallow")
# data <- filter(data, Depth_general == "Shallow")
# data <- filter(data, Depth_general == "Deep")
#data <- filter(data, Reef_type == "Natural", Depth_general == "Intermediate")

data <- fish_abund_matrix_both
env.end<- 10 #FOR SPECEIS
sp.start<-11 #FOR SPECIES
#env.end <- 29 #FOR FAMILY
#sp.start <- 30 #FOR FAMILY
#env.end <- 29 #FOR FUNCTIONAL GROUP
#sp.start <-30 #FOR FUNCTIONAL GROUP

# preserve biomass data for plotting
#biom_data<-merge(merge.2, fish_biom_matrix)
#biom_data <- filter(biom_data, Reef_type == "Artificial")
### REMOVE OUTLIER 200LE on 2014-07-01
#biom_data <- biom_data[-8,]

#biom_data <- biom_data[,sp.start:ncol(biom_data)]

env_data <- data[,1:env.end]
 
species.data<-data[,sp.start:ncol(data)] # fish data
species.orig<-species.data # fish data, no transform

#species.data <- transform_data (data = species.data, transform_type = "square_root")
species.data <- transform_data (data = species.data, transform_type = "cube_root")
#species.data <- transform_data (data = species.data, transform_type = "pres_abs")


```

```{r abs/pres_of_structure}
library(ggplot2)
library(plyr)
library(dplyr)
#fishabundance <- mutate(data, Abundance = rowSums(data[,30:ncol(data)]))


fishabundstruc <- mutate(fish_abund_matrix_structure, Abundance = rowSums(fish_abund_matrix_structure[,11:ncol(fish_abund_matrix_structure)]))

fishabundno <- mutate(fish_abund_matrix_no, Abundance = rowSums(fish_abund_matrix_no[,11:ncol(fish_abund_matrix_no)]))
#test <- summarySE(fishabundance, measurevar = "Abundance", groupvars = c("Transect_Number", "Sampling_Period"))

struc <- summarySE(fishabundstruc, measurevar = "Abundance", groupvars = c("Transect_Number"))

no <- summarySE(fishabundno, measurevar = "Abundance", groupvars = c("Transect_Number"))

################################################################################

#ggplot(struc, aes(x=as.factor(Transect_Number), y=Abundance))+
#  theme_classic()+
#  geom_bar(position=position_dodge(), stat="identity", colour="black")+
#  geom_errorbar(aes(ymin=Abundance-se, ymax=Abundance+se), width=.2, position=position_dodge(0.9))+
#  scale_y_continuous(name="Average Fish Abundance", 
 #                    limits=c(0, 500), 
#                     breaks=seq(0, 500,by=100)) + 
#  theme(axis.text=element_text(size=16, colour="black"), 
#        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
#        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
#        legend.position="none") + 
#  scale_x_discrete(name = "Transect Type", labels = c("0" = "Structural", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))

#ggplot(no, aes(x=as.factor(Transect_Number), y=Abundance))+
 # theme_classic()+
  #geom_bar(position=position_dodge(), stat="identity", colour="black")+
#  geom_errorbar(aes(ymin=Abundance-se, ymax=Abundance+se), width=.2, position=position_dodge(0.9))+
#  scale_y_continuous(name="Average Fish Abundance", 
 #                    limits=c(0, 500), 
  #                   breaks=seq(0, 500,by=100)) + 
#  theme(axis.text=element_text(size=16, colour="black"), 
 #       axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
  #      axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
   #     legend.position="none") + 
  #scale_x_discrete(name = "Transect Type", labels = c("0" = "Structural", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))
##################################################################################
struc$Structure <- "Yes"
no$Structure <- "No"
allstrucno <- rbind(no, struc)
allstrucno [1,7] <- "Yes"

###################################################################################
#allstrucno.plot = ggplot(allstrucno, aes(x=as.factor(Transect_Number), y=Abundance), fill = name)

#allstrucno.plot + geom_bar (stat = "identity", position = "dodge") +theme_classic () +
 #geom_bar(position=position_dodge(), stat="identity", colour="black")+
#geom_errorbar(aes(ymin=Abundance-se, ymax=Abundance+se), width=.2, position=position_dodge(0.9))+
 # scale_y_continuous(name="Average Fish Abundance", 
  #                   limits=c(0, 700), 
   #                  breaks=seq(0, 700,by=100)) + 
  #theme(axis.text=element_text(size=16, colour="black"), 
   #     axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
    #    axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
     #   legend.position="bottom") + 
#  scale_x_discrete(name = "Transect Type", labels = c("0" = "Structural", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))
#######################################################################################
transparent <- ggplot(NULL, aes(as.factor(Transect_Number), Abundance)) + 
  geom_bar(aes(fill = "Yes"), data = struc, stat = "identity", alpha = 0.5) +
  geom_bar(aes(fill = "No"), data = no, stat = "identity", alpha = 0.5)
transparent + theme_classic()
#####################################################################################

adjacent <- ggplot(allstrucno, aes(as.factor(Transect_Number), Abundance, fill = Structure)) + geom_bar(stat = "identity", position = "dodge")

adjacent + theme_classic()
#####################################################################################
allstrucno_test <- rbind(allstrucno[1,], allstrucno[5:7,], allstrucno[2:4,])
#allstrucno$name <- factor(allstrucno$name, c("no", "struc"))
#order levels of treatment to appear orderly in plots
allstrucno_test$abund <- c(allstrucno_test[1,3], allstrucno_test[2,3], allstrucno_test[3,3], allstrucno_test[4,3], (allstrucno_test[5,3]+ allstrucno_test[2,3]), (allstrucno_test[6,3]+allstrucno_test[3,3]), (allstrucno_test[7,3]+allstrucno_test[4,3]))


stack <- ggplot(allstrucno_test, aes(as.factor(Transect_Number), Abundance, fill = Structure)) + geom_bar(stat = "identity", position = "stack")

stack + theme_classic()+ ggtitle("Demersal Fish Abundance on Structure")+
#geom_errorbar(aes(ymin=Abundance-se, ymax=Abundance+se), width=.2)+#, position=position_dodge(0.9))+
  scale_y_continuous(name="Average Fish Abundance", 
                     limits=c(0, 250), 
                     breaks=seq(0, 250,by=50)) + 
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="bottom") + 
  scale_x_discrete(name = "Transect Type", labels = c("0" = "Structural", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))+
 # geom_errorbar(aes(ymin=abund-se, ymax=abund+se), position = "identity", width=.2)
  geom_errorbar(aes(ymin=abund-se, ymax=abund+se), position = position_dodge(0.5), width=.2)


################################################################################
#helpme <- ggplot(NULL, aes(as.factor(Transect_Number), Abundance), fill = name) +
 # geom_bar(aes(fill = "struc"), data = struc, stat = "identity", alpha = 0.5, position = "dodge") +
  #geom_bar(aes(fill = "no"), data = no, stat = "identity", alpha = 0.5, position = "dodge")
#helpme + theme_classic()


#struc.plot = ggplot(struc, aes(x=as.factor(Transect_Number), y=Abundance), fill = name) +   geom_bar (stat = "identity", position = "dodge") +theme_classic ()

#no.plot = ggplot(no, aes(x=as.factor(Transect_Number), y=Abundance), fill = name) +   geom_bar (stat = "identity", position = "dodge") +theme_classic ()


#no.plot
#struc.plot

#+  scale_y_continuous(name="Bray Curtis Dissimilarity", limits=c(0, 1), breaks=seq(0, 1, by=0.05)) + scale_x_continuous(name = "Distance", limits=c(0, 10), breaks=seq(0, 10,by=1))


#ggplot() +
#  geom_bar(data = allstrucno, aes(no, struc), position = "dodge")

#allstrucno.plot <- ggplot(allstrucno, aes(no, struc, fill = name)) + geom_bar(position = "dodge")
#allstrucno.plot


#ggplot()+
 # theme_classic()+
  #geom_bar(aes(x=as.factor(Transect_Number), y=Abundance), data = struc, position=position_dodge(), stat="identity", colour="black")+
 # geom_errorbar(aes(ymin=Abundance-se, ymax=Abundance+se), width=.2, position=position_dodge(0.9))+
  #scale_y_continuous(name="Average Fish Abundance", 
   #                  limits=c(0, 500), 
    #                 breaks=seq(0, 500,by=100)) + 
  #theme(axis.text=element_text(size=16, colour="black"), 
   #     axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
    #    axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
     #   legend.position="none") + 
  #scale_x_discrete(name = "Transect Type", labels = c("0" = "Structural", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))


#ggplot(struc, aes(x=as.factor(Transect_Number), y=Abundance)) +
 # theme_classic()+ stat = "identity"
  #+
  #geom_errorbar(aes(ymin=Abundance-se, ymax=Abundance+se), width=.2, position=position_dodge(0.9))+
#  scale_y_continuous(name="Average Fish Abundance", 
 #                    limits=c(0, 500), 
  #                   breaks=seq(0, 500,by=100)) + 
  #theme(axis.text=element_text(size=16, colour="black"), 
   #     axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
    #    axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
     #   legend.position="none") + 
#  scale_x_discrete(name = "Transect Type", labels = c("0" = "Structural", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))
  


# fill for extra variable (in this case season)
#test1 <- summarySE(fishabundance, measurevar = "Abundance", groupvars = #c("Transect_Number", "Sampling_Period"))
#test1$Sampling_Period <- factor(test1$Sampling_Period, c("Fall", "Winter", "Spring"))
#order levels of treatment to appear orderly in plots


#ggplot(test1, aes(x=as.factor(Transect_Number), y=Abundance, fill=Sampling_Period)) +
 # theme_classic()+
#  geom_bar(position=position_dodge(), stat="identity", colour="black")+
 # geom_errorbar(aes(ymin=Abundance-se, ymax=Abundance+se), width=.2, position=position_dodge(0.9))+
#  scale_y_continuous(name="Average Fish Abundance", 
 #                    limits=c(0, 700), 
  #                   breaks=seq(0, 700,by=100)) + 
  #theme(axis.text=element_text(size=16, colour="black"), 
   #     axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
    #    axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
     #   legend.position="bottom") + 
#  scale_x_discrete(name = "Transect Type", labels = c("0" = "Structural", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))

#order levels of treatment to appear orderly in plots, move this higher
# facets
#can do fill within facet
#ggplot(test1, aes(x=as.factor(Transect_Number), y=Abundance)) +
 # theme_classic()+
  #facet_wrap(~Sampling_Period, ncol=3)+
#  geom_bar(position=position_dodge(), stat="identity", colour="black")+
 # geom_errorbar(aes(ymin=Abundance-se, ymax=Abundance+se), width=.2, position=position_dodge(0.9))+
#  scale_y_continuous(name="Average Fish Abundance", 
 #                    limits=c(0, 700), 
  #                   breaks=seq(0, 700,by=100)) + 
#  theme(axis.text=element_text(size=16, colour="black"), 
 #       axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
  #      axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
   #     legend.position="bottom") + 
#  scale_x_discrete(name = "Transect Type", labels = c("0" = "Structural", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))

#fishFall <- filter(fishabundance, Sampling_Period == "Fall")
#fishWinter <- filter(fishabundance, Sampling_Period == "Winter")
#fishSpring <- filter(fishabundance, Sampling_Period == "Spring")
  
#test2 <- summarySE(fishabundance, measurevar = "Abundance", groupvars = c("Transect_Number", "Reef_Type"))

#ggplot(test2, aes(x=as.factor(Transect_Number), y=Abundance, fill=Reef_Type)) +
 # theme_classic()+
  #geom_bar(position=position_dodge(), stat="identity", colour="black")+
#  geom_errorbar(aes(ymin=Abundance-se, ymax=Abundance+se), width=.2, position=position_dodge(0.9))+
#  scale_y_continuous(name="Average Fish Abundance", 
 #                    limits=c(0, 500), 
  #                   breaks=seq(0, 500,by=100)) + 
  #theme(axis.text=element_text(size=16, colour="black"), 
   #     axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
    #    axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
     #   legend.position="bottom") + 
  #scale_x_discrete(name = "Transect Type", labels = c("0" = "Structural", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))

#ggplot(test2, aes(x=as.factor(Transect_Number), y=Abundance, fill=Reef_Type)) +
 # theme_classic()+
  #facet_wrap(~Reef_Type, ncol = 2) +
  #geom_bar(position=position_dodge(), stat="identity", colour="black")+
  #geom_errorbar(aes(ymin=Abundance-se, ymax=Abundance+se), width=.2, position=position_dodge(0.9))+
  #scale_y_continuous(name="Average Fish Abundance", 
   #                  limits=c(0, 500), 
    #                 breaks=seq(0, 500,by=100)) + 
  #theme(axis.text=element_text(size=16, colour="black"), 
   #     axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
    #    axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
     #   legend.position="bottom") + 
  #scale_x_discrete(name = "Transect Type", labels = c("0" = "Structural", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))


```

```{r per_structure_type}

#use fishabundstruc

fishabundstruc$Radiating_Structure <- revalue(fishabundstruc$Radiating_Structure, c("Structure" = "Unknown Structure"))
fishabundstruc$Radiating_Structure <- revalue(fishabundstruc$Radiating_Structure, c("Reef ball" = "Reef Ball"))

fishabundstruc$Radiating_Structure <- as.character(fishabundstruc$Radiating_Structure)

fishabundstruc$Radiating_Structure <- ifelse(nchar(fishabundstruc$Radiating_Structure)==0, "Unknown Structure", fishabundstruc$Radiating_Structure)

fishabundstruc[15,10] = "Unknown Structure"

#by transect
adjacent_type <- ggplot(fishabundstruc, aes(as.factor(Transect_Number), Abundance, fill = Radiating_Structure)) + geom_bar(stat = "identity", position = "dodge")

adjacent_type + theme_classic()

#by type
adjacent_type <- ggplot(fishabundstruc, aes(Radiating_Structure, Abundance)) + geom_bar(stat = "identity", position = "dodge")

adjacent_type + theme_classic()




##############################################################################



```

#univariate statistics/visulizations
```{r ANOVA}
help <- anova()
```

```{r Post_hoc_comparisons}

```

#multivariate statistics/visualizations
```{r PERMANOVA}

library(vegan)
permanova<-adonis(species.data ~ Transect_Number * Structure_Present, env_data, permutations = 1000, method = "bray")
permanova

summary(permanova)
permanova$aov.tab
permanova$coefficients
permanova$coef.sites
permanova$f.perms
permanova$model.matrix
permanova$terms


densityplot(permustats(permanova))




# permanova to test for effect of relief and complexity

#library(ecodist)
    #species.bcd<-distance(as.matrix(species.data), method="bray")
    #head(species.bcd)
#environmental data from PCA and filtered for structural
    
#env_data.bcd <- filter(env_data.structural, env_data.structural$DRR != 'N/A')
#env_data.filter <- filter(env_data.bcd, Transect_Type == "Structural")
#env_data.filter <- as.matrix(env_data.filter)    
#species.bcd_df <- as.matrix(species.bcd_df)

#set.seed(318)
#library(vegan)
#permanova<-adonis(species.bcd_df ~ Temp_max, env_data.filter, permutations = 1000, method = "bray")
#permanova
#***********************************************
#MANOVA
#t0 <- filter(data, Transect_Type == "Structural")
#radiating <- filter(data, Transect_Type == "Radiating")
#t1 <- filter(radiating, Transect_Number == '1')
#t2 <- filter(radiating, Transect_Number == '2')
#t3 <- filter(radiating, Transect_Number == '3')

#t0 <- as.matrix(t0)
#t1 <- as.matrix(t1)
#all.transects <- cbind (t0, t1,t2, t3)



#********************************************


#permanova.transect<-adonis(species.data ~ Transect_Number, env_data, permutations = 999, method = "bray")
#permanova.transect2<-adonis2(species.data ~ Transect_Number, env_data, permutations = 999, method = "bray", by = "terms")
#permanova.transect2

 # permanova.transect
  
#  summary(permanova.transect)
#*****************************************  
#permanova.transect$aov.tab
#permanova.transect$coefficients
#permanova.transect$coef.sites
#permanova.transect$f.perms
#permanova.transect$model.matrix
#permanova.transect$terms


#densityplot(permustats(permanova.transect))
#*********************************************
  
#perm.trans.sea <- adonis(species.data ~ Transect_Number * Sampling_Period, env_data, permutation = 999, method = "bray")
#perm.trans.sea

#******************************************************************
  
#set.seed(318)
#library(vegan)
#permanova<-adonis(species.bcd ~ Reef_Type*Depth_general*temp_avg, env_data, permutations = 1000, method = "bray")
#permanova
# Depth and reef type are significant


#library(vegan)
#permanova<-adonis(species.bcd ~ temp_avg, env_data, permutations = 1000, method = "bray")
#permanova

#library(vegan)
#permanova<-adonis(species.bcd ~ Reef_type*avg_dep*DRR*ver_rel*temp_avg, env_data, permutations = 1000, method = "bray")
#permanova
# reef type, drr, temp are all significant!

#permanova<-adonis(species.data ~ver_rel, env_data, permutations = 1000, method = "bray")
# vertical relief and drr are significant for community according to permanova, but doesn't account for any variability

#permanova<-adonis(species.bcd ~ Reef_type * ver_rel, env_data, permutations = 1000, method = "bray")
# vertical relief and drr are significant for community according to permanova, but doesn't account for any variability

#permanova<-adonis(species.bcd~drr*temp_avg*Site, env.data, permutations =1000, method="bray")
#permanova

#permanova<-adonis(species.data ~ Reef_type*drr, env.data, permutations = 10000, method = "bray")
#permanova
# reef type and drr are significant

#permanova<-adonis(species.bcd ~ Reef_type * drr * avg_dep * sed_avg, env.data, permutations = 1000, method = "bray")
#permanova
# See that interactions aren't significant, so build as additive model instead

#permanova<-adonis(species.bcd ~ Reef_type + drr + avg_dep + sed_avg, env.data, permutations = 1000, method = "bray")
#permanova
# See that all are significant!

#permanova<-adonis(species.data ~ sed_stdv, env_data, permutations = 1000, method = "bray")

#permanova<-adonis(species.bcd ~ Reef_type*ver_rel*drr*avg_dep*Samp*Location*sed_avg, env.data, permutations = 1000, method = "bray")
#permanova
# full model --> doesn't seem to indicate much.... 

# This is the permanova output table
#permanova$aov.tab

# Other output
#summary(permanova)
#permanova$coefficients
#permanova$coef.sites
#permanova$f.perms
#permanova$model.matrix
#permanova$terms

#densityplot(permanova)

```

```{r ANOSIM}

# Goal to find differences between and among groups 

library(ecodist)
    species.bcd<-distance(as.matrix(species.data), method="bray")
    head(species.bcd)

library(vegan)
set.seed(318)


ano_reef<-anosim(species.data, env_data$Reef_Type, permutations = 1000, distance = "bray")  
ano_reef
  plot(ano_reef)
  summary(ano_reef)
  # result: community composition based on abundance is significantly different by reef type
  
  
#env_data$Transect_Number <- as.numeric(env_data$Transect_Number)

ano_transectnumber<-anosim(species.data, env_data$Transect_Number, permutations = 1000, distance = "bray")
  ano_transectnumber
  plot(ano_transectnumber)
  summary(ano_transectnumber)
  
ano_transect_season <- anosim(species.data, env_data$Transect_Number :
env_data$Sampling_Period, permutations = 1000, distance = "bray")
ano_transect_season
plot(ano_transect_season)
summary(ano_transect_season)
#what might make this work????
  
set.seed(318)
ano_depth<-anosim(species.data, env_data$Depth_general, permutations = 1000, distance = "bray")
  ano_depth
  plot(ano_depth)
  summary(ano_depth)

ano_reef_depth <- anosim(species.data, env_data$Depth_general : env_data$Reef_type, permutations = 1000, distance = "bray")
ano_reef_depth
plot(ano_reef_depth)
summary(ano_reef_depth)


ano_site<-anosim(species.data, env_data$Site, permutations = 1000, distance = "bray")
  ano_site
  plot(ano_site)
  summary(ano_site)

ano_samp<-anosim(species.data, env_data$Sample, permutations = 1000, distance = "bray")
  ano_samp
  plot(ano_samp)
  summary(ano_samp)

## Guidelines for interpretation. From Lauren Yeager's Community Analysis course in spring 2014.
  # Null hypothesis is that no difference in community structure among groups
  # ANOSIM is based on similarity matrix and is a non-parametric permutation procedure
  # R ranges between -1 and 1
    # R = 1 if all replicates w/i one group are more similar to each other than any replicate from a different group
    # R approx 0 if null hypothesis true
    # R <0 if there are more differences among samples within a group than between groups

```

```{r SIMPER}
  
```  

```{r indicator_species}
  
```

```{r new_nMDS}
library(vegan)
set.seed(318) 

species.metaMDS <- metaMDS(species.data, distance = "bray", k=2, trymax = 1000, autotransform = FALSE) 
  # performs nMDS; arguments are as follows:
  # 1st argument: input data; these data should already be transformed if autotransform is set to FALSE
  # 2nd argument: dissimilarity index
  # 3rd argument: k is number of dimensions
  # 4th argument: trymax is maximum number of random starts used to search for a stable solution (iterations)
  # 5th argument: the function does NOT autotransform data, rather it assumes your 1st argument is transformed correctly

stressplot(species.metaMDS) # Shepard plot

species.metaMDS$stress # stress value

plot(species.metaMDS) # rough plot
text(species.metaMDS$species[,1:2],rownames(species.metaMDS$species),cex=0.8,col="red") # add species labels to the plot (weighted averages)

## references
# https://cran.r-project.org/web/packages/vegan/vignettes/intro-vegan.pdf
# https://jonlefcheck.net/2012/10/24/nmds-tutorial-in-r/
# http://strata.uga.edu/6370/lecturenotes/multidimensionalScaling.html

# extract info neccessary for polished plotting
scores <- species.metaMDS$points # scores
species.nms <- cbind(scores, env_data) # datset with scores and env data

# weighted averages for species 
species.wa <- data.frame(species.metaMDS$species) 
species.wa <- cbind(row.names(species.wa), species.wa) 
library(plyr)
species.wa <- rename(species.wa, c("row.names(species.wa)"="species_code"))
#added and named the sp code column, the first column w/ sp names is visually but NOT functionally there 

stress <- species.metaMDS$stress # save stress value

nms.xod1 <- dist(species.nms[,1]) # pearson correlation 
nms.xod2 <- dist(species.nms[,1:2]) # pearson correlation
r1<-cor(species.bcd,nms.xod1)
r2.1<-r1^2; r2.1
# axis 2 is 2-D minus 1-D solution:
r2<-cor(species.bcd,nms.xod2)
r2.2<-r2^2; 
r2.2<-r2.2-r2.1

# now plot it
NMDS = data.frame(MDS1 = species.nms[,1], MDS2 = species.nms[,2]) # data frame to work with
  yl<-paste("NMS 2 ", '(', as.character(round(r2.2, digits=2)*100), '%', ')', sep='') # y axis label
  xl<-paste("NMS 1 ", '(', as.character(round(r2.1, digits=2)*100), '%', ')', sep='') # x axis label
  title<-paste(" ", 'stress = ', as.character(round(stress, digits=2)), '', sep='') # title
  library(colorspace)
  ggplot()+
    coord_equal()+ # axes sizes equal
    theme_bw()+ # basic theme
    geom_point(data = NMDS, 
               aes(x = MDS1, y = MDS2, color = species.nms$Reef_type, shape=species.nms$Reef_type), 
               size=5) + # adds sample points
    geom_text(data=species.wa,
              aes(x=species.wa[,2],y=species.wa[,3],label=species_code),
              alpha=0.9, # adds weighted averages for species
              position=position_jitter(width=0.1,height=0.2))+
    stat_ellipse(data = NMDS, 
                 aes(x=MDS1,y=MDS2,colour=species.nms$Reef_type),
                 level = 0.50, linetype=2, size =1) + # adds ellipses for 95% confidence intervals
    scale_y_continuous(name=yl) + # names y axis
    scale_x_continuous(name=xl) + # names x axis
    theme(axis.text=element_text(size=16), 
          axis.title=element_text(size=16), 
          legend.text=element_text(color="black", size=16), 
          legend.title=element_text(color="black", size = 16), 
          legend.position="bottom") + 
    scale_colour_manual(name = "Reef Type", 
                        values = c("Artificial" = "indianred2", "Natural" = "darkturquoise"))+
    scale_shape_manual (name="Reef Type", 
                        values = c("Artificial" = 17, "Natural" = 16))+
    ggtitle(title)

# if get error saying removed rows (geom_text), check to make sure no N/A values in dataframe....

    
```

```{r nMDS} 
library(ecodist)
library(vegan)
library(ggplot2)
# nmds calculations
out.nms <- calc_nms_ord(species.data = species.data)

# if from function
species.nms <- out.nms[[1]] # nmds scores
r2.2 <- out.nms[[2]] # r^2 for NMS 2
r2.1 <- out.nms[[3]] # r^2 for NMS 1
stress <- out.nms[[4]] # stress value

species.wa <- get_wght_avg_spec(species.nms, species.data) # species weighted average scores
#vect.vf <- get_env_vectors (species.nms, env_data) # environmental vectors that have pval < 0.05
hull.data.reefs  <-get_convex_hulls_reefs(species.nms) # convex hulls for reef type
#hull.data.depths <- get_convex_hulls_depth(species.nms) # convex hulls for depth categories


# Plots
#plot_nmds_reef_type(species.nms, species.wa) 
plot_nmds_transect_number(species.nms, species.wa)

#plot_nmds_transect_number(species.nms)
#plot_nmds_depth (species.nms)
#plot_nmds_complexity_reef_type(species.nms)

```

```{r PCA}

### Exploratory data analysis
library(dplyr)
summary(env_data)
names(env_data)

# remove rows where no water level logger data (NA values for temp, depth, and drr)

env_data <- filter(env_data, env_data$DRR != 'N/A')

nat <- filter(env_data, env_data$Reef_Type == 'Natural')
art <- filter(env_data, env_data$Reef_Type == 'Artificial')
art_no_na<- filter(art, art$DMF_Area_sqft != 'N/A')

env_data <-rbind(nat, art_no_na) # for all reefs
#env_data <- art_no_na # for ARTIFICIAL reefs

# pick env variables to do PCA with 
#env.data.pca<-env_data[,c(23, 9, 16, 14)] # select variables of interest for ARTIFICIAL
env.data.pca<-env_data[,c(8, 15, 13)] # select variables of interest for NATURAL or ALL

env.data.pca$DMF_Area_sqft <- as.numeric(env.data.pca$DMF_Area_sqft)
env.data.pca$Temp_avg <- as.numeric(env.data.pca$Temp_avg)
env.data.pca$DRR <- as.numeric(env.data.pca$DRR)
env.data.pca$avg_dep <- as.numeric(env.data.pca$avg_dep)
# convert the ENV data to z-scores
# this relavitizes the environemtnal data
# default is to center (subtract column means) and scale (divide by st dev)
env.z <- scale(as.matrix(env.data.pca))  

# Recall cor, cor.test, and pairs from previously ...
# you should already have env17 from the Mantel lab
env.cor <- cor(env.data.pca) # check for correlated variables
cor.test(env.data.pca$avg_dep,env.data.pca$DRR)
cor.test(env.data.pca$avg_dep,env.data.pca$Temp_avg)

pairs(env.data.pca) # look for nonlinear relationships, eg xDepth sDepth
  # see that ver_rel and drr are correlated so can exclude one of them

# test normality
apply(env.data.pca,2,shapiro.test) 

# check for normal distribution
hist(env.data.pca$DRR)
#hist(env.data.pca$sed_stdv)
hist(env.data.pca$avg_dep)
hist(env.data.pca$DMF_Area_sqft)
#env.data.pca$Temp_avg <- as.numeric(env.data.pca$Temp_avg)
hist(env.data.pca$Temp_avg)

# transform to correct skewed distributions
env.data.pca$DRR<-sqrt(env.data.pca$DRR)
hist(env.data.pca$DRR) #still not normal
#env.data.pca$sed_stdv<-sqrt(env.data.pca$sed_stdv)
env.data.pca$avg_dep<-sqrt(env.data.pca$avg_dep)
hist(env.data.pca$avg_dep)
env.data.pca$DMF_Area_sqft<-sqrt(env.data.pca$DMF_Area_sqft)
hist(env.data.pca$DMF_Area_sqft)
env.data.pca$Temp_avg<-sqrt(env.data.pca$Temp_avg)
hist(env.data.pca$Temp_avg)

### PCA ----------

#make sure violations of assumptions aren't egregious before you begin PCA (which we did before)
set.seed(318)
# Do the PCA ...
# Here we have to use a correlation matrix because the variables
# are in different units:
env.pca <- princomp(env.data.pca, cor=T, scores=T)
#env.pca <- princomp(env.z, cor=T, scores=T)
  #cor=T to use correlation matrix (z-scores)
  #cor=F to use covariance matrix
  #scores = T means to calculate sample scores on new principal components for ordination

# Summary shows you the eigenvalues; print does the same:
summary(env.pca) 
#these are square roots of eigenvalues
#first pca has 76% of variance, next has 24% of variance
print(env.pca)

#eigenvalues
env.pca$sdev->env.pca.sdev
#write.csv(env.pca.sdev, "Inverts_Algae/2_Post-R_Data/env_pca_sdev.csv")

# Plot produces a scree plot of the eigenvalues per PC:
plot(env.pca)

# Print the loadings, to see which variables go with each PC:
print(env.pca$loadings) 
#these are regression coefficients 
# Print just the first 4, to 3 decimal places, and suppressing
# any loadings less than ABS(0.2) (this might not work):
#print(env.pca$loadings[,1:4],digits=3,cutoff=0.2)
print(env.pca$loadings,digits=3,cutoff=0.2)
# for lab report, can export this as a .csv file
# here we want to scan the loadings
#env17_pca_loadings<-print(env.pca$loadings[,1:4],digits=3,cutoff=0.2)
env_pca_loadings<-print(env.pca$loadings,digits=3,cutoff=0.2)
#write.csv(env_pca_loadings, "Inverts_Algae/2_Post-R_Data/env_pca_loadings.csv")

attributes(env.pca)  # shows objects in pca

# Biplot shows correlation vectors
# between the PCs and the original variables:
biplot(env.pca) 
# a bi plot plots two axes. It is a plot that puts two things on it in ordination world. One is a plot of sample scores. Second is the correlation vectors that it adds to the sample scores. Correlation vectors are red arrows, one for each environemntal variable. Length of arrow is scaled to magnitude of correlation. Can also look at raw numbers instead of plot if need to. These help you figure out what PCs refer to so you can know what to call your axes (e.g. soil chemistry, elevation, etc)
# The same, but plot asterisks for the plots (easier to see);
# here 99 is the number of samples:

# Plot the samples in the new PC space (defaults to PC 1 & 2):
plot(env.pca$scores) 
# An alternative, if you want to see different axes:
env.pca.scores <- as.data.frame(env.pca$scores)
names(env.pca.scores) # shows you that they are labelled Comp.1 etc

## Rename environmental variables
detach("package:dplyr", unload=TRUE)
library(plyr)
env.data.pca<-rename(env.data.pca, c("DMF_Area_sqft"="Area", "avg_dep"="Depth", "DRR"="Complexity", "Temp_avg"="Temperature"))

# a table of correlations between PCs and the original variables: #HELP NOT WORKING
library(ecodist)
#env.data.pca <- na.omit(env.data.pca)
cor2m(env.pca.scores,env.data.pca)
# even tidier:
env.pca.cor2m <- cor2m(env.pca.scores,env.data.pca)
print(env.pca.cor2m, digits=3)

## Plot it!
plot_pca_reef_type() 
env_data$Transect_Number <- as.character(env_data$Transect_Number) #don't forget to add as.character if using numeric
plot_pca_transect_number()
env_data$Site <- as.numeric(env_data$Site)
env_data$Site <- filter(env_data, env_data$Site != "342")
env_data$Site <- as.factor(env_data$Site)
plot_pca_site()
#plot_pca_reef_type_depth()
#plot_pca_depth()
#plot_pca_depth_sed()
#plot_pca_depth_comp()

#AR number
#unique site
#season

```

