sites <-read.table("Metadata/Sites/CRFL-AR_SITES_Master_2017-01-23.csv", header=T, sep=',')
### MERGE DATA ### ------------------------------------------------------------
library(plyr)
join1 <- join(fish, temp, by = c("Site", "Subsite", "Date", "Transect_Type","Transect_Number"))
join2 <- join(join1, comp, by = c("Site", "Subsite", "Date", "Transect_Type","Transect_Number"))
join3 <- join(join2, sites, by = c("Site", "Subsite"))
joinbiom1 <- join(fishbiom, temp, by = c("Site", "Subsite", "Date", "Transect_Type","Transect_Number"))
joinbiom2 <- join(joinbiom1, comp, by = c("Site", "Subsite", "Date", "Transect_Type","Transect_Number"))
joinbiom3 <- join(joinbiom2, sites, by = c("Site", "Subsite"))
#join4 <- cbind(join3[,1:7], join3[,81:110], join3[,8:80]) # species
join4 <- cbind(join3[,1:6], join3[,80:110], join3[,7:79]) # species
#join4 <- cbind(join3[,1:6], join3[,79:109], join3[,7:78]) # species NOFI excluded
#join4 <- cbind(join3[,1:7], join3[,80:109], join3[,8:79]) #for exclusion of NOFI
#join4 <- cbind(join3[,1:7], join3[,79:102], join3[,8:78]) #for exclusion of 2 and 3 and no fi
#join4 <- cbind(join3[,1:7], join3[,72:95], join3[,8:71]) # for exclusion of 1 and 2
#joinbiom4 <- cbind(joinbiom3[,1:7], joinbiom3[,81:110], joinbiom3[,8:80])
joinbiom4 <- cbind(joinbiom3[,1:6], joinbiom3[,80:110], joinbiom3[,7:79])
#joinbiom4 <- cbind(joinbiom3[,1:6], joinbiom3[,79:109], joinbiom3[,7:78]) #NOFI excluded
#joinbiom4 <- cbind(joinbiom3[,1:7], joinbiom3[,80:109], joinbiom3[,8:79])#for exclusion of NOFI
#joinbiom4 <- cbind(joinbiom3[,1:7], joinbiom3[,79:102], joinbiom3[,8:80])#for exclusion of 2 and 3
#joinbiom4 <- cbind(join3[,1:7], join3[,72:95], join3[,8:71]) # for exclusion of 1 and 2
#join4 <- cbind(join3[,1:7], join3[,36:ncol(join3)], join3[,8:35]) # family
#join4 <- cbind(join3[,1:7], join3[,16:ncol(join3)], join3[8:15]) #Functional group
#join5 <- join4[,-c(8, 12)]
join5 <- join4[,-c(11)]
#joinbiom5 <- joinbiom4[,-c(8, 12)]
joinbiom5 <- joinbiom4[,-c(11)]
data <- join5
databiom <- joinbiom5
env.end<- 36
sp.start<-37
env_data <- data[,1:env.end]
species.data<-data[,sp.start:ncol(data)] # fish data
species.orig<-species.data # fish data, no transform
species.data.biom <- databiom[,sp.start:ncol(databiom)]
species.orig.biom <- species.data.biom
#species.data <- transform_data (data = species.data, transform_type = "square_root")
species.data <- transform_data (data = species.orig, transform_type = "fourth_root")
species.data.biom <- transform_data (data = species.orig.biom, transform_type = "fourth_root")
#species.data <- transform_data (data = species.orig, transform_type
library(vegan)
S <- specnumber(species.data) # species richness (S)
shan <- diversity (species.data, index = "shannon") # shannon diversity
simp <- diversity (species.data, index = "simpson") # simpson's diversity
simp_inv <- diversity (species.data, index = "invsimpson") # inverse simpson's diversity
J <- shan / log (S) # pielou's evenness (J)
abund <- rowSums (species.data, na.rm = FALSE, dims = 1) # total abundance for each sample
biom <- rowSums (species.data.biom, na.rm = FALSE, dims = 1) # totaal biomass for each sample
comm_mets <- cbind (abund, biom, S, shan, simp, simp_inv, J, env_data)
View(comm_mets)
write.csv(comm_mets, file = "Metadata/comm_mets_trans_for_Steve.csv", row.names = FALSE)
plot.taketwo = ggplot(comm_mets, aes(x = as.factor(Transect_Number), y = as.numeric(abund)))
library(ggrepel)
plot.taketwo+
theme_classic()+
facet_wrap(~Sampling_Period, ncol=3)+
theme(axis.text=element_text(size=16, colour="black"),
axis.title.x=element_text(size=16, colour="black", vjust=-.5),
axis.title.y=element_text(size=16, colour="black", vjust=1.3),
legend.position="none",
axis.line.x = element_line(color="black", size = 0.5),
axis.line.y = element_line(color="black", size = 0.5),
plot.title = element_text(size = 16, hjust = 0.5))+
#abline(lm(abund ~ as.numeric(Transect_Number), data= abundanceddd))+
#geom_point (colour = "grey") +
# geom_point (aes(colour = GIS_FID)) +
#geom_point(aes(colour = Sampling_Period))+
geom_point()+
#geom_line(aes(group = interaction(Site, Subsite, Date), linetype = Sampling_Period))+
geom_line(aes(group = interaction(GIS_FID, Date, Sampling_Period)))+
#  guide_legend(title.position = "bottom")+
#geom_dl(aes(label = GIS_FID))+
#geom_text(data = subset(comm_mets, Transect_Number == "0"), aes(label = Table_ID), hjust = 1.5, check_overlap = TRUE)+#, x = 4, colour = GIS_FID , y = c(m), hjust = -.02))
#geom_text_repel(data = subset(comm_mets, Transect_Number == "0"), aes(label = Table_ID), nudge_x = 1.5, force = 1)+
geom_text_repel(data = subset(comm_mets, Transect_Number == "0"), aes(label = Table_ID), nudge_x = -0.25, force = 0.01, segment.color = "gray45")+
# geom_smooth (aes(colour = GIS_FID)) +
#geom_errorbar(aes(ymin=abund-se, ymax=abund+se), width=.05, position=position_dodge(0.9))+
scale_y_continuous(name="Fish Abundance", limits=c(0, 35), breaks=seq(0, 35, by=5)) +
#scale_x_continuous(name = "Distance (km)", limits=c(0, 120), breaks=seq(0, 120,by=20)) + geom_smooth(colour = "black", fullrange = FALSE)+
# scale_linetype_discrete(name = "Season", size = 16)+
scale_x_discrete(name = "Distance from Reef", labels = c("0" = "Reef", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))#+
#ggtitle("Fish Abundance by Distance from Reef per Season")
comm_mets$Sampling_Period <- factor(comm_mets$Sampling_Period, c("Fall", "Winter", "Spring"))
plot.taketwo+
theme_classic()+
facet_wrap(~Sampling_Period, ncol=3)+
theme(axis.text=element_text(size=16, colour="black"),
axis.title.x=element_text(size=16, colour="black", vjust=-.5),
axis.title.y=element_text(size=16, colour="black", vjust=1.3),
legend.position="none",
axis.line.x = element_line(color="black", size = 0.5),
axis.line.y = element_line(color="black", size = 0.5),
plot.title = element_text(size = 16, hjust = 0.5))+
#abline(lm(abund ~ as.numeric(Transect_Number), data= abundanceddd))+
#geom_point (colour = "grey") +
# geom_point (aes(colour = GIS_FID)) +
#geom_point(aes(colour = Sampling_Period))+
geom_point()+
#geom_line(aes(group = interaction(Site, Subsite, Date), linetype = Sampling_Period))+
geom_line(aes(group = interaction(GIS_FID, Date, Sampling_Period)))+
#  guide_legend(title.position = "bottom")+
#geom_dl(aes(label = GIS_FID))+
#geom_text(data = subset(comm_mets, Transect_Number == "0"), aes(label = Table_ID), hjust = 1.5, check_overlap = TRUE)+#, x = 4, colour = GIS_FID , y = c(m), hjust = -.02))
#geom_text_repel(data = subset(comm_mets, Transect_Number == "0"), aes(label = Table_ID), nudge_x = 1.5, force = 1)+
geom_text_repel(data = subset(comm_mets, Transect_Number == "0"), aes(label = Table_ID), nudge_x = -0.25, force = 0.01, segment.color = "gray45")+
# geom_smooth (aes(colour = GIS_FID)) +
#geom_errorbar(aes(ymin=abund-se, ymax=abund+se), width=.05, position=position_dodge(0.9))+
scale_y_continuous(name="Fish Abundance", limits=c(0, 35), breaks=seq(0, 35, by=5)) +
#scale_x_continuous(name = "Distance (km)", limits=c(0, 120), breaks=seq(0, 120,by=20)) + geom_smooth(colour = "black", fullrange = FALSE)+
# scale_linetype_discrete(name = "Season", size = 16)+
scale_x_discrete(name = "Distance from Reef", labels = c("0" = "Reef", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))#+
#ggtitle("Fish Abundance by Distance from Reef per Season")
plot.taketwo = ggplot(comm_mets, aes(x = as.factor(Transect_Number), y = as.numeric(abund)))
plot.taketwo+
theme_classic()+
facet_wrap(~Sampling_Period, ncol=3)+
theme(axis.text=element_text(size=16, colour="black"),
axis.title.x=element_text(size=16, colour="black", vjust=-.5),
axis.title.y=element_text(size=16, colour="black", vjust=1.3),
legend.position="none",
axis.line.x = element_line(color="black", size = 0.5),
axis.line.y = element_line(color="black", size = 0.5),
plot.title = element_text(size = 16, hjust = 0.5))+
#abline(lm(abund ~ as.numeric(Transect_Number), data= abundanceddd))+
#geom_point (colour = "grey") +
# geom_point (aes(colour = GIS_FID)) +
#geom_point(aes(colour = Sampling_Period))+
geom_point()+
#geom_line(aes(group = interaction(Site, Subsite, Date), linetype = Sampling_Period))+
geom_line(aes(group = interaction(GIS_FID, Date, Sampling_Period)))+
#  guide_legend(title.position = "bottom")+
#geom_dl(aes(label = GIS_FID))+
#geom_text(data = subset(comm_mets, Transect_Number == "0"), aes(label = Table_ID), hjust = 1.5, check_overlap = TRUE)+#, x = 4, colour = GIS_FID , y = c(m), hjust = -.02))
#geom_text_repel(data = subset(comm_mets, Transect_Number == "0"), aes(label = Table_ID), nudge_x = 1.5, force = 1)+
geom_text_repel(data = subset(comm_mets, Transect_Number == "0"), aes(label = Table_ID), nudge_x = -0.25, force = 0.01, segment.color = "gray45")+
# geom_smooth (aes(colour = GIS_FID)) +
#geom_errorbar(aes(ymin=abund-se, ymax=abund+se), width=.05, position=position_dodge(0.9))+
scale_y_continuous(name="Fish Abundance", limits=c(0, 35), breaks=seq(0, 35, by=5)) +
#scale_x_continuous(name = "Distance (km)", limits=c(0, 120), breaks=seq(0, 120,by=20)) + geom_smooth(colour = "black", fullrange = FALSE)+
# scale_linetype_discrete(name = "Season", size = 16)+
scale_x_discrete(name = "Distance from Reef", labels = c("0" = "Reef", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))#+
#ggtitle("Fish Abundance by Distance from Reef per Season")
plot.taketwo+
theme_classic()+
facet_wrap(~Sampling_Period, ncol=3)+
theme(axis.text=element_text(size=16, colour="black"),
axis.title.x=element_text(size=16, colour="black", vjust=-.5),
axis.title.y=element_text(size=16, colour="black", vjust=1.3),
legend.position="none",
axis.line.x = element_line(color="black", size = 0.5),
axis.line.y = element_line(color="black", size = 0.5),
plot.title = element_text(size = 16, hjust = 0.5))+
#abline(lm(abund ~ as.numeric(Transect_Number), data= abundanceddd))+
#geom_point (colour = "grey") +
# geom_point (aes(colour = GIS_FID)) +
#geom_point(aes(colour = Sampling_Period))+
geom_point()+
#geom_line(aes(group = interaction(Site, Subsite, Date), linetype = Sampling_Period))+
geom_line(aes(group = interaction(GIS_FID, Date, Sampling_Period)))+
#  guide_legend(title.position = "bottom")+
#geom_dl(aes(label = GIS_FID))+
#geom_text(data = subset(comm_mets, Transect_Number == "0"), aes(label = Table_ID), hjust = 1.5, check_overlap = TRUE)+#, x = 4, colour = GIS_FID , y = c(m), hjust = -.02))
#geom_text_repel(data = subset(comm_mets, Transect_Number == "0"), aes(label = Table_ID), nudge_x = 1.5, force = 1)+
geom_text_repel(data = subset(comm_mets, Transect_Number == "0"), aes(label = Table_ID), nudge_x = -0.25, force = 0.01, segment.color = "gray45")+
# geom_smooth (aes(colour = GIS_FID)) +
#geom_errorbar(aes(ymin=abund-se, ymax=abund+se), width=.05, position=position_dodge(0.9))+
scale_y_continuous(name="Forth Root Transformed Fish Abundance (ind.)", limits=c(0, 35), breaks=seq(0, 35, by=5)) +
#scale_x_continuous(name = "Distance (km)", limits=c(0, 120), breaks=seq(0, 120,by=20)) + geom_smooth(colour = "black", fullrange = FALSE)+
# scale_linetype_discrete(name = "Season", size = 16)+
scale_x_discrete(name = "Distance from Reef", labels = c("0" = "Reef", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))#+
#ggtitle("Fish Abundance by Distance from Reef per Season")
plot.taketwo+
theme_classic()+
facet_wrap(~Sampling_Period, ncol=3)+
theme(axis.text=element_text(size=16, colour="black"),
axis.title.x=element_text(size=16, colour="black", vjust=-.5),
axis.title.y=element_text(size=16, colour="black", vjust=1.3),
legend.position="none",
axis.line.x = element_line(color="black", size = 0.5),
axis.line.y = element_line(color="black", size = 0.5),
plot.title = element_text(size = 16, hjust = 0.5))+
#abline(lm(abund ~ as.numeric(Transect_Number), data= abundanceddd))+
#geom_point (colour = "grey") +
# geom_point (aes(colour = GIS_FID)) +
#geom_point(aes(colour = Sampling_Period))+
geom_point()+
#geom_line(aes(group = interaction(Site, Subsite, Date), linetype = Sampling_Period))+
geom_line(aes(group = interaction(GIS_FID, Date, Sampling_Period)))+
#  guide_legend(title.position = "bottom")+
#geom_dl(aes(label = GIS_FID))+
#geom_text(data = subset(comm_mets, Transect_Number == "0"), aes(label = Table_ID), hjust = 1.5, check_overlap = TRUE)+#, x = 4, colour = GIS_FID , y = c(m), hjust = -.02))
#geom_text_repel(data = subset(comm_mets, Transect_Number == "0"), aes(label = Table_ID), nudge_x = 1.5, force = 1)+
geom_text_repel(data = subset(comm_mets, Transect_Number == "0"), aes(label = Table_ID), nudge_x = -0.25, force = 0.01, segment.color = "gray45")+
# geom_smooth (aes(colour = GIS_FID)) +
#geom_errorbar(aes(ymin=abund-se, ymax=abund+se), width=.05, position=position_dodge(0.9))+
scale_y_continuous(name="Fourth Root Transformed Fish Abundance (ind.)", limits=c(0, 35), breaks=seq(0, 35, by=5)) +
#scale_x_continuous(name = "Distance (km)", limits=c(0, 120), breaks=seq(0, 120,by=20)) + geom_smooth(colour = "black", fullrange = FALSE)+
# scale_linetype_discrete(name = "Season", size = 16)+
scale_x_discrete(name = "Distance from Reef", labels = c("0" = "Reef", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))#+
#ggtitle("Fish Abundance by Distance from Reef per Season")
ggplot(newdat, aes(x=Transect_Number, y=pred, group = 1))+
theme_classic()+
geom_point(stat = "identity", position = pd)+
geom_line(stat = "identity", position = pd, colour = "black", size = 1)+
geom_point(data=comm_mets, aes(x=Transect_Number, y=abund), position=pd, alpha = 0.3)+
geom_jitter(data = comm_mets, aes(x = Transect_Number, y=abund), alpha = 0.3) +
geom_errorbar(data=newdat, aes(ymin=pred-SE, ymax=pred+SE, width=0.1), size=1, color = "black", position=pd)+
theme(axis.text=element_text(size=16, colour="black"),
axis.title.x=element_text(size=16, colour="black", vjust=-.5),
axis.title.y=element_text(size=16, colour="black", vjust=1.3),
legend.position="none",
axis.line.x = element_line(color="black", size = 0.5),
axis.line.y = element_line(color="black", size = 0.5),
panel.background = element_blank(),
panel.border = element_rect(colour = "black", fill = NA, size = 1))+
#cale_y_continuous(name="Average Fish Abundance", limits=c(0, 50), breaks=seq(0, 50, by=10)) +
scale_x_discrete(name = "Distance from Reef", labels = c("0" = "Reef", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))+
scale_y_continuous(name = "Fourth Root Transformed Fish Abundance (ind.)")
model.lme <- lme(abund~ Transect_Number, random = ~1|Site/GIS_FID, method = "ML", data = comm_mets)
mod.final <- model.lme
# step 7: examine model fit
#qqPlot(residuals(mod.final))
qqnorm(residuals(mod.final))
qqline(residuals(mod.final))
shapiro.test(residuals(mod.final))
# step 8: gather data to plot
intervals(mod.final) # confidence intervals
intervals(mod.final, which = 'fixed')
plot.lme(mod.final)
library(lattice)
#xyplot( abund ~ Reef_type|Site, fish)
xyplot( abund ~ Transect_Number|GIS_FID, comm_mets)
#had to choose GIS_FID here because could not use Site/GIS_FID
fixef(mod.final) # fixed estimates of intercept and treatment effect
ranef(mod.final) # random effects estimate
coef(mod.final) # estimates of intercept that vary by random effect (the site; aka block)
predict(mod.final) # estimates of population means for fixed and random effects
predict(mod.final, level=0) # estimates of fixed effects prediction of the mean (marginal means)
fitted(mod.final) # estimates of the conditional means
vcov(mod.final) # variance-covariance matrix of parameter estimates; these are effects estimates, not indificual treatment means
# find treatment means
fixef(mod.final)
#fish$dep <- as.factor(fish$dep)
#newdat <- expand.grid(Reef_type = levels(fish$Reef_type), season = levels(fish$season))
#newdat <- expand.grid(Reef_type = levels(fish$Reef_type), dep = levels(fish$dep))
newdat <- expand.grid(Transect_Number = levels (comm_mets$Transect_Number))
newdat$pred <- predict(mod.final, newdat, level=0)
## [-2] drops response from formula
Designmat <- model.matrix(formula(mod.final)[-2], newdat)
predvar <- diag(Designmat %*% vcov(mod.final) %*% t(Designmat))
newdat$SE <- sqrt(predvar)
newdat$SE2 <- sqrt(predvar+mod.final$sigma^2)
# code adapted from http://glmm.wikidot.com/faq
#now plot
library(ggplot2)
pd <- position_dodge(width=0.4)
cmult <- 1  ## could use 1.96 instead
ggplot(newdat, aes(x=Transect_Number, y=pred, group = 1))+
theme_classic()+
geom_point(stat = "identity", position = pd)+
geom_line(stat = "identity", position = pd, colour = "black", size = 1)+
geom_point(data=comm_mets, aes(x=Transect_Number, y=abund), position=pd, alpha = 0.3)+
geom_jitter(data = comm_mets, aes(x = Transect_Number, y=abund), alpha = 0.3) +
geom_errorbar(data=newdat, aes(ymin=pred-SE, ymax=pred+SE, width=0.1), size=1, color = "black", position=pd)+
theme(axis.text=element_text(size=16, colour="black"),
axis.title.x=element_text(size=16, colour="black", vjust=-.5),
axis.title.y=element_text(size=16, colour="black", vjust=1.3),
legend.position="none",
axis.line.x = element_line(color="black", size = 0.5),
axis.line.y = element_line(color="black", size = 0.5),
panel.background = element_blank(),
panel.border = element_rect(colour = "black", fill = NA, size = 1))+
#cale_y_continuous(name="Average Fish Abundance", limits=c(0, 50), breaks=seq(0, 50, by=10)) +
scale_x_discrete(name = "Distance from Reef", labels = c("0" = "Reef", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))+
scale_y_continuous(name = "Fourth Root Transformed Fish Abundance (ind.)")
#scale_y_continuous(name="Fish abundance",
setwd("C:/Users/rclairer/Dropbox (Paxton)/Paxton Team Folder/CRFL - Artificial Reefs/Buffer_Zone/analysis_buffer-zone")
invisible(sapply(list.files(path = "R", pattern = "R$", full.names = TRUE), source)) # find functions and other dependencies in .R files
detach("package:plyr", unload=TRUE)
library(dplyr)
library(lubridate)
library(reshape2)
fish_data <- read.csv ("Fish/4_clean_data/fish_clean_data_output.csv") #without 342 (version of new2, size bins that hayley changed, removing sites not used, removing t1_t2_t3
fish_data_str <- filter(fish_data, Transect_Type == "Structural")
fish_data_str_0 <- filter(fish_data, Transect_Number == "0")
fish_data_rad <- filter(fish_data, Transect_Type == "Radiating")
fish_data <- rbind(fish_data_str_0, fish_data_rad)
#fish_data <- filter(fish_data, Species_Code != "NOFI") ###############USE IF FILTERING TRANSECTS WITH 0 FISH
#fish_data <- filter(fish_data, Transect_Number == "0" | Transect_Number == "3")##############if only 1 and 0
fish_data <- filter(fish_data, ID != "AR-364_PODS_2015-09-21_R_T2")
fish_data <- filter(fish_data, ID != "AR-378_PODS_2015-09-14_R_T1")
fish_data <- filter(fish_data, ID != "AR-364_BARGE_2015-12-10_R_T2")
fish_data <- filter(fish_data, ID != "AR-372_NR2_2015-12-09_R_T5")
fish_data <- filter(fish_data, ID != "AR-372_PODS_2015-12-09_R_T4")
fish_data <- filter(fish_data, ID != "AR-372_RB1_2015-12-09_R_T3")
fish_data <- filter(fish_data, ID != "AR-345_RB1_2015-10-15_R_T2")
fish_data <- filter(fish_data, ID != "AR-345_RB2_2015-10-15_R_T3")
fish_data <- filter(fish_data, ID != "AR-345_TITAN_2015-10-15_R_T3")
fish_meta <- combine_data_meta (data = fish_data,
file_meta = "Metadata/Fish/Fish_Codes_CRFL-AR.csv",
merge_by = "Species_Code")
fish_biom<-make_fish_biomass_col(data = fish_meta)
#fish_subset <- subset_data (data = fish_biom,
#sub_cat = "Pelagic.Demersal", #sub_cat = "Snapper.Grouper",
#sub_val = "Demersal") # YES for yes
## make fish abundance matrix
fish_biom -> data
data$group <- data[,"Species_Code"] # change to family or function_group as needed
#data$group <- data[,"Family"]
#data$group <- data[,"Functional_Group"]
#data$gruop <- data[, "Snapper.Grouper"]
#new2 <- data %>% group_by(group, ID, Site, Subsite, Date, Transect_Type, Sampling_Period, Transect_Number) %>% summarise(data_abund = sum(Abundance))
new2tesssssssst <- data %>% group_by(group, Site, Subsite, Date, Transect_Type, Sampling_Period, Transect_Number) %>% summarise(data_abund = sum(Abundance))
#what happens if we take out ID?
#new3 <- dcast(new2, ID + Site + Subsite + Date + Transect_Type + Sampling_Period + Transect_Number ~ group)
new3tessssst <-  dcast(new2tesssssssst, Site + Subsite + Date + Transect_Type + Sampling_Period + Transect_Number ~ group)
#new2biom <- data %>% group_by(group, ID, Site, Subsite, Date, Transect_Type, Sampling_Period, Transect_Number) %>% summarise(data_biom = sum(biomass))
new2biomtessst <- data %>% group_by(group, Site, Subsite, Date, Transect_Type, Sampling_Period, Transect_Number) %>% summarise(data_biom = sum(biomass))
#new3biom <- dcast(new2biom, ID + Site + Subsite + Date + Transect_Type + Sampling_Period + Transect_Number ~ group)
new3biomtessst <- dcast(new2biomtessst, Site + Subsite + Date + Transect_Type + Sampling_Period + Transect_Number ~ group)
#FOR VISIBILITY
#new2 <- data %>% group_by(group, ID, Site, Subsite, Date, Transect_Type, Sampling_Period, Transect_Number, Visibility_Min_ft) %>% summarise(data_abund = sum(Abundance))
#new3 <- dcast(new2, ID + Site + Subsite + Date + Transect_Type + Sampling_Period + Transect_Number + Visibility_Min_ft ~ group)
#new3[is.na(new3)]<-0
new3tessssst[is.na(new3tessssst)]<-0
#new3biom[is.na(new3biom)] <- 0
new3biomtessst[is.na(new3biomtessst)] <- 0
#fish_abund_matrix <- new3
fish_abund_matrix <- new3tessssst
#fish_biom_matrix <- new3biom
fish_biom_matrix <- new3biomtessst
fish <- fish_abund_matrix # select either abundance or biomass matrix
fishbiom <- fish_biom_matrix
### COMPLEXITY DATA ### -------------------------------------------------------
comp <-read.table("Complexity/3_Clean_Data/comp_site_change.csv", header=T, sep=',')
### TEMPEATURE DATA ### -------------------------------------------------------
temp <-read.table("Temperature/3_Clean_Data/temp_site_change.csv", header=T, sep=',')
### SITES METADATA ### ------------------------------------------------------------
#sites <-read.table("Metadata/Sites/CRFL-AR_SITES_Master_2016-06-30_new.csv", header=T, sep=',')
sites <-read.table("Metadata/Sites/CRFL-AR_SITES_Master_2017-01-23.csv", header=T, sep=',')
### MERGE DATA ### ------------------------------------------------------------
library(plyr)
join1 <- join(fish, temp, by = c("Site", "Subsite", "Date", "Transect_Type","Transect_Number"))
join2 <- join(join1, comp, by = c("Site", "Subsite", "Date", "Transect_Type","Transect_Number"))
join3 <- join(join2, sites, by = c("Site", "Subsite"))
joinbiom1 <- join(fishbiom, temp, by = c("Site", "Subsite", "Date", "Transect_Type","Transect_Number"))
joinbiom2 <- join(joinbiom1, comp, by = c("Site", "Subsite", "Date", "Transect_Type","Transect_Number"))
joinbiom3 <- join(joinbiom2, sites, by = c("Site", "Subsite"))
#join4 <- cbind(join3[,1:7], join3[,81:110], join3[,8:80]) # species
join4 <- cbind(join3[,1:6], join3[,80:110], join3[,7:79]) # species
#join4 <- cbind(join3[,1:6], join3[,79:109], join3[,7:78]) # species NOFI excluded
#join4 <- cbind(join3[,1:7], join3[,80:109], join3[,8:79]) #for exclusion of NOFI
#join4 <- cbind(join3[,1:7], join3[,79:102], join3[,8:78]) #for exclusion of 2 and 3 and no fi
#join4 <- cbind(join3[,1:7], join3[,72:95], join3[,8:71]) # for exclusion of 1 and 2
#joinbiom4 <- cbind(joinbiom3[,1:7], joinbiom3[,81:110], joinbiom3[,8:80])
joinbiom4 <- cbind(joinbiom3[,1:6], joinbiom3[,80:110], joinbiom3[,7:79])
#joinbiom4 <- cbind(joinbiom3[,1:6], joinbiom3[,79:109], joinbiom3[,7:78]) #NOFI excluded
#joinbiom4 <- cbind(joinbiom3[,1:7], joinbiom3[,80:109], joinbiom3[,8:79])#for exclusion of NOFI
#joinbiom4 <- cbind(joinbiom3[,1:7], joinbiom3[,79:102], joinbiom3[,8:80])#for exclusion of 2 and 3
#joinbiom4 <- cbind(join3[,1:7], join3[,72:95], join3[,8:71]) # for exclusion of 1 and 2
#join4 <- cbind(join3[,1:7], join3[,36:ncol(join3)], join3[,8:35]) # family
#join4 <- cbind(join3[,1:7], join3[,16:ncol(join3)], join3[8:15]) #Functional group
#join5 <- join4[,-c(8, 12)]
join5 <- join4[,-c(11)]
#joinbiom5 <- joinbiom4[,-c(8, 12)]
joinbiom5 <- joinbiom4[,-c(11)]
data <- join5
databiom <- joinbiom5
write.csv(data, file = "Metadata/data_for_Steve.csv", row.names = FALSE)
write.csv(databiom, file = "Metadata/databiom_for_Steve.csv", row.names = FALSE)
env.end<- 36
sp.start<-37
env_data <- data[,1:env.end]
species.data<-data[,sp.start:ncol(data)] # fish data
species.orig<-species.data # fish data, no transform
species.data.biom <- databiom[,sp.start:ncol(databiom)]
species.orig.biom <- species.data.biom
#species.data <- transform_data (data = species.data, transform_type = "square_root")
#species.data.biom <- transform_data (data = species.data.biom, transform_type = "square_root")
#species.data <- transform_data (data = species.orig, transform_type = "cube_root")
#species.data <- transform_data (data = species.data, transform_type = "pres_abs")
#species.data <- transform_data (data = species.orig, transform_type = "box-cox")
#species.data.biom <- transform_data (data = species.data.biom,
species.data <- transform_data (data = species.orig, transform_type = "fourth_root")
species.data.biom <- transform_data (data = species.orig.biom, transform_type = "fourth_root")
#species.data <- transform_data (data = species.orig, transform_type
library(vegan)
S <- specnumber(species.data) # species richness (S)
shan <- diversity (species.data, index = "shannon") # shannon diversity
simp <- diversity (species.data, index = "simpson") # simpson's diversity
simp_inv <- diversity (species.data, index = "invsimpson") # inverse simpson's diversity
J <- shan / log (S) # pielou's evenness (J)
abund <- rowSums (species.data, na.rm = FALSE, dims = 1) # total abundance for each sample
biom <- rowSums (species.data.biom, na.rm = FALSE, dims = 1) # totaal biomass for each sample
comm_mets <- cbind (abund, biom, S, shan, simp, simp_inv, J, env_data)
#write.csv(comm_mets, file = "Metadata/comm_mets_trans_for_Steve.csv", row.names = FALSE)
abundpertran <- summarySE(comm_mets, measurevar = "abund", groupvars = c("Transect_Number"))
plot.all.tran = ggplot(abundpertran, aes(x=as.factor(Transect_Number), y=as.numeric(abund), group = 1))
plot.all.tran +
theme_classic()+
theme(axis.text=element_text(size=16, colour="black"),
axis.title.x=element_text(size=16, colour="black", vjust=-.5),
axis.title.y=element_text(size=16, colour="black", vjust=1.3),
legend.position="none",
axis.line.x = element_line(color="black", size = 0.5),
axis.line.y = element_line(color="black", size = 0.5),
plot.title = element_text(size = 16, hjust = 0.5))+
geom_point (colour = "grey") +
geom_line() +
geom_errorbar(aes(ymin=abund-se, ymax=abund+se), width=.05, position=position_dodge(0.9))+
scale_y_continuous(name="Average Fish Abundance", limits=c(0, 15), breaks=seq(0, 15, by=5)) +
#scale_x_continuous(name = "Distance (km)", limits=c(0, 120), breaks=seq(0, 120,by=20)) + geom_smooth(colour = "black", fullrange = FALSE)+
scale_x_discrete(name = "Distance from Reef", labels = c("0" = "Reef", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))
plot.all.tran +
theme_classic()+
theme(axis.text=element_text(size=16, colour="black"),
axis.title.x=element_text(size=16, colour="black", vjust=-.5),
axis.title.y=element_text(size=16, colour="black", vjust=1.3),
legend.position="none",
axis.line.x = element_line(color="black", size = 0.5),
axis.line.y = element_line(color="black", size = 0.5),
plot.title = element_text(size = 16, hjust = 0.5))+
geom_point (colour = "grey") +
geom_line() +
geom_errorbar(aes(ymin=abund-se, ymax=abund+se), width=.05, position=position_dodge(0.9))+
scale_y_continuous(name="Average Fish Abundance (Forth Root Transformed)", limits=c(0, 15), breaks=seq(0, 15, by=5)) +
#scale_x_continuous(name = "Distance (km)", limits=c(0, 120), breaks=seq(0, 120,by=20)) + geom_smooth(colour = "black", fullrange = FALSE)+
scale_x_discrete(name = "Distance from Reef", labels = c("0" = "Reef", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))
plot.all.tran +
theme_classic()+
theme(axis.text=element_text(size=16, colour="black"),
axis.title.x=element_text(size=16, colour="black", vjust=-.5),
axis.title.y=element_text(size=16, colour="black", vjust=1.3),
legend.position="none",
axis.line.x = element_line(color="black", size = 0.5),
axis.line.y = element_line(color="black", size = 0.5),
plot.title = element_text(size = 16, hjust = 0.5))+
geom_point (colour = "grey") +
geom_line() +
geom_errorbar(aes(ymin=abund-se, ymax=abund+se), width=.05, position=position_dodge(0.9))+
scale_y_continuous(name="Average Fish Abundance (ind.) (Forth Root Transformed)", limits=c(0, 15), breaks=seq(0, 15, by=5)) +
#scale_x_continuous(name = "Distance (km)", limits=c(0, 120), breaks=seq(0, 120,by=20)) + geom_smooth(colour = "black", fullrange = FALSE)+
scale_x_discrete(name = "Distance from Reef", labels = c("0" = "Reef", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))
library(agricolae)
library(nlme)
comm_mets$Transect_Number <- as.factor(comm_mets$Transect_Number)
comm_mets$Site <- as.factor(comm_mets$Site)
comm_mets$Sampling_Period <- as.factor(comm_mets$Sampling_Period)
comm_mets$Reef_Type <- as.factor(comm_mets$Reef_Type)
comm_mets$Structure_Type <- as.factor(comm_mets$Structure_Type)
comm_mets$GIS_FID <- as.factor(comm_mets$GIS_FID)
model.lme <- lme(abund~ Transect_Number, random = ~1|Site/GIS_FID, method = "ML", data = comm_mets)
mod.final <- model.lme
# step 7: examine model fit
#qqPlot(residuals(mod.final))
qqnorm(residuals(mod.final))
qqline(residuals(mod.final))
shapiro.test(residuals(mod.final))
# step 8: gather data to plot
intervals(mod.final) # confidence intervals
intervals(mod.final, which = 'fixed')
plot.lme(mod.final)
library(lattice)
#xyplot( abund ~ Reef_type|Site, fish)
xyplot( abund ~ Transect_Number|GIS_FID, comm_mets)
#had to choose GIS_FID here because could not use Site/GIS_FID
fixef(mod.final) # fixed estimates of intercept and treatment effect
ranef(mod.final) # random effects estimate
coef(mod.final) # estimates of intercept that vary by random effect (the site; aka block)
predict(mod.final) # estimates of population means for fixed and random effects
predict(mod.final, level=0) # estimates of fixed effects prediction of the mean (marginal means)
fitted(mod.final) # estimates of the conditional means
vcov(mod.final) # variance-covariance matrix of parameter estimates; these are effects estimates, not indificual treatment means
# find treatment means
fixef(mod.final)
#fish$dep <- as.factor(fish$dep)
#newdat <- expand.grid(Reef_type = levels(fish$Reef_type), season = levels(fish$season))
#newdat <- expand.grid(Reef_type = levels(fish$Reef_type), dep = levels(fish$dep))
newdat <- expand.grid(Transect_Number = levels (comm_mets$Transect_Number))
newdat$pred <- predict(mod.final, newdat, level=0)
## [-2] drops response from formula
Designmat <- model.matrix(formula(mod.final)[-2], newdat)
predvar <- diag(Designmat %*% vcov(mod.final) %*% t(Designmat))
newdat$SE <- sqrt(predvar)
newdat$SE2 <- sqrt(predvar+mod.final$sigma^2)
# code adapted from http://glmm.wikidot.com/faq
#now plot
library(ggplot2)
pd <- position_dodge(width=0.4)
cmult <- 1  ## could use 1.96 instead
ggplot(newdat, aes(x=Transect_Number, y=pred, group = 1))+
theme_classic()+
geom_point(stat = "identity", position = pd)+
geom_line(stat = "identity", position = pd, colour = "black", size = 1)+
geom_point(data=comm_mets, aes(x=Transect_Number, y=abund), position=pd, alpha = 0.3)+
geom_jitter(data = comm_mets, aes(x = Transect_Number, y=abund), alpha = 0.3) +
geom_errorbar(data=newdat, aes(ymin=pred-SE, ymax=pred+SE, width=0.1), size=1, color = "black", position=pd)+
theme(axis.text=element_text(size=16, colour="black"),
axis.title.x=element_text(size=16, colour="black", vjust=-.5),
axis.title.y=element_text(size=16, colour="black", vjust=1.3),
legend.position="none",
axis.line.x = element_line(color="black", size = 0.5),
axis.line.y = element_line(color="black", size = 0.5),
panel.background = element_blank(),
panel.border = element_rect(colour = "black", fill = NA, size = 1))+
#cale_y_continuous(name="Average Fish Abundance", limits=c(0, 50), breaks=seq(0, 50, by=10)) +
scale_x_discrete(name = "Distance from Reef", labels = c("0" = "Reef", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))+
scale_y_continuous(name = "Fourth Root Transformed Fish Abundance (ind.)")
species.data<-data[,sp.start:ncol(data)] # fish data
species.orig<-species.data # fish data, no transform
species.data.biom <- databiom[,sp.start:ncol(databiom)]
species.orig.biom <- species.data.biom
