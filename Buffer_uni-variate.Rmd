---
title: "Buffer_uni-variate"
author: "Claire_Rosemond"
date: "March 6, 2017"
output: html_document
---

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r working_dir}

setwd("C:/Users/rclairer/Dropbox (Paxton)/Paxton Team Folder/CRFL - Artificial Reefs/Buffer_Zone/analysis_buffer-zone")

```

```{r setup}

invisible(sapply(list.files(path = "R", pattern = "R$", full.names = TRUE), source)) # find functions and other dependencies in .R files

```

```{r get_data}

### FISH DATA ### --------------------------------------------------------------
detach("package:plyr", unload=TRUE)
library(dplyr)
library(lubridate)
library(reshape2)

fish_data <- read.csv ("Fish/4_clean_data/fish_clean_data_output.csv") #without 342 (version of new2, size bins that hayley changed, removing sites not used, removing t1_t2_t3

fish_data_str <- filter(fish_data, Transect_Type == "Structural")
fish_data_str_0 <- filter(fish_data, Transect_Number == "0")
fish_data_rad <- filter(fish_data, Transect_Type == "Radiating")

fish_data <- rbind(fish_data_str_0, fish_data_rad)
#fish_data <- filter(fish_data, Species_Code != "NOFI") ###############USE IF FILTERING TRANSECTS WITH 0 FISH
#fish_data <- filter(fish_data, Transect_Number == "0" | Transect_Number == "3")##############if only 1 and 0

fish_data <- filter(fish_data, ID != "AR-364_PODS_2015-09-21_R_T2")
fish_data <- filter(fish_data, ID != "AR-378_PODS_2015-09-14_R_T1")
fish_data <- filter(fish_data, ID != "AR-364_BARGE_2015-12-10_R_T2")
fish_data <- filter(fish_data, ID != "AR-372_NR2_2015-12-09_R_T5")
fish_data <- filter(fish_data, ID != "AR-372_PODS_2015-12-09_R_T4")
fish_data <- filter(fish_data, ID != "AR-372_RB1_2015-12-09_R_T3")
fish_data <- filter(fish_data, ID != "AR-345_RB1_2015-10-15_R_T2")
fish_data <- filter(fish_data, ID != "AR-345_RB2_2015-10-15_R_T3")
fish_data <- filter(fish_data, ID != "AR-345_TITAN_2015-10-15_R_T3")


fish_meta <- combine_data_meta (data = fish_data, 
                                file_meta = "Metadata/Fish/Fish_Codes_CRFL-AR.csv", 
                                merge_by = "Species_Code") 

fish_biom<-make_fish_biomass_col(data = fish_meta)
#fish_subset <- subset_data (data = fish_biom,
                          #sub_cat = "Pelagic.Demersal", #sub_cat = "Snapper.Grouper",
                          #sub_val = "Demersal") # YES for yes

## make fish abundance matrix
fish_biom -> data

data$group <- data[,"Species_Code"] # change to family or function_group as needed
#data$group <- data[,"Family"]
#data$group <- data[,"Functional_Group"]
#data$gruop <- data[, "Snapper.Grouper"]

#new2 <- data %>% group_by(group, ID, Site, Subsite, Date, Transect_Type, Sampling_Period, Transect_Number) %>% summarise(data_abund = sum(Abundance))
new2tesssssssst <- data %>% group_by(group, Site, Subsite, Date, Transect_Type, Sampling_Period, Transect_Number) %>% summarise(data_abund = sum(Abundance))


#what happens if we take out ID?
#new3 <- dcast(new2, ID + Site + Subsite + Date + Transect_Type + Sampling_Period + Transect_Number ~ group)

new3tessssst <-  dcast(new2tesssssssst, Site + Subsite + Date + Transect_Type + Sampling_Period + Transect_Number ~ group)


#new2biom <- data %>% group_by(group, ID, Site, Subsite, Date, Transect_Type, Sampling_Period, Transect_Number) %>% summarise(data_biom = sum(biomass))

new2biomtessst <- data %>% group_by(group, Site, Subsite, Date, Transect_Type, Sampling_Period, Transect_Number) %>% summarise(data_biom = sum(biomass))

#new3biom <- dcast(new2biom, ID + Site + Subsite + Date + Transect_Type + Sampling_Period + Transect_Number ~ group)

new3biomtessst <- dcast(new2biomtessst, Site + Subsite + Date + Transect_Type + Sampling_Period + Transect_Number ~ group)

#FOR VISIBILITY
#new2 <- data %>% group_by(group, ID, Site, Subsite, Date, Transect_Type, Sampling_Period, Transect_Number, Visibility_Min_ft) %>% summarise(data_abund = sum(Abundance))
#new3 <- dcast(new2, ID + Site + Subsite + Date + Transect_Type + Sampling_Period + Transect_Number + Visibility_Min_ft ~ group) 
 

#new3[is.na(new3)]<-0

new3tessssst[is.na(new3tessssst)]<-0

#new3biom[is.na(new3biom)] <- 0
new3biomtessst[is.na(new3biomtessst)] <- 0


#fish_abund_matrix <- new3
fish_abund_matrix <- new3tessssst

#fish_biom_matrix <- new3biom
fish_biom_matrix <- new3biomtessst



fish <- fish_abund_matrix # select either abundance or biomass matrix
fishbiom <- fish_biom_matrix


### COMPLEXITY DATA ### -------------------------------------------------------
comp <-read.table("Complexity/3_Clean_Data/comp_site_change.csv", header=T, sep=',')


### TEMPEATURE DATA ### -------------------------------------------------------
temp <-read.table("Temperature/3_Clean_Data/temp_site_change.csv", header=T, sep=',')


### SITES METADATA ### ------------------------------------------------------------
#sites <-read.table("Metadata/Sites/CRFL-AR_SITES_Master_2016-06-30_new.csv", header=T, sep=',')

sites <-read.table("Metadata/Sites/CRFL-AR_SITES_Master_2017-01-23.csv", header=T, sep=',')

### MERGE DATA ### ------------------------------------------------------------

library(plyr)

join1 <- join(fish, temp, by = c("Site", "Subsite", "Date", "Transect_Type","Transect_Number"))
join2 <- join(join1, comp, by = c("Site", "Subsite", "Date", "Transect_Type","Transect_Number"))
join3 <- join(join2, sites, by = c("Site", "Subsite")) 

joinbiom1 <- join(fishbiom, temp, by = c("Site", "Subsite", "Date", "Transect_Type","Transect_Number"))
joinbiom2 <- join(joinbiom1, comp, by = c("Site", "Subsite", "Date", "Transect_Type","Transect_Number"))
joinbiom3 <- join(joinbiom2, sites, by = c("Site", "Subsite")) 

#join4 <- cbind(join3[,1:7], join3[,81:110], join3[,8:80]) # species
join4 <- cbind(join3[,1:6], join3[,80:110], join3[,7:79]) # species
#join4 <- cbind(join3[,1:6], join3[,79:109], join3[,7:78]) # species NOFI excluded

#join4 <- cbind(join3[,1:7], join3[,80:109], join3[,8:79]) #for exclusion of NOFI
#join4 <- cbind(join3[,1:7], join3[,79:102], join3[,8:78]) #for exclusion of 2 and 3 and no fi
#join4 <- cbind(join3[,1:7], join3[,72:95], join3[,8:71]) # for exclusion of 1 and 2
#joinbiom4 <- cbind(joinbiom3[,1:7], joinbiom3[,81:110], joinbiom3[,8:80])
joinbiom4 <- cbind(joinbiom3[,1:6], joinbiom3[,80:110], joinbiom3[,7:79])
#joinbiom4 <- cbind(joinbiom3[,1:6], joinbiom3[,79:109], joinbiom3[,7:78]) #NOFI excluded

#joinbiom4 <- cbind(joinbiom3[,1:7], joinbiom3[,80:109], joinbiom3[,8:79])#for exclusion of NOFI
#joinbiom4 <- cbind(joinbiom3[,1:7], joinbiom3[,79:102], joinbiom3[,8:80])#for exclusion of 2 and 3
#joinbiom4 <- cbind(join3[,1:7], join3[,72:95], join3[,8:71]) # for exclusion of 1 and 2


#join4 <- cbind(join3[,1:7], join3[,36:ncol(join3)], join3[,8:35]) # family
#join4 <- cbind(join3[,1:7], join3[,16:ncol(join3)], join3[8:15]) #Functional group

#join5 <- join4[,-c(8, 12)]
join5 <- join4[,-c(11)]

#joinbiom5 <- joinbiom4[,-c(8, 12)]
joinbiom5 <- joinbiom4[,-c(11)]

data <- join5
databiom <- joinbiom5
write.csv(data, file = "Metadata/data_for_Steve.csv", row.names = FALSE)
write.csv(databiom, file = "Metadata/databiom_for_Steve.csv", row.names = FALSE)

env.end<- 36
sp.start<-37

env_data <- data[,1:env.end]
 
species.data<-data[,sp.start:ncol(data)] # fish data
species.orig<-species.data # fish data, no transform

species.data.biom <- databiom[,sp.start:ncol(databiom)]
species.orig.biom <- species.data.biom
#species.data <- transform_data (data = species.data, transform_type = "square_root")
#species.data.biom <- transform_data (data = species.data.biom, transform_type = "square_root")
#species.data <- transform_data (data = species.orig, transform_type = "cube_root")
#species.data <- transform_data (data = species.data, transform_type = "pres_abs")
#species.data <- transform_data (data = species.orig, transform_type = "box-cox")
#species.data.biom <- transform_data (data = species.data.biom, transform_type = "box-cox")


#write.csv(species.data, file = "Metadata/species.csv", row.names = FALSE)
#write.csv(data, file = "Metadata/data.csv", row.names = FALSE)

```


#Tallys for Results section

```{r tallys}
library(dplyr)
#total number of fish
totalfish <- sum(fish_meta$Abundance)
totalfish

#total species
totalspecies <- count(unique(fish_meta$Species_Code))
totalspecies

#total families
totalfamily <- count(unique(fish_meta$Family))
totalfamily

#total transects
totaltransects <- count(unique(fish_meta$ID))
totaltransects

#total biomass
fish_biom2 <- filter(fish_biom, biomass != "NA")
totalbiomass <- sum(fish_biom2$biomass)
totalbiomass


#testingingin <- fish_meta %>% group_by(Species_Code) %>% summarise(testingggggg = cumsum(Abundance))


#count(fish_meta, Species_Code)

#number snapper-grouper
snap <- filter(fish_meta, Snapper.Grouper =="YES")
notsnap <- filter(fish_meta, Snapper.Grouper != "YES")

snapabund <- sum(snap$Abundance)
snapabund

notsnapabund <- sum(notsnap$Abundance)
notsnapabund

#trophic levels
bencar <- filter(fish_meta, Functional_Group == "Benthic Carnivore")
sumbencar <- sum(bencar$Abundance)
sumbencar

carni <- filter(fish_meta, Functional_Group == "Carnivore")
sumcarni <- sum(carni$Abundance)
sumcarni

herbi <- filter(fish_meta, Functional_Group == "Herbivore")
sumherbi <- sum(herbi$Abundance)
sumherbi

inverti <- filter(fish_meta, Functional_Group == "Invertivore")
suminverti <- sum(inverti$Abundance)
suminverti

omniv <- filter(fish_meta, Functional_Group == "Omnivore")
sumomniv <- sum(omniv$Abundance)
sumomniv

pisc <- filter(fish_meta, Functional_Group == "Piscivore")
sumpisc <- sum(pisc$Abundance)
sumpisc

plank <- filter(fish_meta, Functional_Group == "Planktivore")
sumplank <- sum(plank$Abundance)
sumplank

unkgroup <- filter(fish_meta, Functional_Group == "Unknown")
sumunk <- sum(unkgroup$Abundance)
sumunk

#pel.dem
pel <- filter(fish_meta, Pelagic.Demersal =="Pelagic")
sumpel <- sum(pel$Abundance)
sumpel

dem <- filter(fish_meta, Pelagic.Demersal =="Demersal" | Pelagic.Demersal == "Demersal ")
sumdem <- sum(dem$Abundance)
sumdem

#most frequently counted
library(plyr)
countfish <- count(fish_meta$Species_Code)
maxfish <- max(countfish$freq)
maxfish

detach("package:plyr", unload=TRUE)
library(dplyr)

mostabund <- fish_meta %>% group_by(Species_Code) %>% summarise(n=sum(Abundance))
mostabund2 <- fish_meta$Species_Code %>% summarise(n= sum(Abundance))

mostabund3 <- summarise(group_by(fish_meta, Species_Code), n = sum(Abundance))

mostabund4 <- species.data %>% summarise_each(funs(sum))#holy, it worked!
```


#UNIVARIATE ANALYSIS

```{r univariate_transform}

#species.data <- transform_data (data = species.orig, transform_type = "square_root")
#species.data.biom <- transform_data (data = species.orig.biom, transform_type = "square_root")
#species.data <- transform_data (data = species.orig, transform_type = "cube_root")
#species.data.biom <- transform_data (data = species.orig.biom, transform_type = "cube_root")
species.data <- transform_data (data = species.orig, transform_type = "fourth_root")
species.data.biom <- transform_data (data = species.orig.biom, transform_type = "fourth_root")
#species.data <- transform_data (data = species.orig, transform_type = "log")
#species.data.biom <- transform_data (data = species.orig.biom, transform_type = "log")
#species.data <- transform_data (data = species.orig, transform_type = "pres_abs")
#species.data.biom <- transform_data (data = species.orig.biom, transform_type = "pres_abs")
#species.data <- transform_data (data = species.orig, transform_type = "box-cox")
#species.data.biom <- transform_data (data = species.orig.biom, transform_type = "box-cox")
#species.data <- transform_data (data = species.orig, transform_type = "log +1")
#species.data.biom <- transform_data (data = species.orig.biom, transform_type = "log +1")




```

```{r comm_metrics}

library(vegan)

  S <- specnumber(species.data) # species richness (S)
  shan <- diversity (species.data, index = "shannon") # shannon diversity
  simp <- diversity (species.data, index = "simpson") # simpson's diversity
  simp_inv <- diversity (species.data, index = "invsimpson") # inverse simpson's diversity
  J <- shan / log (S) # pielou's evenness (J)
  abund <- rowSums (species.data, na.rm = FALSE, dims = 1) # total abundance for each sample
  biom <- rowSums (species.data.biom, na.rm = FALSE, dims = 1) # totaal biomass for each sample
  comm_mets <- cbind (abund, biom, S, shan, simp, simp_inv, J, env_data) 
  
#write.csv(comm_mets, file = "Metadata/comm_mets_trans_for_Steve.csv", row.names = FALSE)

  

```

```{r exponential}
  

abundpertran <- summarySE(comm_mets, measurevar = "abund", groupvars = c("Transect_Number"))

  
abundpertran$Transect_Number <- as.numeric(abundpertran$Transect_Number) 
abundpertran$abund <- as.numeric(abundpertran$abund)


#abundance is transformed  
#expon.model <- lm(abund ~ Transect_Number, data = abundpertran)  
#summary(expon.model)
#plot(abundpertran$Transect_Number, abundpertran$abund)
#lines(abundpertran$Transect_Number, predict.model)
#testing111 <- nls(abund ~ Transect_Number, data = abundpertran)

#predict.model <- predict(expon.model, data = list(abundpertran$Transect_Number))

#summary(predict.model)


x <- c(0,1,2,3)
y <- abundpertran$abund

#m<-nls(y~a*x/(b+x), start = list(a= 13, b=1))
m <- nls(y~a*exp(-b*x), start = list(a= 13, b =1))

cor(y, predict(m))

plot(abundpertran$Transect_Number, abundpertran$abund)
lines(x,predict(m),col="red",lty=2,lwd=3)



```

```{r initial_plots}
  library(ggplot2)
  
#iabundance <- summarySE(comm_mets, measurevar = "abund", groupvars = c("GIS_FID","Transect_Number","Sampling_Period"))
trythis <- summarySE(comm_mets, measurevar = "abund", groupvars = c("GIS_FID", "Date", "Transect_Number"))

plot.trythis = ggplot(trythis, aes(x = as.factor(Transect_Number), y = as.numeric(abund)))
#plot.iabundance.ggplot = ggplot(iabundance, aes(x=as.factor(Transect_Number), y=as.numeric(abund)))
#plot.iabundance.ggplot = ggplot(comm_mets, aes(x=as.factor(Transect_Number), y=as.numeric(abund))) #this graph plots the average- after fourth root transform- abundnace per site, with geom_line connecting the points
  plot.trythis +
#plot.iabundance.ggplot + 
  theme_classic()+
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="none", 
        axis.line.x = element_line(color="black", size = 0.5), 
        axis.line.y = element_line(color="black", size = 0.5))+
  #abline(lm(abund ~ as.numeric(Transect_Number), data= abundanceddd))+
#geom_point (colour = "grey") + 
 # geom_point (aes(colour = GIS_FID)) + 
  #geom_point(aes(colour = Sampling_Period))+
  geom_point()+
  #geom_line(aes(group = interaction(Site, Subsite, Date), linetype = Sampling_Period))+
    geom_line(aes(group = interaction(GIS_FID, Date)))+
    # geom_smooth (aes(colour = GIS_FID)) + 
#geom_errorbar(aes(ymin=abund-se, ymax=abund+se), width=.05, position=position_dodge(0.9))+
  scale_y_continuous(name="Fish Abundance", limits=c(0, 35), breaks=seq(0, 35, by=5)) +
  #scale_x_continuous(name = "Distance (km)", limits=c(0, 120), breaks=seq(0, 120,by=20)) + geom_smooth(colour = "black", fullrange = FALSE)+
  scale_x_discrete(name = "Distance from Reef", labels = c("0" = "Reef", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))+
  ggtitle("Fish Abundance by Distance from Reef")

  #facet graph for abundances
  comm_mets$Sampling_Period <- factor(comm_mets$Sampling_Period, c("Fall", "Winter", "Spring"))
plot.taketwo = ggplot(comm_mets, aes(x = as.factor(Transect_Number), y = as.numeric(abund)))
library(ggrepel)
  
  plot.taketwo+
  theme_classic()+
  #facet_wrap(~Sampling_Period, ncol=3)+
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="bottom", 
        axis.line.x = element_line(color="black", size = 0.5), 
        axis.line.y = element_line(color="black", size = 0.5),
        plot.title = element_text(size = 16, hjust = 0.5))+
  #abline(lm(abund ~ as.numeric(Transect_Number), data= abundanceddd))+
#geom_point (colour = "grey") + 
 # geom_point (aes(colour = GIS_FID)) + 
  #geom_point(aes(colour = Sampling_Period))+
  geom_point()+
  #geom_line(aes(group = interaction(Site, Subsite, Date), linetype = Sampling_Period))+
    geom_line(aes(group = interaction(GIS_FID, Date, Sampling_Period), linetype = Sampling_Period))+
      #  guide_legend(title.position = "bottom")+
    #geom_dl(aes(label = GIS_FID))+
    #geom_text(data = subset(comm_mets, Transect_Number == "0"), aes(label = Table_ID), hjust = 1.5, check_overlap = TRUE)+#, x = 4, colour = GIS_FID , y = c(m), hjust = -.02))
   #geom_text_repel(data = subset(comm_mets, Transect_Number == "0"), aes(label = Table_ID), nudge_x = 1.5, force = 1)+
    geom_text_repel(data = subset(comm_mets, Transect_Number == "0"), aes(label = Table_ID), nudge_x = -0.25, force = 0.01, segment.color = "gray45")+
     # geom_smooth (aes(colour = GIS_FID)) + 
#geom_errorbar(aes(ymin=abund-se, ymax=abund+se), width=.05, position=position_dodge(0.9))+
  scale_y_continuous(name="Fish Abundance", limits=c(0, 35), breaks=seq(0, 35, by=5)) +
  #scale_x_continuous(name = "Distance (km)", limits=c(0, 120), breaks=seq(0, 120,by=20)) + geom_smooth(colour = "black", fullrange = FALSE)+
    scale_linetype_discrete(name = "Season", size = 16)+
  scale_x_discrete(name = "Distance from Reef", labels = c("0" = "Reef", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))+
ggtitle("Fish Abundance by Distance from Reef")

########################################################################
  plot.taketwo+
  theme_classic()+
  facet_wrap(~Sampling_Period, ncol=3)+
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="none", 
        axis.line.x = element_line(color="black", size = 0.5), 
        axis.line.y = element_line(color="black", size = 0.5),
        plot.title = element_text(size = 16, hjust = 0.5))+
  #abline(lm(abund ~ as.numeric(Transect_Number), data= abundanceddd))+
#geom_point (colour = "grey") + 
 # geom_point (aes(colour = GIS_FID)) + 
  #geom_point(aes(colour = Sampling_Period))+
  geom_point()+
  #geom_line(aes(group = interaction(Site, Subsite, Date), linetype = Sampling_Period))+
    geom_line(aes(group = interaction(GIS_FID, Date, Sampling_Period)))+
      #  guide_legend(title.position = "bottom")+
    #geom_dl(aes(label = GIS_FID))+
    #geom_text(data = subset(comm_mets, Transect_Number == "0"), aes(label = Table_ID), hjust = 1.5, check_overlap = TRUE)+#, x = 4, colour = GIS_FID , y = c(m), hjust = -.02))
   #geom_text_repel(data = subset(comm_mets, Transect_Number == "0"), aes(label = Table_ID), nudge_x = 1.5, force = 1)+
    geom_text_repel(data = subset(comm_mets, Transect_Number == "0"), aes(label = Table_ID), nudge_x = -0.25, force = 0.01, segment.color = "gray45")+
     # geom_smooth (aes(colour = GIS_FID)) + 
#geom_errorbar(aes(ymin=abund-se, ymax=abund+se), width=.05, position=position_dodge(0.9))+
  scale_y_continuous(name="Fourth Root Transformed Fish Abundance (ind.)", limits=c(0, 35), breaks=seq(0, 35, by=5)) +
  #scale_x_continuous(name = "Distance (km)", limits=c(0, 120), breaks=seq(0, 120,by=20)) + geom_smooth(colour = "black", fullrange = FALSE)+
   # scale_linetype_discrete(name = "Season", size = 16)+
  scale_x_discrete(name = "Distance from Reef", labels = c("0" = "Reef", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))#+
#ggtitle("Fish Abundance by Distance from Reef per Season")

  #############################################################
  
  
  
interesting_test <- filter(comm_mets, Transect_Number == 0)  
interesting =  ggplot(interesting_test, aes(x = as.numeric(Distance_to_HB), y = as.numeric(abund))) 


interesting +
  theme_classic()+
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="none", 
        axis.line.x = element_line(color="black", size = 0.5), 
        axis.line.y = element_line(color="black", size = 0.5))+
  #abline(lm(abund ~ as.numeric(Transect_Number), data= abundanceddd))+
#geom_point (colour = "grey") + 
 # geom_point (aes(colour = GIS_FID)) + 
  #geom_point(aes(colour = Sampling_Period))+
  geom_point()+
  #geom_line(aes(group = interaction(Site, Subsite, Date), linetype = Sampling_Period))+
    #geom_line(aes(group = interaction(GIS_FID, Date)))+
    # geom_smooth (aes(colour = GIS_FID)) + 
#geom_errorbar(aes(ymin=abund-se, ymax=abund+se), width=.05, position=position_dodge(0.9))+
  scale_y_continuous(name="Fish Abundance", limits=c(0, 35), breaks=seq(0, 35, by=5)) +
  scale_x_continuous(name = "Distance (ft?)", limits=c(0, 2500), breaks=seq(0, 2500,by=500)) + #geom_smooth(colour = "black", fullrange = FALSE)+
 # scale_x_discrete(name = "Distance from Reef", labels = c("0" = "Reef", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))+
ggtitle("On-Reef Fish Abundance by Distance to Nearest Neighbor Reef")

  
  
  
abunddddd <- summarySE(comm_mets, measurevar = "abund", groupvars = c("GIS_FID","Transect_Number"))

fid_0 <- filter(abunddddd, GIS_FID =='0')
fid_1 <- filter(abunddddd, GIS_FID =='1')
fid_2 <- filter(abunddddd, GIS_FID =='2')
fid_3 <- filter(abunddddd, GIS_FID =='3')

ggplot() +
  
stat_smooth(data = fid_0, aes(x=Transect_Number, y=abund), color = "red", span = 2, se = FALSE)+
stat_smooth(data = fid_1, aes(x=Transect_Number, y=abund), color = "magenta", span = 2, se = FALSE)+
stat_smooth(data = fid_2, aes(x=Transect_Number, y=abund), color = "blue", span = 2, se = FALSE)+
stat_smooth(data = fid_3, aes(x=Transect_Number, y=abund), color = "green", span = 2, se = FALSE)




abundanceddd <- filter(abunddddd, se != 'NA') #use this to remove ones that were only sampled once

#OR remove outlier

abund1 <- filter(abunddddd, Transect_Number == '2')
abund1.5 <- filter(abund1, abund < 12)
abund2 <- filter(abunddddd, Transect_Number != '2')
abundanceagain <-rbind(abund1.5, abund2)


plot.all.ggplot = ggplot(abunddddd, aes(x=as.factor(Transect_Number), y=as.numeric(abund))) #this graph plots the average- after fourth root transform- abundnace per site, with geom_line connecting the points
  
plot.all.ggplot + 
  theme_classic()+
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="none", 
        axis.line.x = element_line(color="black", size = 0.5), 
        axis.line.y = element_line(color="black", size = 0.5))+
  #abline(lm(abund ~ as.numeric(Transect_Number), data= abundanceddd))+
#geom_point (colour = "grey") + 
 # geom_point (aes(colour = GIS_FID)) + 
  geom_point()+
  geom_line(aes(group = GIS_FID))+
  # geom_smooth (aes(colour = GIS_FID)) + 
#geom_errorbar(aes(ymin=abund-se, ymax=abund+se), width=.05, position=position_dodge(0.9))+
  scale_y_continuous(name="Average Fish Abundance", limits=c(0, 25), breaks=seq(0, 25, by=5)) +
  #scale_x_continuous(name = "Distance (km)", limits=c(0, 120), breaks=seq(0, 120,by=20)) + geom_smooth(colour = "black", fullrange = FALSE)+
  scale_x_discrete(name = "Distance from Reef", labels = c("0" = "Reef", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))+
  ggtitle("Average Fish Abundance per Site by Distance from Reef")


#this graph plots the average abundance per transect with error bars and geom line connecting the points
abundpertran <- summarySE(comm_mets, measurevar = "abund", groupvars = c("Transect_Number"))

plot.all.tran = ggplot(abundpertran, aes(x=as.factor(Transect_Number), y=as.numeric(abund), group = 1))
  
plot.all.tran + 
  theme_classic()+
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="none", 
        axis.line.x = element_line(color="black", size = 0.5), 
        axis.line.y = element_line(color="black", size = 0.5),
        plot.title = element_text(size = 16, hjust = 0.5))+
geom_point (colour = "grey") + 
geom_line() +
geom_errorbar(aes(ymin=abund-se, ymax=abund+se), width=.05, position=position_dodge(0.9))+
  scale_y_continuous(name="Average Fish Abundance (ind.) (Forth Root Transformed)", limits=c(0, 15), breaks=seq(0, 15, by=5)) +
  #scale_x_continuous(name = "Distance (km)", limits=c(0, 120), breaks=seq(0, 120,by=20)) + geom_smooth(colour = "black", fullrange = FALSE)+
  scale_x_discrete(name = "Distance from Reef", labels = c("0" = "Reef", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))+
  ggtitle("Average Fish Abundance by Distance from Reef")
####################################################################################
 

biommmm <- summarySE(comm_mets, measurevar = "biom", groupvars = c("GIS_FID","Transect_Number"))
  
plot.all.biom = ggplot(biommmm, aes(x=as.factor(Transect_Number), y=as.numeric(biom))) #this graph plots the average- after fourth root transform- abundnace per site, with geom_line connecting the points
  
plot.all.biom + 
  theme_classic()+
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="none", 
        axis.line.x = element_line(color="black", size = 0.5), 
        axis.line.y = element_line(color="black", size = 0.5))+
  #abline(lm(abund ~ as.numeric(Transect_Number), data= abundanceddd))+
#geom_point (colour = "grey") + 
 # geom_point (aes(colour = GIS_FID)) + 
  geom_point()+
  geom_line(aes(group = GIS_FID))+
  # geom_smooth (aes(colour = GIS_FID)) + 
#geom_errorbar(aes(ymin=abund-se, ymax=abund+se), width=.05, position=position_dodge(0.9))+
  scale_y_continuous(name="Average Fish Biomass (kg/m2)", limits=c(0,12), breaks=seq(0, 12, by=4)) +
  #scale_x_continuous(name = "Distance (km)", limits=c(0, 120), breaks=seq(0, 120,by=20)) + geom_smooth(colour = "black", fullrange = FALSE)+
  scale_x_discrete(name = "Distance from Reef", labels = c("0" = "Reef", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))+
  ggtitle("Average Fish Biomass per Site by Distance from Reef")

biompertran <- summarySE(comm_mets, measurevar = "biom", groupvars = c("Transect_Number"))

plot.all.tran.biom = ggplot(biompertran, aes(x=as.factor(Transect_Number), y=as.numeric(biom), group = 1))
  
plot.all.tran.biom + 
  theme_classic()+
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="none", 
        axis.line.x = element_line(color="black", size = 0.5), 
        axis.line.y = element_line(color="black", size = 0.5))+
geom_point (colour = "grey") + 
geom_line() +
geom_errorbar(aes(ymin=biom-se, ymax=biom+se), width=.05, position=position_dodge(0.9))+
  scale_y_continuous(name="Average Fish Biomass (kg/m2)", limits=c(0, 7), breaks=seq(0, 7, by=2)) +
  #scale_x_continuous(name = "Distance (km)", limits=c(0, 120), breaks=seq(0, 120,by=20)) + geom_smooth(colour = "black", fullrange = FALSE)+
  scale_x_discrete(name = "Distance from Reef", labels = c("0" = "Reef", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))+
  ggtitle("Average Fish Biomass by Distance from Reef")

##########################################################################################################


diversssss <- summarySE(comm_mets, measurevar = "shan", groupvars = c("GIS_FID","Transect_Number"))
  
plot.all.shan = ggplot(diversssss, aes(x=as.factor(Transect_Number), y=as.numeric(shan))) #this graph plots the average- after fourth root transform- abundnace per site, with geom_line connecting the points
  
plot.all.shan + 
  theme_classic()+
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="none", 
        axis.line.x = element_line(color="black", size = 0.5), 
        axis.line.y = element_line(color="black", size = 0.5))+
  #abline(lm(abund ~ as.numeric(Transect_Number), data= abundanceddd))+
#geom_point (colour = "grey") + 
 # geom_point (aes(colour = GIS_FID)) + 
  geom_point()+
  geom_line(aes(group = GIS_FID))+
  # geom_smooth (aes(colour = GIS_FID)) + 
#geom_errorbar(aes(ymin=abund-se, ymax=abund+se), width=.05, position=position_dodge(0.9))+
  scale_y_continuous(name="Average Shannon's Diversity Index", limits=c(0,2), breaks=seq(0, 2, by= 0.5)) +
  #scale_x_continuous(name = "Distance (km)", limits=c(0, 120), breaks=seq(0, 120,by=20)) + geom_smooth(colour = "black", fullrange = FALSE)+
  scale_x_discrete(name = "Distance from Reef", labels = c("0" = "Reef", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))+
  ggtitle("Average Shannon's Diversity Index per Site by Distance from Reef")

sahnpertran <- summarySE(comm_mets, measurevar = "shan", groupvars = c("Transect_Number"))

plot.all.tran.shan = ggplot(sahnpertran, aes(x=as.factor(Transect_Number), y=as.numeric(shan), group = 1))
  
plot.all.tran.shan + 
  theme_classic()+
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="none", 
        axis.line.x = element_line(color="black", size = 0.5), 
        axis.line.y = element_line(color="black", size = 0.5))+
geom_point (colour = "grey") + 
geom_line() +
geom_errorbar(aes(ymin=shan-se, ymax=shan+se), width=.05, position=position_dodge(0.9))+
  scale_y_continuous(name="Average Shannon's Diversity Index", limits=c(0, 2), breaks=seq(0, 2, by=0.5)) +
  #scale_x_continuous(name = "Distance (km)", limits=c(0, 120), breaks=seq(0, 120,by=20)) + geom_smooth(colour = "black", fullrange = FALSE)+
  scale_x_discrete(name = "Distance from Reef", labels = c("0" = "Reef", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))+
  ggtitle("Average Shannon's Diversity Index by Distance from Reef")

#####################################################################################
richsssss <- summarySE(comm_mets, measurevar = "S", groupvars = c("GIS_FID","Transect_Number"))
  
plot.all.rich = ggplot(richsssss, aes(x=as.factor(Transect_Number), y=as.numeric(S))) #this graph plots the average- after fourth root transform- abundnace per site, with geom_line connecting the points
  
plot.all.rich + 
  theme_classic()+
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="none", 
        axis.line.x = element_line(color="black", size = 0.5), 
        axis.line.y = element_line(color="black", size = 0.5))+
  #abline(lm(abund ~ as.numeric(Transect_Number), data= abundanceddd))+
#geom_point (colour = "grey") + 
 # geom_point (aes(colour = GIS_FID)) + 
  geom_point()+
  geom_line(aes(group = GIS_FID))+
  # geom_smooth (aes(colour = GIS_FID)) + 
#geom_errorbar(aes(ymin=abund-se, ymax=abund+se), width=.05, position=position_dodge(0.9))+
  scale_y_continuous(name="Average Species Richness", limits=c(0,11), breaks=seq(0, 11, by= 2)) +
  #scale_x_continuous(name = "Distance (km)", limits=c(0, 120), breaks=seq(0, 120,by=20)) + geom_smooth(colour = "black", fullrange = FALSE)+
  scale_x_discrete(name = "Distance from Reef", labels = c("0" = "Reef", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))+
  ggtitle("Average Species Richness per Site by Distance from Reef")

richpertran <- summarySE(comm_mets, measurevar = "S", groupvars = c("Transect_Number"))

plot.all.tran.rich = ggplot(richpertran, aes(x=as.factor(Transect_Number), y=as.numeric(S), group = 1))
  
plot.all.tran.rich + 
  theme_classic()+
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="none", 
        axis.line.x = element_line(color="black", size = 0.5), 
        axis.line.y = element_line(color="black", size = 0.5))+
geom_point (colour = "grey") + 
geom_line() +
geom_errorbar(aes(ymin=S-se, ymax=S+se), width=.05, position=position_dodge(0.9))+
  scale_y_continuous(name="Average Species Richness", limits=c(0, 9), breaks=seq(0, 9, by=2)) +
  #scale_x_continuous(name = "Distance (km)", limits=c(0, 120), breaks=seq(0, 120,by=20)) + geom_smooth(colour = "black", fullrange = FALSE)+
  scale_x_discrete(name = "Distance from Reef", labels = c("0" = "Reef", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))+
  ggtitle("Average Species Richness by Distance from Reef")

#############################################################################################3

evenssss <- summarySE(comm_mets, measurevar = "J", groupvars = c("GIS_FID","Transect_Number"))
  
plot.all.even = ggplot(evenssss, aes(x=as.factor(Transect_Number), y=as.numeric(J))) #this graph plots the average- after fourth root transform- abundnace per site, with geom_line connecting the points
  
plot.all.even + 
  theme_classic()+
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="none", 
        axis.line.x = element_line(color="black", size = 0.5), 
        axis.line.y = element_line(color="black", size = 0.5))+
  #abline(lm(abund ~ as.numeric(Transect_Number), data= abundanceddd))+
#geom_point (colour = "grey") + 
 # geom_point (aes(colour = GIS_FID)) + 
  geom_point()+
  geom_line(aes(group = GIS_FID))+
  # geom_smooth (aes(colour = GIS_FID)) + 
#geom_errorbar(aes(ymin=abund-se, ymax=abund+se), width=.05, position=position_dodge(0.9))+
  scale_y_continuous(name="Average Species Evenness", limits=c(0,10), breaks=seq(0, 10, by= 0.2)) +
  #scale_x_continuous(name = "Distance (km)", limits=c(0, 120), breaks=seq(0, 120,by=20)) + geom_smooth(colour = "black", fullrange = FALSE)+
  scale_x_discrete(name = "Distance from Reef", labels = c("0" = "Reef", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))+
  ggtitle("Average Species Evenness per Site by Distance from Reef")


comm_mets_test <- filter(comm_mets, J != 'NaN')
evenpertran <- summarySE(comm_mets_test, measurevar = "J", groupvars = c("Transect_Number"))

plot.all.tran.even = ggplot(evenpertran, aes(x=as.factor(Transect_Number), y=as.numeric(J), group = 1))
  
plot.all.tran.even + 
  theme_classic()+
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="none", 
        axis.line.x = element_line(color="black", size = 0.5), 
        axis.line.y = element_line(color="black", size = 0.5))+
geom_point (colour = "grey") + 
geom_line() +
geom_errorbar(aes(ymin=J-se, ymax=J+se), width=.05, position=position_dodge(0.9))+
  scale_y_continuous(name="Average Species Evenness", limits=c(0, 1), breaks=seq(0, 1, by=0.2)) +
  #scale_x_continuous(name = "Distance (km)", limits=c(0, 120), breaks=seq(0, 120,by=20)) + geom_smooth(colour = "black", fullrange = FALSE)+
  scale_x_discrete(name = "Distance from Reef", labels = c("0" = "Reef", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))+
  ggtitle("Average Species Evenness by Distance from Reef")


```  

```{r univariate_normality_test}
#testing univariate normality
#attach(comm_mets)
qqnorm(abund)
qqline(abund)
shapiro.test(abund)
bartlett.test(abund ~ GIS_FID, data = comm_mets)
bartlett.test(abund ~ Transect_Number, data = comm_mets)

#but not for transect number???? confused

mod.final <- lm(abund ~ Transect_Number, data = comm_mets)

qqnorm(residuals(mod.final))
qqline(residuals(mod.final))
shapiro.test(residuals(mod.final))

library(nlme)

mod.final2 <- lme(abund ~ Transect_Number, random = ~1|Site/GIS_FID, data = comm_mets)

qqnorm(residuals(mod.final2))
qqline(residuals(mod.final2))
shapiro.test(residuals(mod.final2))

qqnorm(biom)
qqline(biom)
shapiro.test(biom)

qqnorm(shan)
qqline(shan)
shapiro.test(shan)

qqnorm(S)
qqline(S)
shapiro.test(S)

qqnorm(J)
qqline(J)
shapiro.test(J)


#y <- abund
#G <- Transect_Number

# Bartlett Test of Homogeneity of Variances
#bartlett.test(y~G, data=comm_mets)

# Figner-Killeen Test of Homogeneity of Variances
fligner.test(abund~GIS_FID, data=comm_mets)
fligner.test(abund~Transect_Number, data=comm_mets)

```

```{r classification_trees}
library(rpart)

#not transformed

comm_mets$Transect_Number <- as.factor(comm_mets$Transect_Number)
comm_mets$Site <- as.factor(comm_mets$Site)
comm_mets$Structure_Material <- as.factor(comm_mets$Structure_Material)
comm_mets$Sampling_Period <- as.factor(comm_mets$Sampling_Period)
comm_mets$Reef_Type <- as.factor(comm_mets$Reef_Type)
comm_mets$GIS_FID <- as.factor(comm_mets$GIS_FID)


tree <- rpart(abund ~ Transect_Number + Site + Sampling_Period + Reef_Type + Structure_Material, comm_mets, method = "class")

printcp(tree)
plotcp(tree)
rsq.rpart(tree)
print(tree)
summary(tree)
plot(tree)
text(tree)
post(tree, title = "Classification Tree")





#grow a tree
#categorical (classification) method = "class", continuous (regression) methode = "anvoa"
data$Transect_Number <- as.character(data$Transect_Number)
data$Site <- as.character(data$Site)
data$Sampling_Period <- as.character(data$Sampling_Period)


help_new2 <- rpart(species.data ~ Transect_Number + Site + Sampling_Period + Temp_min + max_dep + Structure_Type + Reef_Type + Distance_To_Nearest_Land_ft, data, method = "anova")
#help_new2
#plot(help_new2, uniform=TRUE, 
#  	main="Classification Tree")
#text(help_new2, use.n=TRUE, all=TRUE, cex=.8)
printcp(help_new2)
plotcp(help_new2)
rsq.rpart(help_new2)
print(help_new2)
summary(help_new2)
plot(help_new2)
text(help_new2)
post(help_new2, title = "Classification Tree")

prune.help_new2 <- prune(help_new2, cp = help_new2$cptable[which.min(help_new2$cptable[,"xerror"]),"CP"])
plot(prune.help_new2, uniform=TRUE, 
  	main="Pruned Classification Tree")
text(prune.help_new2, use.n=TRUE, all=TRUE, cex=.8)
post(prune.help_new2, title = "Pruned Classification Tree")




help <- rpart(data, method = "anova")
#help
#summary(help)
#plot(help, uniform=TRUE, 
  #	main="Classification Tree")
#text(help, use.n=TRUE, all=TRUE, cex=.8)
printcp(help)
plotcp(help)
rsq.rpart(help)
print(help)
summary(help)
plot(help)
text(help)
post(help, title = "Classification Tree")

prune.help <- prune(help, cp = help$cptable[which.min(help$cptable[,"xerror"]),"CP"])
plot(prune.help, uniform=TRUE, 
  	main="Pruned Classification Tree")
text(prune.help, use.n=TRUE, all=TRUE, cex=.8)
post(prune.help, title = "Pruned Classification Tree")



cats <- rpart(species.data ~ Transect_Number + Site + Sampling_Period + Reef_Type, data, method = "anova")
printcp(cats)
plotcp(cats)
rsq.rpart(cats)
print(cats)
summary(cats)
plot(cats)
text(cats)
post(cats, title = "Classification Tree")

prune.cats <- prune(cats, cp = cats$cptable[which.min(cats$cptable[,"xerror"]),"CP"])
plot(prune.cats, uniform=TRUE, 
  	main="Pruned Classification Tree")
text(prune.cats, use.n=TRUE, all=TRUE, cex=.8)
post(prune.cats, title = "Pruned Classification Tree")

dogs <- rpart(species.data ~ Transect_Number + Sampling_Period, data, method = "anova")
printcp(dogs)
plotcp(dogs)
rsq.rpart(dogs)
print(dogs)
summary(dogs)
plot(dogs)
text(dogs)
post(dogs, title = "Classification Tree")

prune.dogs <- prune(dogs, cp = dogs$cptable[which.min(dogs$cptable[,"xerror"]),"CP"])
plot(prune.dogs, uniform=TRUE, 
  	main="Pruned Classification Tree")
text(prune.dogs, use.n=TRUE, all=TRUE, cex=.8)
post(prune.dogs, title = "Pruned Classification Tree")



help2 <- rpart(data, method = "class")
help2
plot(help2, uniform=TRUE, 
  	main="Classification Tree")
text(help2, use.n=TRUE, all=TRUE, cex=.8)


```

```{r regression_trees}
# this requires habitat and species datasets
# cull out a focal species, if you haven't already:
###sp <- transform_data(species.orig$MYMI, transform_type = "pres_abs") #this gets the focal species (MYMI species code) and transforms to pres / abs data

# build habitat data of interest from benthic and environmental data
###env.data <- env_data[,c(14, 23)] # Natural reefs
###ben.data <- species.orig[,121:ncol(species.orig)]
###habitat.data <- cbind(env.data, ben.data)

# build a convenient data frame with just what we need (species (species dataset is just one column) and habitat data):
###sp.data <- cbind(sp, habitat.data)
###names(sp.data)
###sp.data$sp<-revalue(factor(sp.data$sp), c("0"="not habitat", "1"="habitat"))
comm_mets$Transect_Number <- as.factor(comm_mets$Transect_Number)
comm_mets$Site <- as.factor(comm_mets$Site)
comm_mets$Structure_Material <- as.factor(comm_mets$Structure_Material)
comm_mets$Sampling_Period <- as.factor(comm_mets$Sampling_Period)
comm_mets$Reef_Type <- as.factor(comm_mets$Reef_Type)
comm_mets$GIS_FID <- as.factor(comm_mets$GIS_FID)


library(tree)
treeeeees <- tree(abund~Transect_Number + Temp_avg + avg_dep + DRR, data = comm_mets)

plot(treeeeees)
text(treeeeees, cex=0.6)




# CART using RPART ...
library(rpart)
#test111 <- rpart(abund ~ Transect_Number + Temp_avg + DRR + avg_dep, data = comm_mets, method = "anova", control = rpart.control(minsplit = 10))
test111 <- rpart(abund ~ Transect_Number + Temp_avg + DRR + avg_dep, data = comm_mets, method = "anova")




###sp.rpart <- rpart(as.factor(sp)~., data=sp.data, method="class")
# print the corss-validation table (already computed):
printcp(test111)
###printcp(sp.rpart)
# or plot it:
plotcp(test111)
###plotcp(sp.rpart)
# the tree itself:
plot(test111)
###plot(sp.rpart)
# add labels, including sample sizes per node:
text(test111)
text(test111, cex = 0.6, use.n = TRUE)
###text(sp.rpart, cex=0.6, use.n=TRUE)
# try a postscript output file (probably won't work):
#post(sp.rpart,"piwa_rpart.ps")


predict.test <- predict(test111, type = "matrix")

table(predict.test)


library(rpart.plot)
prp(test111)

###prp(sp.rpart)

#sp.rpart <- rpart(as.factor(sp)~., data= test111,method="anova", control=rpart.control(minsplit=10))
prp(test111, 
    type = 1,  # set tree type 
    extra = 100, # display percent of observations
    box.col=c("indianred2", "turquoise")[test111$frame$yval], 
    tweak=1.0, # makes smaller so less cluttered
    faclen=0, # do not abbreviate factor levels
    varlen = 0, # do not abbreviate variable levels
    under = TRUE, # percentage text under the boxes
    fallen.leaves = TRUE, # puts fallen leaves at the bottom of plot
    split.prefix = "is ",
    split.suffix = "?")

# predict with an RPART tree:
#sp.rpart.pred <- predict(test111, type="anova")
#table(sp.rpart.pred,sp)

# end of RPART
# end of CART

```

```{r ANOVA}
library(agricolae)
library(nlme)
  
comm_mets$Transect_Number <- as.factor(comm_mets$Transect_Number)
comm_mets$Site <- as.factor(comm_mets$Site)
comm_mets$Sampling_Period <- as.factor(comm_mets$Sampling_Period)
comm_mets$Reef_Type <- as.factor(comm_mets$Reef_Type)
comm_mets$Structure_Type <- as.factor(comm_mets$Structure_Type)
comm_mets$GIS_FID <- as.factor(comm_mets$GIS_FID)


env.cor.data <- cor.test(env_data$Temp_avg,env_data$Temp_max)
env.cor.data2 <- cor.test(env_data$Temp_avg,env_data$Temp_min)
env.cor.data3 <- cor.test(env_data$max_dep,env_data$min_dep)
env.cor.data4 <- cor.test(env_data$min_dep,env_data$avg_dep)
env.cor.data5 <- cor.test(env_data$min_dep,env_data$Temp_min)#need temp and depth
env.cor.data6 <- cor.test(env_data$ver_rel_m,env_data$DRR)
#env.cor.data7 <- cor.test(env_data$Sampling_Period,env_data$Temp_avg)

#include Temp_avg, avg_dep, DRR

########################################################################################################

model <- lm(abund ~ Transect_Number, data = comm_mets)
summary(model)
anova(model)

model.lme <- lme(abund~ Transect_Number, random = ~1|Site/GIS_FID, method = "ML", data = comm_mets)


library(MASS)
model <- lm(abund + 1 ~ Transect_Number, data = comm_mets)
bc <- boxcox(abund +1 ~ Transect_Number, data = comm_mets)
trans <- bc$x[which.max(bc$y)]
mnew <- lm((abund +1) ^ trans ~ Transect_Number, data = comm_mets)
op <- par(pty = "s", mfrow = c(1, 2))
qqnorm(model$residuals); qqline(model$residuals)
qqnorm(mnew$residuals); qqline(mnew$residuals)
par(op)
qqnorm(residuals(mnew))
qqline(residuals(mnew))
shapiro.test(residuals(mnew))



#SHOULD I INCLUDE SITE AND GIS_FID??????

summary(model.lme)
anova(model.lme)

thething <- vcov(model.lme)
vcov(model.lme)

#fixef(thething)
fixef(model.lme)


# step 6: identify final model
mod.final <- model.lme

# step 7: examine model fit
#qqPlot(residuals(mod.final))
qqnorm(residuals(mod.final))
qqline(residuals(mod.final))
shapiro.test(residuals(mod.final))


# step 8: gather data to plot
intervals(mod.final) # confidence intervals
intervals(mod.final, which = 'fixed')
plot.lme(mod.final)
library(lattice)
#xyplot( abund ~ Reef_type|Site, fish)
xyplot( abund ~ Transect_Number|GIS_FID, comm_mets)
#had to choose GIS_FID here because could not use Site/GIS_FID

fixef(mod.final) # fixed estimates of intercept and treatment effect
ranef(mod.final) # random effects estimate
coef(mod.final) # estimates of intercept that vary by random effect (the site; aka block)
predict(mod.final) # estimates of population means for fixed and random effects
predict(mod.final, level=0) # estimates of fixed effects prediction of the mean (marginal means)
fitted(mod.final) # estimates of the conditional means

vcov(mod.final) # variance-covariance matrix of parameter estimates; these are effects estimates, not indificual treatment means
# find treatment means
fixef(mod.final)


#fish$dep <- as.factor(fish$dep)
#newdat <- expand.grid(Reef_type = levels(fish$Reef_type), season = levels(fish$season))
#newdat <- expand.grid(Reef_type = levels(fish$Reef_type), dep = levels(fish$dep))
newdat <- expand.grid(Transect_Number = levels (comm_mets$Transect_Number))
newdat$pred <- predict(mod.final, newdat, level=0)

## [-2] drops response from formula
Designmat <- model.matrix(formula(mod.final)[-2], newdat)
predvar <- diag(Designmat %*% vcov(mod.final) %*% t(Designmat)) 
newdat$SE <- sqrt(predvar) 
newdat$SE2 <- sqrt(predvar+mod.final$sigma^2)
  # code adapted from http://glmm.wikidot.com/faq

#now plot
library(ggplot2)
pd <- position_dodge(width=0.4) 
cmult <- 1  ## could use 1.96 instead

ggplot(newdat, aes(x=Transect_Number, y=pred, group = 1))+
    theme_classic()+
    geom_point(stat = "identity", position = pd)+
    geom_line(stat = "identity", position = pd, colour = "black", size = 1)+
    geom_point(data=comm_mets, aes(x=Transect_Number, y=abund), position=pd, alpha = 0.3)+
    geom_jitter(data = comm_mets, aes(x = Transect_Number, y=abund), alpha = 0.3) +
    geom_errorbar(data=newdat, aes(ymin=pred-SE, ymax=pred+SE, width=0.1), size=1, color = "black", position=pd)+
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="none", 
        axis.line.x = element_line(color="black", size = 0.5), 
        axis.line.y = element_line(color="black", size = 0.5),
        panel.background = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA, size = 1))+
  #cale_y_continuous(name="Average Fish Abundance", limits=c(0, 50), breaks=seq(0, 50, by=10)) +
  scale_x_discrete(name = "Distance from Reef", labels = c("0" = "Reef", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))+
  scale_y_continuous(name = "Fourth Root Transformed Fish Abundance (ind.)")
     #scale_y_continuous(name="Fish abundance", 
                      # expand = c(0, 0),
                       #limits=c(0, 35), 
                       #breaks=seq(0,35,by=5)) + 
       # scale_x_discrete(name="Distance from Reef") + 
   # scale_color_manual(name="Distance from Reef", values = c("Artificial" = ar_color, "Natural" = nr_color))



##########################################################################


#look at everything together, then separate on-reef versus off-reef

#for all

barnacles <- lm(abund ~ Transect_Number + Reef_Type + DRR + Temp_avg + avg_dep + Structure_Material, data = comm_mets)
summary(barnacles)
anova(barnacles)

off_reef <- filter(comm_mets, Transect_Number != "0")
barnacles1 <- lm(abund ~ Transect_Number + DRR + Reef_Type + Temp_avg + avg_dep + Structure_Material, data = off_reef)
summary(barnacles1)
anova(barnacles1)

on_reef <- filter(comm_mets, Transect_Number == "0")
barnacles2 <- lm(abund ~ Transect_Number + DRR + Temp_avg + Reef_Type + avg_dep + Structure_Material, data = off_reef)
summary(barnacles2)
anova(barnacles2)




#Abundance:

#1- everything

out.lm.1 <- lm(abund ~ Site * Transect_Number * Sampling_Period * Structure_Material * Reef_Type * DRR * Temp_min, data =  comm_mets)
anova(out.lm.1)

out.lm.1.1 <- lm(abund ~ Site * Transect_Number * Sampling_Period * Structure_Material * Reef_Type * DRR, data =  comm_mets)
anova(out.lm.1.1)

#same AIC, so drop Temp_min
out.lm.1.2 <- lm(abund ~ Site * Transect_Number * Sampling_Period * Structure_Material * DRR, data =  comm_mets)
anova(out.lm.1.2)
# Same AIC, so drop reef type


#2- just significant
out.lm.2 <- lm(abund ~ Site * Transect_Number * Sampling_Period * Structure_Material * DRR, data =  comm_mets)
anova(out.lm.2)


#3- transform

out.lm.2.1 <- lm(abund ~ Site * Transect_Number * Sampling_Period * Structure_Material *DRR, data =  comm_mets)
anova(out.lm.2.1)
out.lm.2.2 <- lm(sqrt(abund) ~ Site * Transect_Number * Sampling_Period * Structure_Material * DRR, data = comm_mets)
anova(out.lm.2.2)
out.lm.2.3 <- lm((abund)^(1/3) ~ Site * Transect_Number * Sampling_Period * Structure_Material * DRR, data = comm_mets)
anova(out.lm.2.3)
out.lm.2.4 <- lm((abund)^(1/4) ~ Site * Transect_Number * Sampling_Period * Structure_Material * DRR, data = comm_mets)
anova(out.lm.2.4)#lowest AIC
#DRR is no longer sig, so remove

out.lm.2.5 <- lm((abund)^(1/4) ~ Site * Transect_Number * Sampling_Period * Structure_Material, data = comm_mets)
anova(out.lm.2.5)

#4- nested variable
out.lm.3 <- lm((abund)^(1/4) ~ Site/GIS_FID * Transect_Number * Sampling_Period * Structure_Material, data = comm_mets)
anova(out.lm.3)#lower AIC
summary(out.lm.3)

plot.test = ggplot(out.lm.3, aes(x=as.numeric(Transect_Number), y=as.numeric(abund))) #this graph plots the average- after fourth root transform- abundnace per site, with geom_line connecting the points
plot.test+
  theme_classic()+
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="none", 
        axis.line.x = element_line(color="black", size = 0.5), 
        axis.line.y = element_line(color="black", size = 0.5))+
  #abline(lm(abund ~ as.numeric(Transect_Number), data= abundanceddd))+
#geom_point (colour = "grey") + 
  geom_point (aes(colour = GIS_FID)) +  
  #geom_line(aes(group = ))+
  geom_smooth () + 
#geom_errorbar(aes(ymin=abund-se, ymax=abund+se), width=.05, position=position_dodge(0.9))+
  scale_y_continuous(name="Abundance", limits=c(0, 7000), breaks=seq(0, 7000, by=1000)) +
  #scale_x_continuous(name = "Distance (km)", limits=c(0, 120), breaks=seq(0, 120,by=20)) + geom_smooth(colour = "black", fullrange = FALSE)+
  #scale_x_discrete(name = "Distance from Reef", labels = c("0" = "Reef", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))+
  ggtitle("Abundance")

  








out.lm.4 <- lm((abund)^(1/4) ~ Transect_Number * Sampling_Period * Structure_Material, data = comm_mets)
anova(out.lm.4)
summary(out.lm.4)
#5- mixed effects

out.lme.1 <- lme((abund)^(1/4) ~ Transect_Number * Sampling_Period * Structure_Material, random = ~1|Site/GIS_FID, data = comm_mets)
anova(out.lme.1)

#AIC of out.lm.3 is 943.41 on 226 df, AIC of out.lme.1 is 1044.57 on 39 df and we think this one is more appropriate for experiment design.


#Biomass:

#1- everything

biom.lm.1 <- lm(biom ~ Site * Transect_Number * Sampling_Period * Structure_Material * Reef_Type * DRR * Temp_min, data =  comm_mets)
anova(biom.lm.1)

biom.lm.1.1 <- lm(biom ~ Site * Transect_Number * Sampling_Period * Structure_Material * Reef_Type * DRR, data =  comm_mets)
anova(biom.lm.1.1)

#same AIC, so drop Temp_min
biom.lm.1.2 <- lm(biom ~ Site * Transect_Number * Sampling_Period * Structure_Material * DRR, data =  comm_mets)
anova(biom.lm.1.2)
# Same AIC, so drop reef type


#2- just significant
biom.lm.2 <- lm(abund ~ Site * Transect_Number * Sampling_Period * Structure_Material * DRR, data =  comm_mets)
anova(biom.lm.2)


#3- transform

biom.lm.2.1 <- lm(biom ~ Site * Transect_Number * Sampling_Period * Structure_Material *DRR, data =  comm_mets)
anova(biom.lm.2.1)
biom.lm.2.2 <- lm(sqrt(biom) ~ Site * Transect_Number * Sampling_Period * Structure_Material * DRR, data = comm_mets)
anova(biom.lm.2.2)
biom.lm.2.3 <- lm((biom)^(1/3) ~ Site * Transect_Number * Sampling_Period * Structure_Material * DRR, data = comm_mets)
anova(biom.lm.2.3)
biom.lm.2.4 <- lm((biom)^(1/4) ~ Site * Transect_Number * Sampling_Period * Structure_Material * DRR, data = comm_mets)
anova(biom.lm.2.4)#lowest AIC


#4- nested variable
biom.lm.3 <- aov((biom)^(1/4) ~ Site/GIS_FID * Transect_Number * Sampling_Period * Structure_Material* DRR, data = comm_mets)#look up again...
anova(biom.lm.3)#same AIC

#5- mixed effects

comm_mets_test <- filter(comm_mets, biom > 0)


biom.lme.1 <- lme(biom ~ Transect_Number * Sampling_Period * Structure_Material, random = ~1|Site/GIS_FID, data = comm_mets_test)
anova(biom.lme.1) #would not run, google lme error message, TRY LMER

#AICs of out.lm.3 AND biom.lm.2.4 are the same: 375.12 on 174 DF 
out.lme.1 <- lme((abund)^(1/4) ~ Transect_Number * Sampling_Period * Structure_Material, random = ~1|Site/GIS_FID, data = comm_mets)
anova(out.lme.1)


#everything <- lm(abund ~ Transect_Number * Sampling_Period * Site * Reef_Type * DRR * Latitude_DD * Temp_min * avg_dep * Structure_Type * Distance_To_Nearest_Land_ft* ver_rel_m, data = comm_mets)
#anova(everything)
#summary(everything)

forreef <- filter(comm_mets, Transect_Number == "0")

abundreef <- lm(abund ~ Distance_to_HB, data = forreef)
anova(abundreef)
summary(abundreef)

library(nlme)
#library(car) need version 3.2.5

out.lm.1 <- lm(abund ~ Site/GIS_FID * Transect_Number * Sampling_Period * Structure_Material, data =  comm_mets)
anova(out.lm.1)
#Anova(out1)
out.lm.1.5 <- lm(sqrt(abund) ~ Site/GIS_FID * Transect_Number * Sampling_Period * Structure_Material, data = comm_mets)
anova(out.lm.1.5)
out.lm.1.75 <- lm((abund)^(1/3) ~ Site/GIS_FID * Transect_Number * Sampling_Period * Structure_Material, data = comm_mets)
anova(out.lm.1.75)
out.lm.1.8 <- lm((abund)^(1/4) ~ Site/GIS_FID * Transect_Number * Sampling_Period * Structure_Material, data = comm_mets)
anova(out.lm.1.8)#AIC MUCHHHHHH lower than others


out2 <- lm(abund ~ Transect_Number + Sampling_Period + Transect_Number:Sampling_Period, data = comm_mets)
anova(out2)
summary(out2)

out3 <- lme((abund)^(1/4) ~ Transect_Number + Sampling_Period, random = ~1|Site/GIS_FID, data = comm_mets)
anova(out3)

out4  <- lme((abund)^(1/4) ~ Transect_Number + Sampling_Period + Structure_Material + Transect_Number:Sampling_Period + Transect_Number:Structure_Material + Sampling_Period:Structure_Material, random = ~1|Site/GIS_FID, data = comm_mets)
anova(out4)

out4 <- lme((abund)^(1/4) ~ Transect_Number * Sampling_Period * Structure_Material, random = ~1|Site/GIS_FID, data = comm_mets)
anova(out4)
#***********************************************************************
out4 <- lme((abund)^(1/4) ~ Transect_Number + Sampling_Period + Structure_Material, random = ~1|Site/GIS_FID, data = comm_mets)
anova(out4)
#*****************************************************************************
#no longer inclusive of all sites
comm_mets1 <- filter(comm_mets, DRR != 'NA')

out4  <- lme((abund)^(1/4) ~ Transect_Number * Sampling_Period * Structure_Material, random = ~1|Site/GIS_FID, data = comm_mets1)
anova(out4)

out4.5  <- lme((abund)^(1/4) ~ Transect_Number * Sampling_Period * ver_rel_m, random = ~1|Site/GIS_FID, data = comm_mets1)
anova(out4.5)



out5  <- lme((abund)^(1/4) ~ Transect_Number * Temp_avg *DRR * avg_dep, random = ~1|Site/GIS_FID, data = comm_mets1)
anova(out5)


biomreef <- lm(biom ~ Distance_to_NR+ Distance_to_HB + Distance_to_AR + GIS_FID, data = forreef)
anova(biomreef)
summary(biomreef)

divreef <- lm(shan ~ Distance_to_NR+ Distance_to_HB + Distance_to_AR + GIS_FID, data = forreef)
anova(divreef)
summary(divreef)

richreef <- lm(S ~ Distance_to_NR+ Distance_to_HB + Distance_to_AR + GIS_FID, data = forreef)
anova(richreef)
summary(richreef)

evenreef <- lm(J ~ Distance_to_NR+ Distance_to_HB + Distance_to_AR + GIS_FID, data = forreef)
anova(evenreef)
summary(evenreef)



contin_va <- lm(abund ~ Temp_avg + Temp_max + Temp_min + max_dep + min_dep + avg_dep + ver_rel_m + DRR + Depth_ft + Longitude_DD + Latitude_DD + Distance_To_Nearest_Land_ft + Time_Since_Deployment_yrs + DMF_Area_sqft, data = comm_mets)
anova(contin_va)
summary(contin_va)

contin_va_2 <- lm(abund ~ Longitude_DD + Latitude_DD + Distance_To_Nearest_Land_ft, data = comm_mets)
anova(contin_va_2)
summary(contin_va_2)

contin_va_3 <- lm(abund ~ Temp_min + min_dep + ver_rel_m + Distance_To_Nearest_Land_ft, data = comm_mets)
anova(contin_va_3)
summary(contin_va_3)

#everything <- lm(abund ~ Transect_Number * Sampling_Period * Site * GIS_FID * Reef_Type * Structure_Type, data = comm_mets)
#anova(everything)
#summary(everything)

everything2 <- lm(abund ~ Transect_Number + Sampling_Period + GIS_FID/Site + Structure_Material/Reef_Type, data = comm_mets)
anova(everything2)
summary(everything2)

#MIXED MODEL

mixedmod <- lm(abund ~ Transect_Number + Sampling_Period + Site + Reef_Type + Structure_Type + Temp_min + ver_rel_m, data = comm_mets)
anova(mixedmod)
summary(mixedmod)

#everything2 <- lm(abund ~ as.factor(Transect_Number) + as.factor(Sampling_Period) + as.factor(Site) + as.factor(Reef_Type) + Structure_Type + Transect_Number:Sampling_Period + Transect_Number:Site, data = comm_mets)
#anova(everything2)
#summary(everything2)

everythingbiom <- lm(biom ~ Transect_Number + Sampling_Period + Site + Reef_Type + Structure_Type, data = comm_mets)
anova(everythingbiom)
summary(everythingbiom)

everythingS <- lm(S ~ Transect_Number + Sampling_Period + Site + Reef_Type + Structure_Type, data = comm_mets)
anova(everythingS)
summary(everythingS)

everythingshan <- lm(shan ~ Transect_Number + Sampling_Period + Site + Reef_Type + Structure_Type, data = comm_mets)
anova(everythingshan)
summary(everythingshan)

everythingJ <- lm(J ~ Transect_Number + Sampling_Period + Site + Reef_Type + Structure_Type, data = comm_mets)
anova(everythingJ)
summary(everythingJ)

######################################################################################################
#ABUNDANCE
out.abudance <- lm((abund)^(1/4) ~ Transect_Number, data = comm_mets) #
anova(out.abudance)
summary(out.abudance)
hsd <- HSD.test(out.abudance, c("Transect_Number"))
hsd

#BIOMASS
out.biomass <- lm(biom ~ Transect_Number, data = comm_mets)
anova(out.biomass)
summary(out.biomass)
hsdbiom <- HSD.test(out.biomass, c("Transect_Number"))
hsdbiom

#SPECIES RICHNESS
out.S <- lm(S ~ Transect_Number, data = comm_mets)
anova(out.S)
summary(out.S)
hsdS <- HSD.test(out.S, c("Transect_Number"))
hsdS

#SHANNON'S DIVERSITY
out.shan <- lm(shan ~ Transect_Number, data = comm_mets)
anova(out.shan)
summary(out.shan)
hsdshan <- HSD.test(out.shan, c("Transect_Number"))
hsdshan

#SIMPSON'S DIVERSITY
out.simp <- lm(simp ~ Transect_Number, data = comm_mets)
anova(out.simp)
summary(out.simp)
hsdsimp <- HSD.test(out.simp, c("Transect_Number"))
hsdsimp

#INVERSE SIMPSON'S DIVERSITY
#out.invsimp <- lm(simp_inv ~ Transect_Number, data = comm_mets)
#anova(out.invsimp)
#summary(out.invsimp)
#hsdinvsimp <- HSD.test(out.invsimp, c("Transect_Number"))
#hsdinvsimp

#EVENNESS
out.J <- lm(J ~ Transect_Number, data = comm_mets)
anova(out.J)
summary(out.J)
hsdJ <- HSD.test(out.J, c("Transect_Number"))
hsdJ

######################################################################
#interations

transsamp <- lm(abund ~ Transect_Number * Sampling_Period, data = comm_mets)
anova(transsamp)
summary(transsamp)
hsd.transsamp <- HSD.test(transsamp, c("Transect_Number", "Sampling_Period"))
hsd.transsamp

transsampbio <- lm(biom ~ Transect_Number * Sampling_Period, data = comm_mets)
anova(transsampbio)
summary(transsampbio)
hsd.transsampbio <- HSD.test(transsampbio, c("Transect_Number", "Sampling_Period"))
hsd.transsampbio

transsite <- lm(abund ~ Transect_Number * Site, data = comm_mets)
anova(transsite)
summary(transsite)
hsd.transsite <- HSD.test(transsite, c("Transect_Number", "Site"))
hsd.transsite

transreef <- lm(abund ~ Transect_Number*Reef_Type, data = comm_mets)
anova(transreef)
summary(transreef)
hsd.transreef <- HSD.test(transreef, c("Transect_Number", "Reef_Type"))
hsd.transreef

transreefbio <- lm(biom ~ Transect_Number*Reef_Type, data = comm_mets)
anova(transreefbio)
summary(transreefbio)
hsd.transreefbio <- HSD.test(transreefbio, c("Transect_Number", "Reef_Type"))
hsd.transreefbio
##############################################################################
#Sampling period

samp <- lm(abund ~ Sampling_Period, data = comm_mets)
anova(samp)
summary(samp)
hsd.samp <- HSD.test(samp, "Sampling_Period")
hsd.samp
##########################################################################
#Site
siteanova <-lm(abund ~ Site, data = comm_mets)
anova(siteanova)
summary(siteanova)
hsd.siteanova <- HSD.test(siteanova, "Site")
hsd.siteanova


##########################################################
#GIS_FID
fidanova <-lm(abund ~ GIS_FID, data = comm_mets)
anova(fidanova)
summary(fidanova)
hsd.fidanova <- HSD.test(fidanova, "GIS_FID")
hsd.fidanova


#########################################################################################
#Reef type

reefanova <- lm(abund ~ Reef_Type, data = comm_mets)
anova(reefanova)
summary(reefanova)
hsd.reefanova <- HSD.test(reefanova, c("Reef_Type"))
hsd.reefanova

reefanovabio <- lm(biom ~ Reef_Type, data = comm_mets)
anova(reefanovabio)
summary(reefanovabio)
hsd.reefanovabio <- HSD.test(reefanovabio, c("Reef_Type"))
hsd.reefanovabio

##################################################################################
#visibility
#vis <- lm(abund ~ Visibility_Min_ft, data = comm_mets)
#summary(vis)

```

```{r ggplot2}

library(ggplot2)

testabund <- summarySE(comm_mets, measurevar = "abund", groupvars = c("Transect_Number"))


A <- ggplot(testabund, aes(x=as.factor(Transect_Number), y=abund)) +
  theme_classic()+
  geom_bar(position=position_dodge(), stat="identity", colour="black")+
  geom_errorbar(aes(ymin=abund-se, ymax=abund+se), width=.2, position=position_dodge(0.9))+
  scale_y_continuous(name="Average Fish Abundance", 
                     limits=c(0, 15), 
                     breaks=seq(0, 15,by=5)) + 
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="none", 
        axis.line.x = element_line(color="black", size = 0.5), 
        axis.line.y = element_line(color="black", size = 0.5))+ 
  scale_x_discrete(name = "Distance from Reef", labels = c("0" = "Reef", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))+
  ggtitle("Fish Abundance by Distance from Reef")+
annotate("text", x = 1, y = 14.5, label = "a", size = 5)+
annotate("text", x = 2, y = 5, label = "b", size = 5)+
annotate("text", x = 3, y = 2.5, label = "c", size = 5)+
annotate("text", x = 4, y = 2, label = "c", size = 5)

########################################################################################3

testbiom <- summarySE(comm_mets, measurevar = "biom", groupvars = c("Transect_Number"))


B <- ggplot(testbiom, aes(x=as.factor(Transect_Number), y=biom)) +
  theme_classic()+
  geom_bar(position=position_dodge(), stat="identity", colour="black")+
  geom_errorbar(aes(ymin=biom-se, ymax=biom+se), width=.2, position=position_dodge(0.9))+
  scale_y_continuous(name="Average Fish Biomass (g/m^2)", 
                     limits=c(0, 8), 
                     breaks=seq(0, 8,by=2)) + 
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="none", 
        axis.line.x = element_line(color="black", size = 0.5), 
        axis.line.y = element_line(color="black", size = 0.5))+ 
  scale_x_discrete(name = "Distance from Reef", labels = c("0" = "Reef", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))+
  ggtitle("Fish Biomass by Distance from Reef")+
annotate("text", x = 1, y = 7, label = "a", size = 5)+
annotate("text", x = 2, y = 2.25, label = "b", size = 5)+
annotate("text", x = 3, y = 1.25, label = "c", size = 5)+
annotate("text", x = 4, y = 1.25, label = "bc", size = 5)
########################################################################################################

testshan <- summarySE(comm_mets, measurevar = "shan", groupvars = c("Transect_Number"))


C <- ggplot(testshan, aes(x=as.factor(Transect_Number), y=shan)) 
C +
  theme_classic()+
  geom_bar(position=position_dodge(), stat="identity", colour="black")+
  geom_errorbar(aes(ymin=shan-se, ymax=shan+se), width=.2, position=position_dodge(0.9))+
  scale_y_continuous(name="Shannon's Diversity Index", 
                     limits=c(0, 2), 
                     breaks=seq(0, 2,by=0.5)) + 
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="none", 
        axis.line.x = element_line(color="black", size = 0.5), 
        axis.line.y = element_line(color="black", size = 0.5))+ 
  scale_x_discrete(name = "Distance from Reef", labels = c("0" = "Reef", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))+
  ggtitle("Shannon's Diversity Index by Distance from Reef")+
annotate("text", x = 1, y = 1.9, label = "a", size = 5)+
annotate("text", x = 2, y = 0.8, label = "b", size = 5)+
annotate("text", x = 3, y = 0.4, label = "c", size = 5)+
annotate("text", x = 4, y = 0.4, label = "c", size = 5)
##############################################################################################
testS <- summarySE(comm_mets, measurevar = "S", groupvars = c("Transect_Number"))


D <- ggplot(testS, aes(x=as.factor(Transect_Number), y=S))
D +
  theme_classic()+
  geom_bar(position=position_dodge(), stat="identity", colour="black")+
  geom_errorbar(aes(ymin=S-se, ymax=S+se), width=.2, position=position_dodge(0.9))+
  scale_y_continuous(name="Species Richness", 
                     limits=c(0, 9), 
                     breaks=seq(0, 9,by=2)) + 
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="none", 
        axis.line.x = element_line(color="black", size = 0.5), 
        axis.line.y = element_line(color="black", size = 0.5))+ 
  scale_x_discrete(name = "Distance from Reef", labels = c("0" = "Reef", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))+
  ggtitle("Species Richness by Distance from Reef")+
annotate("text", x = 1, y = 8.5, label = "a", size = 5)+
annotate("text", x = 2, y = 3, label = "b", size = 5)+
annotate("text", x = 3, y = 1.5, label = "c", size = 5)+
annotate("text", x = 4, y = 1.5, label = "c", size = 5)
############################################################################


testJ <- summarySE(comm_mets, measurevar = "J", groupvars = c("Transect_Number"))


E <- ggplot(testJ, aes(x=as.factor(Transect_Number), y=J)) +
  theme_classic()+
  geom_bar(position=position_dodge(), stat="identity", colour="black")+
  geom_errorbar(aes(ymin=S-se, ymax=S+se), width=.2, position=position_dodge(0.9))+
  scale_y_continuous(name="Evenness", 
                     limits=c(0, 9), 
                     breaks=seq(0, 9,by=2)) + 
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="none", 
        axis.line.x = element_line(color="black", size = 0.5), 
        axis.line.y = element_line(color="black", size = 0.5))+ 
  scale_x_discrete(name = "Distance from Reef", labels = c("0" = "Reef", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))+
  ggtitle("Species Evenness by Distance from Reef")+
annotate("text", x = 1, y = 8.5, label = "a", size = 5)+
annotate("text", x = 2, y = 3, label = "b", size = 5)+
annotate("text", x = 3, y = 1.5, label = "c", size = 5)+
annotate("text", x = 4, y = 1.5, label = "c", size = 5)
###############################################################################

testabund2 <- summarySE(comm_mets, measurevar = "abund", groupvars = c("Transect_Number", "Sampling_Period"))
testabund2$Sampling_Period <- factor(testabund2$Sampling_Period, c("Fall", "Winter", "Spring"))
#order levels of treatment to appear orderly in plots

ann_text <- data.frame(Transect_Number = c(0,1,2,3), abund = c(20.5,12,6,5),lab = c("a", "bc","de","e"),Sampling_Period = factor("Fall",levels = c("Fall","Winter","Spring")))
ann_text_winter <- data.frame(Transect_Number = c(0,1,2,3), abund = c(15.5,5,3,2),lab = c("b", "e","e","e"),Sampling_Period = factor("Winter",levels = c("Fall","Winter","Spring")))
ann_text_spring <- data.frame(Transect_Number = c(0,1,2,3), abund = c(9.5,2,1,2),lab = c("cd", "e","e","e"),Sampling_Period = factor("Spring",levels = c("Fall","Winter","Spring")))


ggplot(testabund2, aes(x=as.factor(Transect_Number), y=abund)) +
  theme_classic()+
  facet_wrap(~Sampling_Period, ncol=3)+
  geom_bar(position=position_dodge(), stat="identity", colour="black")+
  geom_errorbar(aes(ymin=abund-se, ymax=abund+se), width=.2, position=position_dodge(0.9))+
  scale_y_continuous(name="Average Fish Abundance", 
                     limits=c(0, 21), 
                     breaks=seq(0, 21,by=5)) + 
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="bottom",
        axis.line.x = element_line(color="black", size = 0.5), 
        axis.line.y = element_line(color="black", size = 0.5))+ 
  scale_x_discrete(name = "Distance from Reef", labels = c("0" = "Reef", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))+
ggtitle("Fish Abundance by Distance from Reef by Season")+
geom_text(data = ann_text,aes(label =lab), size = 5)+
geom_text(data = ann_text_winter,aes(label =lab), size = 5)+  
geom_text(data = ann_text_spring,aes(label =lab), size = 5)  

#######################################################################################

testabund3 <- summarySE(comm_mets, measurevar = "abund", groupvars = "Sampling_Period")
testabund3$Sampling_Period <- factor(testabund3$Sampling_Period, c("Fall", "Winter", "Spring"))

ggplot(testabund3, aes(x=as.factor(Sampling_Period), y=abund)) +
  theme_classic()+
  geom_bar(position=position_dodge(), stat="identity", colour="black")+
  geom_errorbar(aes(ymin=abund-se, ymax=abund+se), width=.2, position=position_dodge(0.9))+
  scale_y_continuous(name="Average Fish Abundance", 
                     limits=c(0, 12), 
                     breaks=seq(0, 12,by=2)) + 
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="none", 
        axis.line.x = element_line(color="black", size = 0.5), 
        axis.line.y = element_line(color="black", size = 0.5))+ 
  scale_x_discrete(name = "Season")+#, labels = c("0" = "Structural", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))+
  ggtitle("Fish Abundance per Season")+
annotate("text", x = 1, y = 11, label = "a", size = 5)+
annotate("text", x = 2, y = 5, label = "b", size = 5)+
annotate("text", x = 3, y = 3, label = "c", size = 5)
####################################################################################

testabund4 <- summarySE(comm_mets, measurevar = "abund", groupvars = c("Transect_Number", "Reef_Type"))

#ggplot(testabund4, aes(x=as.factor(Transect_Number), y=abund, fill=Reef_Type)) +
 # theme_classic()+
#  geom_bar(position=position_dodge(), stat="identity", colour="black")+
#  geom_errorbar(aes(ymin=abund-se, ymax=abund+se), width=.2, position=position_dodge(0.9))+
#  scale_y_continuous(name="Average Fish Abundance", 
 #                    limits=c(0, 500), 
  #                   breaks=seq(0, 500,by=100)) + 
#  theme(axis.text=element_text(size=16, colour="black"), 
 #       axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
  #      axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
   #     legend.position="bottom") + 
#  scale_x_discrete(name = "Transect Type", labels = c("0" = "Structural", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))
##############################################################################

ann_text_art <- data.frame(Transect_Number = c(0,1,2,3),abund = c(14.5,5,2.5,2),lab = c("a", "ab","b","b"),Reef_Type = factor("Artificial",levels = c("Artificial","Natural")))
ann_text_nat <- data.frame(Transect_Number = c(0,1,2,3),abund = c(16,5.5,3,4),lab = c("ab", "ab","b","b"),Reef_Type = factor("Natural",levels = c("Artificial","Natural")))

ggplot(testabund4, aes(x=as.factor(Transect_Number), y=abund)) +
  theme_classic()+
  facet_wrap(~Reef_Type, ncol = 2) +
  geom_bar(position=position_dodge(), stat="identity", colour="black")+
  geom_errorbar(aes(ymin=abund-se, ymax=abund+se), width=.2, position=position_dodge(0.9))+
  scale_y_continuous(name="Average Fish Abundance", 
                     limits=c(0, 16), 
                     breaks=seq(0, 16,by=5)) + 
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="bottom", 
axis.line.x = element_line(color="black", size = 0.5), 
        axis.line.y = element_line(color="black", size = 0.5))+ 
  scale_x_discrete(name = "Distance from Reef", labels = c("0" = "Reef", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))+
ggtitle("Fish Abundance by Distance from Reef by Reef Type")+
geom_text(data = ann_text_art,aes(label =lab), size = 5)+
geom_text(data = ann_text_nat,aes(label =lab), size = 5)

###########################################################################################
testabund4 <- summarySE(comm_mets, measurevar = "abund", groupvars = c("Reef_Type"))

ggplot(testabund4, aes(x=as.factor(Reef_Type), y=abund)) +
  theme_classic()+
  #facet_wrap(~Site, ncol = 6) +
  geom_bar(position=position_dodge(), stat="identity", colour="black")+
  geom_errorbar(aes(ymin=abund-se, ymax=abund+se), width=.2, position=position_dodge(0.9))+
  scale_y_continuous(name="Average Fish Abundance", 
                     limits=c(0, 6), 
                     breaks=seq(0, 6,by=1)) + 
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="bottom",
        axis.line.x = element_line(color="black", size = 0.5), 
        axis.line.y = element_line(color="black", size = 0.5))+ 
  scale_x_discrete(name = "Reef Type") +#, labels = c("0" = "Structural", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))
ggtitle("Fish Abundance per Reef Type")+
annotate("text", x = 1, y = 5.1, label = "a", size = 5)+
annotate("text", x = 2, y = 5.8, label = "a", size = 5)

##################################################################################################

#testabund6 <- summarySE(comm_mets, measurevar = "abund", groupvars = c("Transect_Number", "Site"))
#testabund6$Sampling_Period <- factor(testabund6$Sampling_Period, c("Fall", "Winter", "Spring"))

#ann_text_330 <- data.frame(Transect_Number = c(0,1,2,3), abund = c(2300,510,250,20),lab = c("a", "b","b","b"),Site = factor("330",levels = c("330","345","364","370","372","378")))

#ann_text_345 <- data.frame(Transect_Number = c(0,1,2,3), abund = c(400,550,50,20),lab = c("b", "b","b","b"),Site = factor("345",levels = c("330","345","364","370","372","378")))
#ann_text_364 <- data.frame(Transect_Number = c(0,1,2,3), abund = c(600,400,30,20),lab = c("b", "b","b","b"),Site = factor("364",levels = c("330","345","364","370","372","378")))
#ann_text_370 <- data.frame(Transect_Number = c(0,1,2,3), abund = c(500,200,80,20),lab = c("b", "b","b","b"),Site = factor("370",levels = c("330","345","364","370","372","378")))
#ann_text_372 <- data.frame(Transect_Number = c(0,1,2,3), abund = c(500,200,80,20),lab = c("b", "b","b","b"),Site = factor("372",levels = c("330","345","364","370","372","378")))
#ann_text_378 <- data.frame(Transect_Number = c(0,1,2,3), abund = c(500,200,80,20),lab = c("b", "b","b","b"),Site = factor("378",levels = c("330","345","364","370","372","378")))

#xpos <- c(0,1,2,3) 
#ypos <- c(2200,500,100,20)
#lab <- c("a", "b", "b", "b")
#ldata <- data.frame(xpos, ypos, lab, Site = factor("330", levels= #c("330","345","364","370","372","378")))

#ggplot(test3, aes(x=as.factor(Transect_Number), y=abund)) +
 # theme_classic()+
  #facet_wrap(~Site, nrow = 1,ncol = 6) +
  #geom_bar(position=position_dodge(), stat="identity", colour="black")+
  #geom_errorbar(aes(ymin=abund-se, ymax=abund+se), width=.2, position=position_dodge(0.9))+
#  scale_y_continuous(name="Average Fish Abundance", 
 #                    limits=c(0, 2500), 
  #                   breaks=seq(0, 2500,by=500)) + 
#  theme(axis.text=element_text(size=16, colour="black"), 
 #       axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
  #      axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
   #     legend.position="bottom", 
#axis.line.x = element_line(color="black", size = 0.5), 
 #       axis.line.y = element_line(color="black", size = 0.5))+ 
#  scale_x_discrete(name = "Distance from Structure", labels = c("0" = "Structure", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))+
#ggtitle("Fish Abundance by Distance from Structure by Site")+

 # geom_text(data= data.frame(x= 1, y = 2200, Site = "330"), aes(label = "a"))

#  geom_text(data=ldata, aes(x=xpos, y=ypos, 
                          #  label=lab, size=1))
#geom_text(aes(x, y, label=lab),
      #data=data.frame(x=c(0,1,2,3), y=c(2250, 500,300,100), lab=c("a","b","b", "b"), Site = "330"))
  
 # annotate("text", data = data.frame (x = c(0,1,2,3), y = c(2250,500,300,100), Site = "330", label = c("a","b","b","b"), size = 5))
        
         
#geom_text(data = ann_text_330,aes(label =lab), size = 5)+
#geom_text(data = ann_text_345,aes(label =lab), size = 5)+
#geom_text(data = ann_text_364,aes(label =lab), size = 5)+
#geom_text(data = ann_text_370,aes(label =lab), size = 5)+
#geom_text(data = ann_text_372,aes(label =lab), size = 5)+
#geom_text(data = ann_text_378,aes(label =lab), size = 5)


#################################################################################################
testabund7 <- summarySE(comm_mets, measurevar = "abund", groupvars = c("Site"))

ggplot(testabund7, aes(x=as.factor(Site), y=abund)) +
  theme_classic()+
  #facet_wrap(~Site, ncol = 6) +
  geom_bar(position=position_dodge(), stat="identity", colour="black")+
  geom_errorbar(aes(ymin=abund-se, ymax=abund+se), width=.2, position=position_dodge(0.9))+
  scale_y_continuous(name="Average Fish Abundance", 
                     limits=c(0, 8), 
                     breaks=seq(0, 8,by=2)) + 
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="bottom",
        axis.line.x = element_line(color="black", size = 0.5), 
        axis.line.y = element_line(color="black", size = 0.5))+ 
  scale_x_discrete(name = "Site") +#, labels = c("0" = "Structural", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))
ggtitle("Fish Abundance per Site")+
annotate("text", x = 1, y = 7.3, label = "ab", size = 5)+
annotate("text", x = 2, y = 7.3, label = "ab", size = 5)+
annotate("text", x = 3, y = 5.8, label = "ab", size = 5)+
annotate("text", x = 4, y = 5, label = "ab", size = 5)+
annotate("text", x = 5, y = 7.1, label = "a", size = 5)+
annotate("text", x = 6, y = 3, label = "b", size = 5)


grid_arrange_shared_legend <- function(...) {
plots <- list(...)
  g <- ggplotGrob(plots[[1]] + theme(legend.position="bottom"))$grobs
  legend <- g[[which(sapply(g, function(x) x$name) == "guide-box")]]
  lheight <- sum(legend$height)
  grid.arrange(
    do.call(arrangeGrob, lapply(plots, function(x)
      x + theme(legend.position="none"))),
    legend,
    ncol = 1,
    heights = unit.c(unit(1, "npc") - lheight, lheight))
}


multiple_plots <- grid_arrange_shared_legend(A, B, ncol = 2)


gtable(widths = list(), heights = list(), respect = FALSE,
name = "layout", rownames = NULL, colnames = NULL, vp = NULL)

multilove <- gtable_add_grob(A, B, 1,1)
plot(multilove)


par(mfrow=c(2,3)) # plots as one row and two columns
A
B
C
D
E

#dev.off()

# Plot distance vs. depth
plot(data_final$dist_m_scaled, data_final$Abs_Pres_m, type = "l", xlim=c(0,30), ylim=c(20,5), xlab="Distance (m)", ylab="Depth (m)")
title("Contour")

mtext(as.character(uniq[p]), side=3, outer=TRUE, line=-3) # adds overall title

```

