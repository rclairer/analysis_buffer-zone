---
title: "BZ_V3"
author: "Claire_Rosemond"
date: "October 4, 2016"
output: html_document
---

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r working_dir}

setwd("C:/Users/rclairer/Dropbox (Paxton)/Paxton Team Folder/CRFL - Artificial Reefs/Buffer_Zone/analysis_buffer-zone")

```

```{r setup}
opts_chunk$set(echo = FALSE)
invisible(sapply(list.files(path = "R", pattern = "R$", full.names = TRUE), source)) # find functions and other dependencies in .R files
```

```{r get_data}

### FISH DATA ### --------------------------------------------------------------
detach("package:plyr", unload=TRUE)
library(dplyr)
library(lubridate)
library(reshape2)

fish_data <- read.csv ("Fish/4_clean_data/fish_clean_data_output.csv") #without 342 (version of new2, size bins that hayley changed, removing sites not used, removing t1_t2_t3

fish_data_str <- filter(fish_data, Transect_Type == "Structural")
fish_data_str_0 <- filter(fish_data, Transect_Number == "0")
fish_data_rad <- filter(fish_data, Transect_Type == "Radiating")

fish_data <- rbind(fish_data_str_0, fish_data_rad)
#fish_data <- filter(fish_data, Transect_Type == "Structural")
#fish_data <- filter(fish_data, Transect_Type == "Radiating")
#fish_data <- filter(fish_data, Species_Code != "SYSA")
#fish_data <- filter(fish_data, ID != "AR-364_PODS_2015-09-21_R_T2")

#fish_data_nofi <- filter(fish_data, Species_Code == "NOFI")
#fish_data <- filter(fish_data, Species_Code != "NOFI")
fish_data <- filter(fish_data, ID != "AR-364_PODS_2015-09-21_R_T2")
#fish_data <- filter(fish_data, ID != "AR-330_BARGE_2015-12-11_S_T0") #try adding back in
fish_data <- filter(fish_data, ID != "AR-378_PODS_2015-09-14_R_T1")
fish_data <- filter(fish_data, ID != "AR-364_BARGE_2015-12-10_R_T2")
fish_data <- filter(fish_data, ID != "AR-372_NR2_2015-12-09_R_T5")
fish_data <- filter(fish_data, ID != "AR-372_PODS_2015-12-09_R_T4")
fish_data <- filter(fish_data, ID != "AR-372_RB1_2015-12-09_R_T3")
fish_data <- filter(fish_data, ID != "AR-345_RB1_2015-10-15_R_T2")
fish_data <- filter(fish_data, ID != "AR-345_RB2_2015-10-15_R_T3")
fish_data <- filter(fish_data, ID != "AR-345_TITAN_2015-10-15_R_T3")


#fish_data <- filter(fish_data, Site == "330")
#fish_data <- filter(fish_data, Transect_Type == "Radiating")

fish_meta <- combine_data_meta (data = fish_data, 
                                file_meta = "Metadata/Fish/Fish_Codes_CRFL-AR.csv", 
                                merge_by = "Species_Code") 

fish_biom<-make_fish_biomass_col(data = fish_meta)
#fish_subset <- subset_data (data = fish_biom,
                          #sub_cat = "Pelagic.Demersal", #sub_cat = "Snapper.Grouper",
                          #sub_val = "Demersal") # YES for yes

## make fish abundance matrix
fish_biom -> data

data$group <- data[,"Species_Code"] # change to family or function_group as needed
#data$group <- data[,"Family"]
#data$group <- data[,"Functional_Group"]

#data$group <- data[,"Family"] #### FAMILY AND FUNCTIONAL GROUP DON"T WORK AS IS BECAUSE THERE ARE FISH WITHOUT FAMILIES AND FUNCTIONAL GROUPS MATCHING THEM...NEEDS FIXING"

new2 <- data %>% group_by(group, ID, Site, Subsite, Date, Transect_Type, Sampling_Period, Transect_Number) %>% summarise(data_abund = sum(Abundance))
new3 <- dcast(new2, ID + Site + Subsite + Date + Transect_Type + Sampling_Period + Transect_Number ~ group) #USE THESE

new2biom <- data %>% group_by(group, ID, Site, Subsite, Date, Transect_Type, Sampling_Period, Transect_Number) %>% summarise(data_biom = sum(biomass))
new3biom <- dcast(new2biom, ID + Site + Subsite + Date + Transect_Type + Sampling_Period + Transect_Number ~ group)
#new2 <- data %>% group_by(group, ID, Site, Subsite, Date, Transect_Type, Sampling_Period, Transect_Number, Visibility_Min_ft) %>% summarise(data_abund = sum(Abundance))
  
#new3 <- dcast(new2, ID + Site + Subsite + Date + Transect_Type + Sampling_Period + Transect_Number + Visibility_Min_ft ~ group) 

#new2 <- data %>% group_by(group, ID, Site, Subsite, Date, Transect_Type, Sampling_Period, Transect_Number, Structure_Present, Radiating_Structure) %>% summarise(data_abund = sum(Abundance))
#new3 <- dcast(new2, ID + Site + Subsite + Date + Transect_Type + Sampling_Period + Transect_Number + Structure_Present + Radiating_Structure ~ group) 

new3[is.na(new3)]<-0
new3biom[is.na(new3biom)] <- 0
#new4 = new3[rowSums(new3[,8:ncol(new3)]) !=0,] # CHANGED 10/25/16!!!remove rows where there were no fish on the transect - need this for species, family, and functional group levels
#fish_abund_matrix <- new4
fish_abund_matrix <- new3
fish_biom_matrix <- new3biom
# fish_abund_matrix <- calc_fish_abund_matrix (data = fish_biom, 
#                                       #tax_level = "Species_Code")
#                                       #tax_level = "Family")
# 
# fish_biom_matrix <- calc_fish_biom_matrix (data = fish_biom, 
#                                            #tax_level = "Species_Code")
#                                            #tax_level = "Family")
#                                           tax_level = "Functional_Group")
# If at species level, bring meta data back in --> can't do if in wide format obviously!
#library(plyr)
#fish_abund <- rename(fish_abund, c("group"="Species_Code"))
#fish_abund <- combine_data_meta(data = fish_abund, 
                  #file_meta = "Metadata/Fish/Fish_Codes.csv",
                  #merge_by = "Species_Code")

fish <- fish_abund_matrix # select either abundance or biomass matrix
fishbiom <- fish_biom_matrix
#fish <- remove_rare_species (data = fish) # remove rare species if desired

#rm(fish_data, fish_meta, fish_biom, fish_subset, fish_abund_matrix, fish_biom_matrix) # remove dataframes


### COMPLEXITY DATA ### -------------------------------------------------------
comp <-read.table("Complexity/3_Clean_Data/comp_site_change.csv", header=T, sep=',')


### TEMPEATURE DATA ### -------------------------------------------------------
temp <-read.table("Temperature/3_Clean_Data/temp_site_change.csv", header=T, sep=',')


### SITES METADATA ### ------------------------------------------------------------
sites <-read.table("Metadata/Sites/CRFL-AR_SITES_Master_2016-06-30_new.csv", header=T, sep=',')

### MERGE DATA ### ------------------------------------------------------------

library(plyr)

join1 <- join(fish, temp, by = c("Site", "Subsite", "Date", "Transect_Type","Transect_Number"))
join2 <- join(join1, comp, by = c("Site", "Subsite", "Date", "Transect_Type","Transect_Number"))
join3 <- join(join2, sites, by = c("Site", "Subsite")) 

joinbiom1 <- join(fishbiom, temp, by = c("Site", "Subsite", "Date", "Transect_Type","Transect_Number"))
joinbiom2 <- join(joinbiom1, comp, by = c("Site", "Subsite", "Date", "Transect_Type","Transect_Number"))
joinbiom3 <- join(joinbiom2, sites, by = c("Site", "Subsite")) 

#join4 <- cbind(join3[,1:8], join3[,91:114], join3[,9:90]) #FOR SPECIES crude way of rearranging so that columns are in decent order; it duplicates ID and names it ID.1 for the duplicate so delete that column later on 
#join4 <- cbind(join3[,1:9], join3[,37:60], join3[,10:36]) #FOR FAMILY 
#join4 <- cbind(join3[,1:9], join3[,17:40], join3[,10:16]) #FOR FUNCTIONAL GROUP 

# new ones
join4 <- cbind(join3[,1:7], join3[,81:104], join3[,8:80]) # species
joinbiom4 <- cbind(joinbiom3[,1:7], joinbiom3[,81:104], joinbiom3[,8:80])
#join4 <- cbind(join3[,1:7], join3[,36:ncol(join3)], join3[,8:35]) # family
#join4 <- cbind(join3[,1:7], join3[,16:ncol(join3)], join3[8:15]) #Functional group



#for structural, species
#join4 <- cbind(join3[,1:7], join3[,75:98], join3[,8:74]) # species

#for radiating, species
#join4 <- cbind(join3[,1:7], join3[,63:86], join3[,8:62]) # species

#for radiating, family
#join4 <- cbind(join3[,1:7], join3[,31:54], join3[,8:30]) # species


join5 <- join4[,-c(8, 12)] # FOR SPECIES
joinbiom5 <- joinbiom4[,-c(8, 12)]
#join5 <- join4[,-c(8,12)] # FOR FAMILY 
#join5 <- join4[,-c(8,12)] # FOR FUNCTIONAL GROUP

#for structural, species


data <- join5

databiom <- joinbiom5

#rm(list= ls()[!(ls() %in% c('data'))]) # removes everything except selected data frame(s) 


## Filter data if necessary ## -------------------------------
#data <- filter(data, Reef_type == "Natural")
#data <- filter(data, Reef_type == "Artificial")
 #data <- filter(data, Depth_general == "Shallow")
# data <- filter(data, Depth_general == "Shallow")
# data <- filter(data, Depth_general == "Deep")
#data <- filter(data, Reef_type == "Natural", Depth_general == "Intermediate")

env.end<- 29 #FOR SPECEIS
sp.start<-30 #FOR SPECIES
#env.end <- 29 #FOR FAMILY
#sp.start <- 30 #FOR FAMILY
#env.end <- 29 #FOR FUNCTIONAL GROUP
#sp.start <-30 #FOR FUNCTIONAL GROUP

# preserve biomass data for plotting
#biom_data<-merge(merge.2, fish_biom_matrix)
#biom_data <- filter(biom_data, Reef_type == "Artificial")
### REMOVE OUTLIER 200LE on 2014-07-01
#biom_data <- biom_data[-8,]

#biom_data <- biom_data[,sp.start:ncol(biom_data)]

env_data <- data[,1:env.end]
 
species.data<-data[,sp.start:ncol(data)] # fish data
species.orig<-species.data # fish data, no transform

species.data.biom <- databiom[,sp.start:ncol(databiom)]
species.orig.biom <- species.data.biom
#species.data <- transform_data (data = species.data, transform_type = "square_root")
#species.data <- transform_data (data = species.data, transform_type = "cube_root")
#species.data <- transform_data (data = species.data, transform_type = "pres_abs")
#we need to look at this with Avery
species.data <- transform_data (data = species.data, transform_type = "square_root_plus_number")
species.data.biom <- transform_data (data = species.data.biom, transform_type = "square_root_plus_number")
```

```{r comm_metrics}
library(vegan)

  S <- specnumber(species.orig) # species richness (S)
  shan <- diversity (species.orig, index = "shannon") # shannon diversity
  simp <- diversity (species.orig, index = "simpson") # simpson's diversity
  simp_inv <- diversity (species.orig, index = "invsimpson") # inverse simpson's diversity
  J <- shan / log (S) # pielou's evenness (J)
  abund <- rowSums (species.orig, na.rm = FALSE, dims = 1) # total abundance for each sample
  biom <- rowSums (species.orig.biom, na.rm = FALSE, dims = 1) # totaal biomass for each sample
  comm_mets <- cbind (abund, biom, S, shan, simp, simp_inv, J, env_data)  

```


#BCD and distance
``` {r BCD_function_prep}
library(ecodist)
library(vegan)
library(ggplot2)

structural.data <- filter(data, Transect_Type == "Structural")
fall.structural.data <- filter(structural.data, Sampling_Period == "Fall")
winter.structural.data <- filter(structural.data, Sampling_Period == "Winter")
spring.structural.data <- filter(structural.data, Sampling_Period == "Spring")


fall.MHC.data <- filter(fall.structural.data, Site == "330" | Site == "345")
fall.wil.data <- filter(fall.structural.data, Site == "364"| Site == "370" | Site == "372" | Site == "378")
winter.MHC.data <- filter(winter.structural.data, Site == "330" | Site == "345")
winter.wil.data <- filter(winter.structural.data, Site == "364"| Site == "370" | Site == "372" | Site == "378")
spring.MHC.data <- filter(spring.structural.data, Site == "330" | Site == "345")
spring.wil.data <- filter(spring.structural.data, Site == "364"| Site == "370" | Site == "372" | Site == "378")
spring.wil.data <- filter(spring.wil.data, ID != "AR-364_PODS_2016-05-11_S_T1")
spring.wil.data <- filter(spring.wil.data, ID != "AR-370_PODS_2016-05-10_S_T1")
spring.wil.data <- filter(spring.wil.data, ID != "AR-370_PODS_2016-05-10_S_T2")
spring.wil.data <- filter(spring.wil.data, ID != "AR-370_PODS_2016-05-10_S_T3")
spring.wil.data <- filter(spring.wil.data, ID != "AR-370_PODS_2016-05-11_S_T2")
spring.wil.data <- filter(spring.wil.data, ID != "AR-378_PODS_2016-05-10_S_T1")
spring.wil.data <- filter(spring.wil.data, ID != "AR-378_PODS_2016-05-10_S_T2")
spring.wil.data <- filter(spring.wil.data, ID != "AR-364_DOMES_2016-03-10_S_T0")


env.end<- 29 #FOR SPECEIS
sp.start<-30 #FOR SPECIES

env_data.structural <- structural.data[,1:env.end]
env_data.structural.fall <- fall.structural.data [,1:env.end]
env_data.structural.winter <- winter.structural.data [,1:env.end]
env_data.structural.spring <- spring.structural.data [,1:env.end]
env_data.fall.MHC <- fall.MHC.data[,1:env.end]
env_data.fall.wil <-fall.wil.data[,1:env.end]
env_data.winter.MHC <-winter.MHC.data[,1:env.end]
env_data.winter.wil <-winter.wil.data[,1:env.end] 
env_data.spring.MHC <-spring.MHC.data[,1:env.end] 
env_data.spring.wil <-spring.wil.data[,1:env.end]

 
species.data.structural <-structural.data[,sp.start:ncol(structural.data)] # fish data
species.orig.structural <-species.data.structural # fish data, no transform
species.data.structural.fall <-fall.structural.data[,sp.start:ncol(fall.structural.data)] # fish data
species.orig.structural.fall <-species.data.structural.fall # fish data, no transform
species.data.structural.winter <-winter.structural.data[,sp.start:ncol(winter.structural.data)] # fish data
species.orig.structural.winter <-species.data.structural.winter # fish data, no transform
species.data.structural.spring <-spring.structural.data[,sp.start:ncol(spring.structural.data)] # fish data
species.orig.structural.spring <-species.data.structural.spring # fish data, no transform

species.data.structural.fall.MHC <-fall.MHC.data[,sp.start:ncol(fall.MHC.data)] # fish data
species.orig.structural.fall.MHC <-species.data.structural.fall.MHC # fish data, no transform
species.data.structural.fall.wil <-fall.wil.data[,sp.start:ncol(fall.wil.data)] # fish data
species.orig.structural.fall.wil <-species.data.structural.fall.wil # fish data, no transform
species.data.structural.winter.MHC <-winter.MHC.data[,sp.start:ncol(winter.MHC.data)] # fish data
species.orig.structural.winter.MHC <-species.data.structural.winter.MHC # fish data, no transform
species.data.structural.winter.wil <-winter.wil.data[,sp.start:ncol(winter.wil.data)] # fish data
species.orig.structural.winter.wil <-species.data.structural.winter.wil # fish data, no transform
species.data.structural.spring.MHC <-spring.MHC.data[,sp.start:ncol(spring.MHC.data)] # fish data
species.orig.structural.spring.MHC <-species.data.structural.spring.MHC # fish data, no transform
species.data.structural.spring.wil <-spring.wil.data[,sp.start:ncol(spring.wil.data)] # fish data
species.orig.structural.spring.wil <-species.data.structural.spring.wil # fish data, no transform


species.data.structural <- transform_data (data = species.data.structural, transform_type = "cube_root")
species.data.structural.fall <- transform_data (data = species.data.structural.fall, transform_type = "cube_root")
species.data.structural.winter <- transform_data (data = species.data.structural.winter, transform_type = "cube_root")
species.data.structural.spring <- transform_data (data = species.data.structural.spring, transform_type = "cube_root")

species.data.structural.fall.MHC <-transform_data (data = species.data.structural.fall.MHC, transform_type = "cube_root")
species.data.structural.fall.wil <-transform_data (data = species.data.structural.fall.wil, transform_type = "cube_root")
species.data.structural.winter.MHC <- transform_data (data = species.data.structural.winter.MHC, transform_type = "cube_root") 
species.data.structural.winter.wil <- transform_data (data = species.data.structural.winter.wil, transform_type = "cube_root") 
species.data.structural.spring.MHC <-transform_data (data = species.data.structural.spring.MHC, transform_type = "cube_root") 
species.data.structural.spring.wil <- transform_data (data = species.data.structural.spring.wil, transform_type = "cube_root")

set.seed(318) # for reproducibility
species.bcd<-bcdist(species.data.structural, rmzero=FALSE) # build distance matrix based on bray curtis
species.bcd.fall <-bcdist(species.data.structural.fall, rmzero=FALSE) # build distance matrix based on bray curtis
species.bcd.winter <-bcdist(species.data.structural.winter, rmzero=FALSE) # build distance matrix based on bray curtis
species.bcd.spring <-bcdist(species.data.structural.spring, rmzero=FALSE) # build distance matrix based on bray curtis

bcd.fall.MHC <- bcdist(species.data.structural.fall.MHC, rmzero=FALSE) 
bcd.fall.wil <- bcdist(species.data.structural.fall.wil, rmzero=FALSE) 
bcd.winter.MHC<- bcdist(species.data.structural.winter.MHC, rmzero=FALSE) 
bcd.winter.wil<- bcdist(species.data.structural.winter.wil, rmzero=FALSE) 
bcd.spring.MHC<- bcdist(species.data.structural.spring.MHC, rmzero=FALSE) 
bcd.spring.wil<- bcdist(species.data.structural.spring.wil, rmzero=FALSE) 


species.bcd_df <- as.matrix(species.bcd)
species.bcd_df.fall <- as.matrix(species.bcd.fall)
species.bcd_df.winter <- as.matrix(species.bcd.winter)
species.bcd_df.spring <- as.matrix(species.bcd.spring)

bcd.fall.MHC <-  as.matrix(bcd.fall.MHC)
bcd.fall.wil <- as.matrix(bcd.fall.wil)
bcd.winter.MHC<-  as.matrix(bcd.winter.MHC)
bcd.winter.wil<- as.matrix(bcd.winter.wil)
bcd.spring.MHC<-  as.matrix(bcd.spring.MHC)
bcd.spring.wil<- as.matrix(bcd.spring.wil)

######################################################################################3

distance <- read.csv ("Distance/dive_pts_distance_to_other_dive_pts_ft.csv") #
distance.matrix <- as.matrix(distance[,2:4])
distance.matrix <- as.data.frame(distance.matrix)
distance.codes <-as.matrix(sites[,c(1,2,13)]) 
distance.codes <- as.data.frame(distance.codes)

library (dplyr)
#for all
half.species.bcd <- matrix(nrow=nrow(species.bcd_df), ncol=nrow(species.bcd_df))
 j=1  # j is "outer loop" counter (columns); begin at 1
  for (j in 1:nrow(species.bcd_df)) {
    i=1  # i is "inner loop" counter (rows)
    for (i in 1:nrow(species.bcd_df)) {
      if (i<=j) {
        half.species.bcd[i,j] <- "NA" # writes NA values to matrix c by row i and col j
        i=i+1
      }
      else {
        half.species.bcd[i,j] <- species.bcd_df[i,j] 
      }
      i=i+1
    }  
    j=j+1
  }
 
env.species.bcd <- cbind(env_data.structural [,1:7], half.species.bcd)
env.species.bcd <- as.data.frame(env.species.bcd)

env.species.bcd$Site <- as.character(env.species.bcd$Site)
env.species.bcd$Subsite <- as.character(env.species.bcd$Subsite)



#For FALL

half.species.bcd.fall <- matrix(nrow=nrow(species.bcd_df.fall), ncol=nrow(species.bcd_df.fall))
 j=1  # j is "outer loop" counter (columns); begin at 1
  for (j in 1:nrow(species.bcd_df.fall)) {
    i=1  # i is "inner loop" counter (rows)
    for (i in 1:nrow(species.bcd_df.fall)) {
      if (i<=j) {
        half.species.bcd.fall[i,j] <- "NA" # writes NA values to matrix c by row i and col j
        i=i+1
      }
      else {
        half.species.bcd.fall[i,j] <- species.bcd_df.fall[i,j] 
      }
      i=i+1
    }  
    j=j+1
  }
 
env.species.bcd.fall <- cbind(env_data.structural.fall [,1:7], half.species.bcd.fall)
env.species.bcd.fall <- as.data.frame(env.species.bcd.fall)

env.species.bcd.fall$Site <- as.character(env.species.bcd.fall$Site)
env.species.bcd.fall$Subsite <- as.character(env.species.bcd.fall$Subsite)


#fall.MHC
half.fall.MHC <- matrix(nrow=nrow(bcd.fall.MHC), ncol=nrow(bcd.fall.MHC))
 j=1  # j is "outer loop" counter (columns); begin at 1
  for (j in 1:nrow(bcd.fall.MHC)) {
    i=1  # i is "inner loop" counter (rows)
    for (i in 1:nrow(bcd.fall.MHC)) {
      if (i<=j) {
        half.fall.MHC[i,j] <- "NA" # writes NA values to matrix c by row i and col j
        i=i+1
      }
      else {
        half.fall.MHC[i,j] <- bcd.fall.MHC[i,j] 
      }
      i=i+1
    }  
    j=j+1
  }
 
env.bcd.fall.MHC <- cbind(env_data.fall.MHC [,1:7], half.fall.MHC)
env.bcd.fall.MHC <- as.data.frame(env.bcd.fall.MHC)

env.bcd.fall.MHC$Site <- as.character(env.bcd.fall.MHC$Site)
env.bcd.fall.MHC$Subsite <- as.character(env.bcd.fall.MHC$Subsite)


#fall.wil
half.fall.wil <- matrix(nrow=nrow(bcd.fall.wil), ncol=nrow(bcd.fall.wil))
 j=1  # j is "outer loop" counter (columns); begin at 1
  for (j in 1:nrow(bcd.fall.wil)) {
    i=1  # i is "inner loop" counter (rows)
    for (i in 1:nrow(bcd.fall.wil)) {
      if (i<=j) {
        half.fall.wil[i,j] <- "NA" # writes NA values to matrix c by row i and col j
        i=i+1
      }
      else {
        half.fall.wil[i,j] <- bcd.fall.wil[i,j] 
      }
      i=i+1
    }  
    j=j+1
  }
 
env.bcd.fall.wil <- cbind(env_data.fall.wil [,1:7], half.fall.wil)
env.bcd.fall.wil <- as.data.frame(env.bcd.fall.wil)

env.bcd.fall.wil$Site <- as.character(env.bcd.fall.wil$Site)
env.bcd.fall.wil$Subsite <- as.character(env.bcd.fall.wil$Subsite)


#winter.MHC
half.winter.MHC <- matrix(nrow=nrow(bcd.winter.MHC), ncol=nrow(bcd.winter.MHC))
 j=1  # j is "outer loop" counter (columns); begin at 1
  for (j in 1:nrow(bcd.winter.MHC)) {
    i=1  # i is "inner loop" counter (rows)
    for (i in 1:nrow(bcd.winter.MHC)) {
      if (i<=j) {
        half.winter.MHC[i,j] <- "NA" # writes NA values to matrix c by row i and col j
        i=i+1
      }
      else {
        half.winter.MHC[i,j] <- bcd.winter.MHC[i,j] 
      }
      i=i+1
    }  
    j=j+1
  }
 
env.bcd.winter.MHC <- cbind(env_data.winter.MHC [,1:7], half.winter.MHC)
env.bcd.winter.MHC <- as.data.frame(env.bcd.winter.MHC)

env.bcd.winter.MHC$Site <- as.character(env.bcd.winter.MHC$Site)
env.bcd.winter.MHC$Subsite <- as.character(env.bcd.winter.MHC$Subsite)


#winter.wil
half.winter.wil <- matrix(nrow=nrow(bcd.winter.wil), ncol=nrow(bcd.winter.wil))
 j=1  # j is "outer loop" counter (columns); begin at 1
  for (j in 1:nrow(bcd.winter.wil)) {
    i=1  # i is "inner loop" counter (rows)
    for (i in 1:nrow(bcd.winter.wil)) {
      if (i<=j) {
       half.winter.wil[i,j] <- "NA" # writes NA values to matrix c by row i and col j
        i=i+1
      }
      else {
        half.winter.wil[i,j] <- bcd.winter.wil[i,j] 
      }
      i=i+1
    }  
    j=j+1
  }
 
env.bcd.winter.wil<- cbind(env_data.winter.wil [,1:7], half.winter.wil)
env.bcd.winter.wil<- as.data.frame(env.bcd.winter.wil)

env.bcd.winter.wil$Site <- as.character(env.bcd.winter.wil$Site)
env.bcd.winter.wil$Subsite <- as.character(env.bcd.winter.wil$Subsite)


#spring.MHC
half.spring.MHC <- matrix(nrow=nrow(bcd.spring.MHC), ncol=nrow(bcd.spring.MHC))
 j=1  # j is "outer loop" counter (columns); begin at 1
  for (j in 1:nrow(bcd.spring.MHC)) {
    i=1  # i is "inner loop" counter (rows)
    for (i in 1:nrow(bcd.spring.MHC)) {
      if (i<=j) {
        half.spring.MHC[i,j] <- "NA" # writes NA values to matrix c by row i and col j
        i=i+1
      }
      else {
        half.spring.MHC[i,j] <- bcd.spring.MHC[i,j] 
      }
      i=i+1
    }  
    j=j+1
  }
 
env.bcd.spring.MHC <- cbind(env_data.spring.MHC [,1:7], half.spring.MHC)
env.bcd.spring.MHC <- as.data.frame(env.bcd.spring.MHC)

env.bcd.spring.MHC$Site <- as.character(env.bcd.spring.MHC$Site)
env.bcd.spring.MHC$Subsite <- as.character(env.bcd.spring.MHC$Subsite)


#spring.wil
half.spring.wil <- matrix(nrow=nrow(bcd.spring.wil), ncol=nrow(bcd.spring.wil))
 j=1  # j is "outer loop" counter (columns); begin at 1
  for (j in 1:nrow(bcd.spring.wil)) {
    i=1  # i is "inner loop" counter (rows)
    for (i in 1:nrow(bcd.spring.wil)) {
      if (i<=j) {
        half.spring.wil[i,j] <- "NA" # writes NA values to matrix c by row i and col j
        i=i+1
      }
      else {
        half.spring.wil[i,j] <- bcd.spring.wil[i,j] 
      }
      i=i+1
    }  
    j=j+1
  }
 
env.bcd.spring.wil<- cbind(env_data.spring.wil [,1:7], half.spring.wil)
env.bcd.spring.wil <- as.data.frame(env.bcd.spring.wil)

env.bcd.spring.wil$Site <- as.character(env.bcd.spring.wil$Site)
env.bcd.spring.wil$Subsite <- as.character(env.bcd.spring.wil$Subsite)

                   
```

```{r BCD_function}

library (dplyr)

#data <- env.species.bcd.fall # name data simply

#out<-calc_bcd_dist_matrix(data=env.species.bcd.fall) # where you use the function 


# this is the function called calc_bcd_dist_matrix that puts sites and their dissimilarities and distances in a pretty matrix
calc_bcd_dist_matrix <- function(data){
site_subsite <- paste(data$Site, data$Subsite, sep = "_") # identify unique site and subsite combinations
uniq <- unique(unlist(site_subsite))  # saves unique site and subsite combinations as object called 'uniq' so that can use them in the loop below for counting purposes

# Make data frame to store results of outlier detection
results <- data.frame(site_in = character(), subsite_in = character(), id_in = character(), site_far = character(), subsite_far = character(), id_far = character(), dist = integer(), dissim = integer())

p=1 # p is the counter, initialize it at 1, represents number of uniq site and subsite combinations
  for (p in 1:length(uniq)){
    ## In site
      a <- rep(data[p,2], nrow(data)) # in site
      b <- rep(data[p,3], nrow(data)) # in subsite
      IN <- cbind(a,b)
    ## Far site
      NEAR <- data[,2:3] # always the second (site) and thrid (subsite) columns of data, just repeated, for the far
    ## Dissimilarity
      DISS <- data[,p+7] # dissimilarity value is always in the column of p + 7
    ##Sampling_Period  
      Sampling_Period <- data[,6]
    ## Combine results    
      combo <- cbind(IN, NEAR, Sampling_Period, DISS)
      results <- rbind(results, combo)
    p=p+1
    }

# if need to reset, use these two lines of code
# p <- NULL
# results <- NULL

IN <- results[,1:2]

IN <- as.data.frame(IN)
colnames(IN) <- c("Site", "Subsite")

joining1 <- join(IN, distance.codes, by = c("Site", "Subsite"))

colnames(joining1) <- c("IN_Site", "IN_Subsite", "IN_FID")
joining1$IN_FID <- as.character (joining1$IN_FID)

NEAR <- results[,3:4] 
NEAR <-as.data.frame(NEAR)
colnames(NEAR) <- c("Site", "Subsite")

joining2 <- join(NEAR, distance.codes, by = c("Site", "Subsite"))
colnames(joining2)<- c("NEAR_Site", "NEAR_Subsite", "NEAR_FID")
joining2$NEAR_FID <- as.character(joining2$NEAR_FID)

DISS <- results[,6]
DISS <- as.data.frame(DISS) 
colnames(DISS) <- "BCD"

Sampling_Period <- results [,5]
Sampling_Period <- as.data.frame(Sampling_Period)
colnames (Sampling_Period) <- "Sampling_Period"
#INhelp <- joining1[,3]
#INhelp <- as.data.frame(INhelp)
#colnames(INhelp) <- c("IN_FID")


#NEARhelp <- joining2[,3]
#NEARhelp <- as.data.frame(NEARhelp)
#colnames(NEARhelp) <- c("NEAR_FID")

#omg$IN_FID <- as.numeric(omg$IN_FID)
#omg$NEAR_FID <- as.numeric(omg$NEAR_FID)
#distance.matrix$IN_FID <- as.numeric(distance.matrix$IN_FID)
#distance.matrix$NEAR_FID <- as.numeric(distance.matrix$NEAR_FID)
#distance.matrix$NEAR_DIST <- as.character(distance.matrix$NEAR_DIST)

#omg <- cbind(INhelp, NEARhelp)
#cookie <- join(distance.matrix, omg, by = c("IN_FID", "NEAR_FID"))
#poop <- join(omg, distance.matrix, by = c("IN_FID", "NEAR_FID"))

#IN.NEAR.diss$IN_FID <- as.numeric(IN.NEAR.diss$IN_FID)
#IN.NEAR.diss$NEAR_FID <- as.numeric(IN.NEAR.diss$NEAR_FID)
distance.matrix$IN_FID <- as.numeric(distance.matrix$IN_FID)
distance.matrix$NEAR_FID <- as.numeric(distance.matrix$NEAR_FID)
distance.matrix$NEAR_DIST <- as.character(distance.matrix$NEAR_DIST)


IN.NEAR.DISS <- cbind(joining1, joining2, Sampling_Period, DISS)
IN.NEAR.DISS$IN_FID <- as.numeric(IN.NEAR.DISS$IN_FID)
IN.NEAR.DISS$NEAR_FID <- as.numeric(IN.NEAR.DISS$NEAR_FID)

dist.IN.NEAR.DISS <- join(IN.NEAR.DISS, distance.matrix, by = c ("IN_FID", "NEAR_FID"))
#dist.IN.NEAR.diss <- join(distance.matrix, IN.NEAR.diss, by = c("IN_FID", "NEAR_FID"))
#heeeelp <- filter(dist.IN.NEAR.diss, IN_Site != 'NA')
dist.IN.NEAR.DISS
}

all.species <-calc_bcd_dist_matrix(data=env.species.bcd)
fall.MHC<-calc_bcd_dist_matrix(data=env.bcd.fall.MHC) # where you use the function 
fall.wil<-calc_bcd_dist_matrix(data=env.bcd.fall.wil) # where you use the function 
winter.MHC<-calc_bcd_dist_matrix(data=env.bcd.winter.MHC) # where you use the function 
winter.wil<-calc_bcd_dist_matrix(data=env.bcd.winter.wil) # where you use the function 
spring.MHC<-calc_bcd_dist_matrix(data=env.bcd.spring.MHC) # where you use the function 
spring.wil<-calc_bcd_dist_matrix(data=env.bcd.spring.wil) # where you use the function 


```

```{r BCD_filter}

all.species.f <- filter(all.species, BCD != 'NA')
all.species.f <- filter(all.species.f, NEAR_DIST != 'NA')
all.species.f$BCD <- as.character(all.species.f$BCD)
all.species.f$BCD <- as.numeric(all.species.f$BCD)
all.species.f$NEAR_DIST <- as.numeric(all.species.f$NEAR_DIST)
#all.species.f <- mutate(all.species.f, NEAR_DIST_nautical = NEAR_DIST / 6076.12) #nautical miles
all.species.f <- mutate(all.species.f, NEAR_DIST_km = NEAR_DIST/3280.84)#km

fall.MHC.f <- filter(fall.MHC, BCD != 'NA')
fall.MHC.f <- filter(fall.MHC.f, NEAR_DIST != 'NA')
fall.MHC.f$BCD <- as.character(fall.MHC.f$BCD)
fall.MHC.f$BCD <- as.numeric(fall.MHC.f$BCD)
fall.MHC.f$NEAR_DIST <- as.numeric(fall.MHC.f$NEAR_DIST)
#fall.MHC.f <- mutate(fall.MHC.f, NEAR_DIST_nautical = NEAR_DIST / 6076.12) #nautical miles
fall.MHC.f <- mutate(fall.MHC.f, NEAR_DIST_km = NEAR_DIST / 3280.84) #km

fall.wil.f<- filter(fall.wil, BCD != 'NA')
fall.wil.f <- filter(fall.wil.f, NEAR_DIST != 'NA')
fall.wil.f$BCD <- as.character(fall.wil.f$BCD)
fall.wil.f$BCD <- as.numeric(fall.wil.f$BCD)
fall.wil.f$NEAR_DIST <- as.numeric(fall.wil.f$NEAR_DIST)
#fall.wil.f <- mutate(fall.wil.f, NEAR_DIST_nautical = NEAR_DIST / 6076.12) #nautical miles
fall.wil.f <- mutate(fall.wil.f, NEAR_DIST_km = NEAR_DIST / 3280.84) #km

winter.MHC.f<- filter(winter.MHC, BCD != 'NA')
winter.MHC.f <- filter(winter.MHC.f, NEAR_DIST != 'NA')
winter.MHC.f$BCD <- as.character(winter.MHC.f$BCD)
winter.MHC.f$BCD <- as.numeric(winter.MHC.f$BCD)
winter.MHC.f$NEAR_DIST <- as.numeric(winter.MHC.f$NEAR_DIST)
#winter.MHC.f <- mutate(winter.MHC.f, NEAR_DIST_nautical = NEAR_DIST / 6076.12) #nautical miles
winter.MHC.f <- mutate(winter.MHC.f, NEAR_DIST_km = NEAR_DIST / 3280.84) #km

winter.wil.f<- filter(winter.wil, BCD != 'NA')
winter.wil.f <- filter(winter.wil.f, NEAR_DIST != 'NA')
winter.wil.f$BCD <- as.character(winter.wil.f$BCD)
winter.wil.f$BCD <- as.numeric(winter.wil.f$BCD)
winter.wil.f$NEAR_DIST <- as.numeric(winter.wil.f$NEAR_DIST)
#winter.wil.f <- mutate(winter.wil.f, NEAR_DIST_nautical = NEAR_DIST / 6076.12) #nautical miles
winter.wil.f <- mutate(winter.wil.f, NEAR_DIST_km = NEAR_DIST / 3280.84) #km

spring.MHC.f<- filter(spring.MHC, BCD != 'NA')
spring.MHC.f <- filter(spring.MHC.f, NEAR_DIST != 'NA')
spring.MHC.f$BCD <- as.character(spring.MHC.f$BCD)
spring.MHC.f$BCD <- as.numeric(spring.MHC.f$BCD)
spring.MHC.f$NEAR_DIST <- as.numeric(spring.MHC.f$NEAR_DIST)
#spring.MHC.f <- mutate(spring.MHC.f, NEAR_DIST_nautical = NEAR_DIST / 6076.12) #nautical miles
spring.MHC.f <- mutate(spring.MHC.f, NEAR_DIST_km = NEAR_DIST / 3280.84) #km

spring.wil.f<- filter(spring.wil, BCD != 'NA')
spring.wil.f <- filter(spring.wil.f, NEAR_DIST != 'NA')
spring.wil.f$BCD <- as.character(spring.wil.f$BCD)
spring.wil.f$BCD <- as.numeric(spring.wil.f$BCD)
spring.wil.f$NEAR_DIST <- as.numeric(spring.wil.f$NEAR_DIST)
#spring.wil.f <- mutate(spring.wil.f, NEAR_DIST_nautical = NEAR_DIST / 6076.12) #nautical miles
spring.wil.f <- mutate(spring.wil.f, NEAR_DIST_km = NEAR_DIST / 3280.84) #km

#filter by site

site330.fall <- filter(fall.MHC.f, IN_Site == '330' & NEAR_Site == '330')
site330.winter <- filter(winter.MHC.f, IN_Site == '330' & NEAR_Site == '330')
site330.spring <- filter(spring.MHC.f, IN_Site == '330' & NEAR_Site == '330')

site345.fall <- filter(fall.MHC.f, IN_Site == '345' & NEAR_Site == '345')
site345.winter<- filter(winter.MHC.f, IN_Site == '345' & NEAR_Site == '345')
site345.spring <- filter(spring.MHC.f, IN_Site == '345' & NEAR_Site == '345')

site364.fall<- filter(fall.wil.f, IN_Site == '364' & NEAR_Site == '364')
site364.winter<- filter(winter.wil.f, IN_Site == '364' & NEAR_Site == '364')
site364.spring<- filter(spring.wil.f, IN_Site == '364' & NEAR_Site == '364')

site370.fall<- filter(fall.wil.f, IN_Site == '370' & NEAR_Site == '370')
site370.winter<- filter(winter.wil.f, IN_Site == '370' & NEAR_Site == '370')
site370.spring<- filter(spring.wil.f, IN_Site == '370' & NEAR_Site == '370')

site372.fall<- filter(fall.wil.f, IN_Site == '372' & NEAR_Site == '372')
site372.winter<- filter(winter.wil.f, IN_Site == '372' & NEAR_Site == '372')
site372.spring<- filter(spring.wil.f, IN_Site == '372' & NEAR_Site == '372')

site378.fall<- filter(fall.wil.f, IN_Site == '378' & NEAR_Site == '378')
site378.winter<- filter(winter.wil.f, IN_Site == '378' & NEAR_Site == '378')
site378.spring<- filter(spring.wil.f, IN_Site == '378' & NEAR_Site == '378')

#combine MHC
MHC <- rbind(fall.MHC.f, winter.MHC.f, spring.MHC.f)

#combine wil
wil <- rbind(fall.wil.f, winter.wil.f, spring.wil.f)

```

```{r BCD_plot}
library(ggplot2)
#test1$Sampling_Period <- factor(test1$Sampling_Period, c("Fall", "Winter", "Spring"))

#all by season
all.species.f$Sampling_Period <- factor(all.species.f$Sampling_Period, c("Fall", "Winter", "Spring"))
plot.all = ggplot(all.species.f, aes(x=as.numeric(NEAR_DIST_km), y=as.numeric(BCD))) 

plot.all + 
  theme_classic()+
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="bottom", 
        axis.line.x = element_line(color="black", size = 0.5), 
        axis.line.y = element_line(color="black", size = 0.5))+
scale_colour_discrete(name = "Season", breaks=c("Fall","Winter","Spring"))+
geom_point (aes(colour = Sampling_Period)) + 
  scale_y_continuous(name="Bray Curtis Dissimilarity", limits=c(0, 1), breaks=seq(0, 1, by=0.2)) +
  scale_x_continuous(name = "Distance (km)", limits=c(0, 120), breaks=seq(0, 120,by=20)) + geom_smooth(aes(colour = Sampling_Period))+
  ggtitle("Bray Curtis Dissimilarty between Sites by Distance by Season")
#all

plot.all.ggplot = ggplot(all.species.f, aes(x=as.numeric(NEAR_DIST_km), y=as.numeric(BCD))) 


plot.all.ggplot + 
  theme_classic()+
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="none", 
        axis.line.x = element_line(color="black", size = 0.5), 
        axis.line.y = element_line(color="black", size = 0.5))+
geom_point (colour = "grey") + 
  scale_y_continuous(name="Bray Curtis Dissimilarity", limits=c(0, 1), breaks=seq(0, 1, by=0.2)) +
  scale_x_continuous(name = "Distance (km)", limits=c(0, 120), breaks=seq(0, 120,by=20)) + geom_smooth(colour = "black")+
  ggtitle("Bray Curtis Dissimilarty between Sites by Distance")

###########################################################################################3

#fall.MHC
plot.fall.MHC = ggplot(fall.MHC.f, aes(x=as.numeric(NEAR_DIST_km), y=as.numeric(BCD))) 

plot.fall.MHC + geom_point () +theme_classic () +  scale_y_continuous(name="Bray Curtis Dissimilarity", limits=c(0, 1), breaks=seq(0, 1, by=0.1)) + scale_x_continuous(name = "Distance (km)", limits=c(0, 15), breaks=seq(0, 15,by=1))

#fall.wil
plot.fall.wil = ggplot(fall.wil.f, aes(x=as.numeric(NEAR_DIST_km), y=as.numeric(BCD))) 

plot.fall.wil + geom_point () +theme_classic () +  scale_y_continuous(name="Bray Curtis Dissimilarity", limits=c(0, 1), breaks=seq(0, 1, by=0.1)) + scale_x_continuous(name = "Distance (km)", limits=c(0, 30), breaks=seq(0, 30,by=5)) + geom_smooth()

#winter.MHC
plot.winter.MHC = ggplot(winter.MHC.f, aes(x=as.numeric(NEAR_DIST_km), y=as.numeric(BCD))) 

plot.winter.MHC + geom_point () +theme_classic () +  scale_y_continuous(name="Bray Curtis Dissimilarity", limits=c(0, 1), breaks=seq(0, 1, by=0.05)) + scale_x_continuous(name = "Distance (km)", limits=c(0, 15), breaks=seq(0, 15,by=1))

#winter.wil
plot.winter.wil = ggplot(winter.wil.f, aes(x=as.numeric(NEAR_DIST_km), y=as.numeric(BCD))) 

plot.winter.wil + geom_point () +theme_classic () +  scale_y_continuous(name="Bray Curtis Dissimilarity", limits=c(0, 1), breaks=seq(0, 1, by=0.1)) + scale_x_continuous(name = "Distance (km)", limits=c(0, 30), breaks=seq(0, 30,by=5)) + geom_smooth()

#spring MHC
plot.spring.MHC = ggplot(spring.MHC.f, aes(x=as.numeric(NEAR_DIST_km), y=as.numeric(BCD))) 

plot.spring.MHC + geom_point () +theme_classic () +  scale_y_continuous(name="Bray Curtis Dissimilarity", limits=c(0, 1), breaks=seq(0, 1, by=0.1)) + scale_x_continuous(name = "Distance (km)", limits=c(0, 15), breaks=seq(0, 15,by=1))

#spring wil
plot.spring.wil = ggplot(spring.wil.f, aes(x=as.numeric(NEAR_DIST_km), y=as.numeric(BCD))) 

plot.spring.wil + geom_point () +theme_classic () +  scale_y_continuous(name="Bray Curtis Dissimilarity", limits=c(0, 1), breaks=seq(0, 1, by=0.1)) + scale_x_continuous(name = "Distance (km)", limits=c(0, 30), breaks=seq(0, 30,by=5)) + geom_smooth()

#MHC
plot.MHC = ggplot(MHC, aes(x=as.numeric(NEAR_DIST_km), y=as.numeric(BCD))) 

plot.MHC + geom_point (aes(colour = Sampling_Period)) +theme_classic () +  scale_y_continuous(name="Bray Curtis Dissimilarity", limits=c(0, 1), breaks=seq(0, 1, by=0.1)) + scale_x_continuous(name = "Distance (km)", limits=c(0, 15), breaks=seq(0, 15,by=1)) 

#wil
plot.wil = ggplot(wil, aes(x=as.numeric(NEAR_DIST_km), y=as.numeric(BCD))) 

plot.wil + geom_point (aes(colour = Sampling_Period)) +theme_classic () +  scale_y_continuous(name="Bray Curtis Dissimilarity", limits=c(0, 1), breaks=seq(0, 1, by=0.05)) + scale_x_continuous(name = "Distance (km)", limits=c(0, 30), breaks=seq(0, 30,by=5)) + geom_smooth(aes(colour = Sampling_Period))

#330 fall
plot.330.fall = ggplot(site330.fall, aes(x=as.numeric(NEAR_DIST_km), y=as.numeric(BCD))) 

plot.330.fall + geom_point () +theme_classic () +  scale_y_continuous(name="Bray Curtis Dissimilarity", limits=c(0, 1), breaks=seq(0, 1, by=0.05)) + scale_x_continuous(name = "Distance (km)", limits=c(0, 1), breaks=seq(0, 1,by=0.1))  + ggtitle("330 Fall")


#330.winter* shows pattern
plot.330.winter = ggplot(site330.winter, aes(x=as.numeric(NEAR_DIST_km), y=as.numeric(BCD))) 

plot.330.winter + geom_point () +theme_classic () +  scale_y_continuous(name="Bray Curtis Dissimilarity", limits=c(0, 1), breaks=seq(0, 1, by=0.05)) + scale_x_continuous(name = "Distance (km)", limits=c(0, 1), breaks=seq(0, 1,by=0.1))  +ggtitle("330 Winter")


#345 fall*kinda shows pattern
plot.345.fall = ggplot(site345.fall, aes(x=as.numeric(NEAR_DIST_km), y=as.numeric(BCD))) 

plot.345.fall + geom_point () +theme_classic () +  scale_y_continuous(name="Bray Curtis Dissimilarity", limits=c(0, 1), breaks=seq(0, 1, by=0.05)) + scale_x_continuous(name = "Distance (km)", limits=c(0, 1), breaks=seq(0, 1,by=0.1)) + ggtitle("345 Fall")


#345 spring
plot.345.spring = ggplot(site345.spring, aes(x=as.numeric(NEAR_DIST_km), y=as.numeric(BCD))) 

plot.345.spring + geom_point () +theme_classic () +  scale_y_continuous(name="Bray Curtis Dissimilarity", limits=c(0, 1), breaks=seq(0, 1, by=0.05)) + scale_x_continuous(name = "Distance (km)", limits=c(0, 1), breaks=seq(0, 1,by=0.1))  + ggtitle("330 Fall") + geom_smooth(method= "lm")

#364 fall*shows pattern###############################################################
plot.364.fall = ggplot(site364.fall, aes(x=as.numeric(NEAR_DIST_km), y=as.numeric(BCD))) 

plot.364.fall + geom_point () +theme_classic () +  scale_y_continuous(name="Bray Curtis Dissimilarity", limits=c(0, 1), breaks=seq(0, 1, by=0.1)) + scale_x_continuous(name = "Distance (km)", limits=c(0, 0.6), breaks=seq(0, 0.6,by=0.1)) + ggtitle("364 Fall")

#364 spring- affected by pods
plot.364.spring = ggplot(site364.spring, aes(x=as.numeric(NEAR_DIST_km), y=as.numeric(BCD))) 

plot.364.spring + geom_point () +theme_classic () +  scale_y_continuous(name="Bray Curtis Dissimilarity", limits=c(0, 1), breaks=seq(0, 1, by=0.05)) + scale_x_continuous(name = "Distance (km)", limits=c(0, 1), breaks=seq(0, 1,by=0.1)) + ggtitle("364 Spring")

#364 winter *shows interesting pattern##############################################
plot.364.winter = ggplot(site364.winter, aes(x=as.numeric(NEAR_DIST_km), y=as.numeric(BCD))) 

plot.364.winter + geom_point () +theme_classic () +  scale_y_continuous(name="Bray Curtis Dissimilarity", limits=c(0, 1), breaks=seq(0, 1, by=0.1)) + scale_x_continuous(name = "Distance (km)", limits=c(0, 0.6), breaks=seq(0, 0.6,by=0.1)) + ggtitle("364 Winter") 

#370 fall*shows interesting pattern
plot.370.fall = ggplot(site370.fall, aes(x=as.numeric(NEAR_DIST_km), y=as.numeric(BCD))) 

plot.370.fall + geom_point () +theme_classic () +  scale_y_continuous(name="Bray Curtis Dissimilarity", limits=c(0, 1), breaks=seq(0, 1, by=0.1)) + scale_x_continuous(name = "Distance (km)", limits=c(0, 1.5), breaks=seq(0, 1.5,by=0.1)) + ggtitle("370 Fall") 

#370 spring- affected by pod surveys
plot.370.spring = ggplot(site370.spring, aes(x=as.numeric(NEAR_DIST_km), y=as.numeric(BCD))) 

plot.370.spring + geom_point () +theme_classic () +  scale_y_continuous(name="Bray Curtis Dissimilarity", limits=c(0, 1), breaks=seq(0, 1, by=0.05)) + scale_x_continuous(name = "Distance (km)", limits=c(0, 1.5), breaks=seq(0, 1.5,by=0.1)) + ggtitle("370 Spring") 

#370 winter*shows very strong pattern
plot.370.winter = ggplot(site370.winter, aes(x=as.numeric(NEAR_DIST_km), y=as.numeric(BCD))) 

plot.370.winter + geom_point () +theme_classic () +  scale_y_continuous(name="Bray Curtis Dissimilarity", limits=c(0, 1), breaks=seq(0, 1, by=0.1)) + scale_x_continuous(name = "Distance (km)", limits=c(0, 1.5), breaks=seq(0, 1.5,by=0.1)) + ggtitle("370 Winter") 

#372 fall
plot.372.fall = ggplot(site372.fall, aes(x=as.numeric(NEAR_DIST_km), y=as.numeric(BCD))) 

plot.372.fall + geom_point () +theme_classic () +  scale_y_continuous(name="Bray Curtis Dissimilarity", limits=c(0, 1), breaks=seq(0, 1, by=0.05)) + scale_x_continuous(name = "Distance (km)", limits=c(0, 1), breaks=seq(0, 1,by=0.1)) + ggtitle("372 Fall") 

#372 winter
plot.372.winter = ggplot(site372.winter, aes(x=as.numeric(NEAR_DIST_km), y=as.numeric(BCD))) 

plot.372.winter + geom_point () +theme_classic () +  scale_y_continuous(name="Bray Curtis Dissimilarity", limits=c(0, 1), breaks=seq(0, 1, by=0.05)) + scale_x_continuous(name = "Distance (km)", limits=c(0, 1), breaks=seq(0, 1,by=0.1)) + ggtitle("372 Winter") #+ geom_smooth(method = "loess")

#372 spring
plot.372.spring = ggplot(site372.spring, aes(x=as.numeric(NEAR_DIST_km), y=as.numeric(BCD))) 

plot.372.spring + geom_point () +theme_classic () +  scale_y_continuous(name="Bray Curtis Dissimilarity", limits=c(0, 1), breaks=seq(0, 1, by=0.1)) + scale_x_continuous(name = "Distance (km)", limits=c(0, 1), breaks=seq(0, 1,by=0.1)) + ggtitle("372 Winter") #+ geom_smooth(method = "loess")

#378 fall
plot.378.fall = ggplot(site378.fall, aes(x=as.numeric(NEAR_DIST_km), y=as.numeric(BCD))) 

plot.378.fall + geom_point () +theme_classic () +  scale_y_continuous(name="Bray Curtis Dissimilarity", limits=c(0, 1), breaks=seq(0, 1, by=0.05)) + scale_x_continuous(name = "Distance (km)", limits=c(0, 1.5), breaks=seq(0, 1.5,by=0.1)) + ggtitle("378 Fall") 

#378 winter
plot.378.winter = ggplot(site378.winter, aes(x=as.numeric(NEAR_DIST_km), y=as.numeric(BCD))) 

plot.378.winter + geom_point () +theme_classic () +  scale_y_continuous(name="Bray Curtis Dissimilarity", limits=c(0, 1), breaks=seq(0, 1, by=0.05)) + scale_x_continuous(name = "Distance (km)", limits=c(0, 1.5), breaks=seq(0, 1.5,by=0.1)) + ggtitle("378 Winter") 

ggplot() +
  
stat_smooth(data = site330.fall, aes(x=NEAR_DIST_km, y=BCD), color = "red", span = 2, se = FALSE)+
stat_smooth(data = site330.winter, aes(x=NEAR_DIST_km, y=BCD), color = "magenta", span = 2, se = FALSE)+
stat_smooth(data = site345.fall, aes(x=NEAR_DIST_km, y=BCD), color = "blue", span = 2, se = FALSE)+
stat_smooth(data = site345.spring, aes(x=NEAR_DIST_km, y=BCD), color = "green", span = 2, se = FALSE)+
stat_smooth(data = site364.fall, aes(x=NEAR_DIST_km, y=BCD), color = "purple", span = 2, se = FALSE)+
stat_smooth(data = site364.spring, aes(x=NEAR_DIST_km, y=BCD), color = "coral", span = 2, se = FALSE)+
stat_smooth(data = site364.winter, aes(x=NEAR_DIST_km, y=BCD), color = "orange", span = 2, se = FALSE)+
stat_smooth(data = site370.fall, aes(x=NEAR_DIST_km, y=BCD), color = "yellow", span = 2, se = FALSE)+
stat_smooth(data = site370.spring, aes(x=NEAR_DIST_km, y=BCD), color = "firebrick", span = 2, se = FALSE)+
stat_smooth(data = site370.winter, aes(x=NEAR_DIST_km, y=BCD), color = "violet", span = 2, se = FALSE)+
stat_smooth(data = site372.fall, aes(x=NEAR_DIST_km, y=BCD), color = "springgreen", span = 2, se = FALSE)+
stat_smooth(data = site372.spring, aes(x=NEAR_DIST_km, y=BCD), color = "steelblue", span = 2, se = FALSE)+
stat_smooth(data = site372.winter, aes(x=NEAR_DIST_km, y=BCD), color = "peachpuff", span = 2, se = FALSE)+
stat_smooth(data = site378.fall, aes(x=NEAR_DIST_km, y=BCD), color = "black", span = 2, se = FALSE)+
stat_smooth(data = site378.winter, aes(x=NEAR_DIST_km, y=BCD), color = "grey", span = 2, se = FALSE)+

theme_classic () +  scale_y_continuous(name="Bray Curtis Dissimilarity", limits=c(0, 1), breaks=seq(0, 1, by=0.05)) + scale_x_continuous(name = "Distance (km)", limits=c(0, 1.5), breaks=seq(0, 1.5,by=0.1)) + ggtitle("All sites, all seasons")

ggplot() +
  
geom_point(data = site330.fall, aes(x=NEAR_DIST_km, y=BCD), color = "red")+
geom_point(data = site330.winter, aes(x=NEAR_DIST_km, y=BCD), color = "magenta")+
geom_point(data = site345.fall, aes(x=NEAR_DIST_km, y=BCD), color = "blue")+
geom_point(data = site345.spring, aes(x=NEAR_DIST_km, y=BCD), color = "green")+
geom_point(data = site364.fall, aes(x=NEAR_DIST_km, y=BCD), color = "purple")+
geom_point(data = site364.spring, aes(x=NEAR_DIST_km, y=BCD), color = "coral")+
geom_point(data = site364.winter, aes(x=NEAR_DIST_km, y=BCD), color = "orange")+
geom_point(data = site370.fall, aes(x=NEAR_DIST_km, y=BCD), color = "yellow")+
geom_point(data = site370.spring, aes(x=NEAR_DIST_km, y=BCD), color = "firebrick")+
geom_point(data = site370.winter, aes(x=NEAR_DIST_km, y=BCD), color = "violet")+
geom_point(data = site372.fall, aes(x=NEAR_DIST_km, y=BCD), color = "springgreen")+
geom_point(data = site372.spring, aes(x=NEAR_DIST_km, y=BCD), color = "steelblue")+
geom_point(data = site372.winter, aes(x=NEAR_DIST_km, y=BCD), color = "peachpuff")+
geom_point(data = site378.fall, aes(x=NEAR_DIST_km, y=BCD), color = "black")+
geom_point(data = site378.winter, aes(x=NEAR_DIST_km, y=BCD), color = "grey")+

theme_classic () +  scale_y_continuous(name="Bray Curtis Dissimilarity", limits=c(0, 1), breaks=seq(0, 1, by=0.05)) + scale_x_continuous(name = "Distance (km)", limits=c(0, 1.5), breaks=seq(0, 1.5,by=0.1)) + ggtitle("All sites, all seasons")

#ggplot() +
  
#geom_point(data = site330.fall, aes(x=NEAR_DIST_nautical, y=BCD), color = "red")+
#geom_point(data = site330.winter, aes(x=NEAR_DIST_nautical, y=BCD), color = "magenta")+
#geom_point(data = site345.fall, aes(x=NEAR_DIST_nautical, y=BCD), color = "blue")+
#geom_point(data = site345.spring, aes(x=NEAR_DIST_nautical, y=BCD), color = "green")+
#geom_point(data = site364.fall, aes(x=NEAR_DIST_nautical, y=BCD), color = "purple")+
#geom_point(data = site364.spring, aes(x=NEAR_DIST_nautical, y=BCD), color = "coral")+
#geom_point(data = site364.winter, aes(x=NEAR_DIST_nautical, y=BCD), color = "orange")+
#geom_point(data = site370.fall, aes(x=NEAR_DIST_nautical, y=BCD), color = "yellow")+
#geom_point(data = site370.spring, aes(x=NEAR_DIST_nautical, y=BCD), color = "firebrick")+
#geom_point(data = site370.winter, aes(x=NEAR_DIST_nautical, y=BCD), color = "violet")+
#geom_point(data = site372.fall, aes(x=NEAR_DIST_nautical, y=BCD), color = "springgreen")+
#geom_point(data = site372.spring, aes(x=NEAR_DIST_nautical, y=BCD), color = "steelblue")+
#geom_point(data = site372.winter, aes(x=NEAR_DIST_nautical, y=BCD), color = "peachpuff")+
#geom_point(data = site378.fall, aes(x=NEAR_DIST_nautical, y=BCD), color = "black")+
#geom_point(data = site378.winter, aes(x=NEAR_DIST_nautical, y=BCD), color = "grey")+

#theme_classic () +  scale_y_continuous(name="Bray Curtis Dissimilarity", limits=c(0, 1), breaks=seq(0, 1, by=0.05)) + scale_x_continuous(name = "Distance (km)", limits=c(0, 0.8), breaks=seq(0, 0.8,by=0.1)) + ggtitle("All sites, all seasons")

#all ones that were used to make curves
#all.points.test <- rbind(site330.fall, site330.winter, site345.spring, site364.fall, site364.spring, site364.winter, site370.winter, site372.winter)

#all ones that were used to make curves
all.points.test <- rbind(site330.fall, site330.winter, site345.fall, site345.spring, site364.fall, site364.spring, site364.winter, site370.fall, site370.spring, site370.winter, site372.fall, site372.winter, site372.spring, site378.fall, site378.winter)




#all, including ones with one one comparison
#all.points.test <- rbind(site330.fall, site330.spring, site345.fall, site345.spring, site364.fall, site364.spring, site364.winter, site370.fall, site370.winter, site372.fall, site372.winter, site372.spring, site378.fall, site378.winter)

#carefully selected
#all.points.test <- rbind(site330.fall, site330.winter, site345.spring, site364.fall, site364.spring, site364.winter, site370.winter, site372.winter)
#carefuly selected with 370.spring
#all.points.test <- rbind(site330.fall, site330.winter, site345.spring, site364.fall, site364.spring, site364.winter, site370.fall, site370.winter, site372.winter)


all.points.test.plot = ggplot(all.points.test, aes(x=as.numeric(NEAR_DIST_km), y=as.numeric(BCD))) 

all.points.test.plot + geom_point () +theme_classic () +  scale_y_continuous(name="Bray Curtis Dissimilarity", limits=c(0, 1), breaks=seq(0, 1, by=0.1)) + scale_x_continuous(name = "Distance (km)", limits=c(0, 1.5), breaks=seq(0, 1.5,by=0.1)) + ggtitle("all points") +
  stat_smooth()
```

```{r BCD_max}
a <- filter(site330.fall, BCD == max(site330.fall$BCD))
b <- filter(site330.spring, BCD == max(site330.spring$BCD))
c <- filter(site330.winter, BCD == max(site330.winter$BCD))
d <- filter(site345.fall, BCD == max(site345.fall$BCD))
e<- filter(site345.spring, BCD == max(site345.spring$BCD))
f<- filter(site345.winter, BCD == max(site345.winter$BCD))
g <-filter(site364.fall, BCD == max(site364.fall$BCD))
h <-filter(site364.spring, BCD == max(site364.spring$BCD))
i <-filter(site364.winter, BCD == max(site364.winter$BCD))
j <-filter(site370.fall, BCD == max(site370.fall$BCD))
k <-filter(site370.spring, BCD == max(site370.spring$BCD))
l <-filter(site370.winter, BCD == max(site370.winter$BCD))
m <-filter(site372.fall, BCD == max(site372.fall$BCD))
n <- filter(site372.spring, BCD == max(site372.spring$BCD))
o<-filter(site372.winter, BCD == max(site372.winter$BCD))
p <- filter(site378.fall, BCD < 1)
p<-filter(p, BCD == max(p$BCD))
#q <-filter(site378.spring, BCD == max(site378.spring$BCD)) #removed because there is nothing to compare
r <- filter(site378.winter, BCD == max(site378.winter$BCD))

findmaxbcd <- rbind(a, b, c, d, e, f, g, h, i, j,k,l,m,n,o,p,r)
avgdist <- ave(findmaxbcd$NEAR_DIST_km)

sedist <- sd(findmaxbcd$NEAR_DIST_km)/sqrt(length(findmaxbcd$NEAR_DIST_km))

avgbcd <- ave(findmaxbcd$BCD)

sebcd <- sd(findmaxbcd$BCD)/sqrt(length(findmaxbcd$BCD))

#s <- filter(fall.MHC.f, BCD == max(fall.MHC.f$BCD))
#t <- filter(fall.wil.f, BCD < 1)
#t <- filter(t, BCD == max(t$BCD))
#u <- filter(winter.MHC.f, BCD == max(winter.MHC.f$BCD))
#v <- filter(winter.wil.f, BCD == max(winter.wil.f$BCD))
#w <- filter(spring.MHC.f, BCD == max(spring.MHC.f$BCD))
#x <- filter(spring.wil.f, BCD == max(spring.wil.f$BCD))

#findmaxbcdmhc <- rbind(s,u,w)
#avgdistmhc <- ave(findmaxbcdmhc$NEAR_DIST_km)

#findmaxbcdwil <- rbind(t,v,x)
#avgdistwil <- ave(findmaxbcdwil$NEAR_DIST_km)

#findmaxbcd2 <- rbind(s,t,u,v,w,x)
#avgdist2 <- ave(findmaxbcd2$NEAR_DIST_km)

uu <- filter(MHC, BCD <1)
hh <- filter(uu, BCD == max(uu$BCD))


gg <- filter(wil, BCD <1)
ff <- filter(gg, BCD == max(gg$BCD))


zz <- filter(all.species.f, BCD < 1)
xx <- filter(zz, BCD == max(zz$BCD))


```

```{r mantel}
library(ecodist)

data.st <- filter(data, Transect_Type == "Structural")
data.st.fall <- filter(data.st, Sampling_Period == "Fall")
data.st.winter <- filter(data.st, Sampling_Period == "Winter")
data.st.spring <- filter(data.st, Sampling_Period == "Spring")
data.st.330 <- filter(data.st, Site == "330")
data.st.345 <- filter(data.st, Site == "345")
data.st.364 <- filter(data.st, Site == "364")
data.st.364 <- filter(data.st.364, Transect_Number == "0")
data.st.370 <- filter(data.st, Site == "370")
data.st.370 <- filter(data.st.370, Transect_Number == "0")
data.st.372 <- filter(data.st, Site == "372")
data.st.372 <- filter(data.st.372, Transect_Number == "0")
data.st.378 <- filter(data.st, Site == "378")
data.st.378 <- filter(data.st.378, Transect_Number == "0")

env.end<- 29 #FOR SPECEIS
sp.start<-30 #FOR SPECIES

env_data.st <- data.st[,1:env.end]
env_data.st.fall <- data.st.fall[,1:env.end]
env_data.st.winter <- data.st.winter[,1:env.end]
env_data.st.spring <- data.st.spring[,1:env.end]
env_data.st.330 <- data.st.330[,1:env.end]
env_data.st.345 <- data.st.345[,1:env.end]
env_data.st.364 <- data.st.364[,1:env.end]
env_data.st.370 <- data.st.370[,1:env.end]
env_data.st.372 <- data.st.372[,1:env.end]
env_data.st.378 <- data.st.378[,1:env.end]

species.data.st  <- data.st[,sp.start:ncol(data.st)]
species.orig.st<-species.data.st # fish data, no transform
species.data.st.fall<-data.st.fall[,sp.start:ncol(data.st.fall)] # fish data
species.orig.st.fall<-species.data.st.fall # fish data, no transform
species.data.st.winter<-data.st.winter[,sp.start:ncol(data.st.fall)] # fish data
species.orig.st.winter <-species.data.st.winter # fish data, no transform
species.data.st.spring<-data.st.spring[,sp.start:ncol(data.st.spring)] # fish data
species.orig.st.spring<-species.data.st.spring # fish data, no transform
species.data.st.330 <- data.st.330[,sp.start:ncol(data.st.330)]
species.orig.st.330 <- species.data.st.330
species.data.st.345 <- data.st.345[,sp.start:ncol(data.st.345)]
species.orig.st.345 <- species.data.st.345
species.data.st.364 <- data.st.364[,sp.start:ncol(data.st.364)]
species.orig.st.364 <- species.data.st.364
species.data.st.370 <- data.st.370[,sp.start:ncol(data.st.370)]
species.orig.st.370 <- species.data.st.370
species.data.st.372 <- data.st.372[,sp.start:ncol(data.st.372)]
species.orig.st.372 <- species.data.st.372
species.data.st.378 <- data.st.378[,sp.start:ncol(data.st.378)]
species.orig.st.378 <- species.data.st.378

#species.data <- transform_data (data = species.data, transform_type = "square_root")
#species.data <- transform_data (data = species.data, transform_type = "cube_root")
#species.data <- transform_data (data = species.data, transform_type = "pres_abs")

species.data.st <- transform_data (data = species.data.st, transform_type = "square_root_plus_number")
species.data.st.fall <- transform_data (data = species.data.st.fall, transform_type = "square_root_plus_number")
species.data.st.winter <- transform_data (data = species.data.st.winter, transform_type = "square_root_plus_number")
species.data.st.spring <- transform_data (data = species.data.st.spring, transform_type = "square_root_plus_number")
species.data.st.330 <- transform_data(data= species.data.st.330, transform_type = "square_root_plus_number")
species.data.st.345 <- transform_data(data= species.data.st.345, transform_type = "square_root_plus_number")
species.data.st.364 <- transform_data(data= species.data.st.364, transform_type = "square_root_plus_number")
species.data.st.370 <- transform_data(data= species.data.st.370, transform_type = "square_root_plus_number")
species.data.st.372 <- transform_data(data= species.data.st.372, transform_type = "square_root_plus_number")
species.data.st.378 <- transform_data(data= species.data.st.378, transform_type = "square_root_plus_number")

species.data.st.bcd <- bcdist(species.data.st, rmzero=FALSE)
species.data.st.fall.bcd <- bcdist(species.data.st.fall, rmzero=FALSE)
species.data.st.winter.bcd <- bcdist(species.data.st.winter, rmzero=FALSE)
species.data.st.spring.bcd <- bcdist(species.data.st.spring, rmzero=FALSE)
species.data.st.330.bcd <- bcdist(species.data.st.330, rmzero=FALSE)
species.data.st.345.bcd <- bcdist(species.data.st.345, rmzero=FALSE)
species.data.st.364.bcd <- bcdist(species.data.st.364, rmzero=FALSE)
species.data.st.370.bcd <- bcdist(species.data.st.370, rmzero=FALSE)
species.data.st.372.bcd <- bcdist(species.data.st.372, rmzero=FALSE)
species.data.st.378.bcd <- bcdist(species.data.st.378, rmzero=FALSE)

distance <- dist(cbind(data.st$Longitude_DD, data.st$Latitude_DD))
distancefall<- dist(cbind(data.st.fall$Longitude_DD, data.st.fall$Latitude_DD))
distancewinter<- dist(cbind(data.st.winter$Longitude_DD, data.st.winter$Latitude_DD))
distancespring<- dist(cbind(data.st.spring$Longitude_DD, data.st.spring$Latitude_DD))
distance330 <- dist(cbind(data.st.330$Longitude_DD, data.st.330$Latitude_DD))
distance345 <- dist(cbind(data.st.345$Longitude_DD, data.st.345$Latitude_DD))
distance364 <- dist(cbind(data.st.364$Longitude_DD, data.st.364$Latitude_DD))
distance370 <- dist(cbind(data.st.370$Longitude_DD, data.st.370$Latitude_DD))
distance372 <- dist(cbind(data.st.372$Longitude_DD, data.st.372$Latitude_DD))
distance378 <- dist(cbind(data.st.378$Longitude_DD, data.st.378$Latitude_DD))

set.seed(318)
mantel <- mantel(species.data.st.bcd ~ distance) #positive, sig 2-tail
mantelfall <- mantel(species.data.st.fall.bcd ~ distancefall) #positive, sig 2-tail
mantelwinter <- mantel(species.data.st.winter.bcd ~ distancewinter)#postive, no sig
mantelspring <- mantel(species.data.st.spring.bcd ~ distancespring)#postive, sig 2-tail
mantel330 <- mantel(species.data.st.330.bcd ~ distance330) #neg, no sig
mantel345 <- mantel(species.data.st.345.bcd ~ distance345)#neg, no sig
mantel364 <- mantel(species.data.st.364.bcd ~ distance364)#pos, no sig
mantel370 <- mantel(species.data.st.370.bcd ~ distance370)#neg, no sig
mantel372 <- mantel(species.data.st.372.bcd ~ distance372)#pos, no sig
mantel378 <- mantel(species.data.st.378.bcd ~ distance378)#pos, no sig

mantel.correlog <- mantel.correlog(species.data.st.bcd, distance)
plot(mantel.correlog, alpha= 0.05)

mantel.correlog.fall <- mantel.correlog(species.data.st.fall.bcd, distancefall)
plot(mantel.correlog.fall, alpha= 0.05)

mantel.correlog.winter <- mantel.correlog(species.data.st.winter.bcd, distancewinter)
plot(mantel.correlog.winter, alpha= 0.05)

mantel.correlog.spring <- mantel.correlog(species.data.st.spring.bcd, distancespring)
plot(mantel.correlog.spring, alpha= 0.05)

```

```{r distance_NR}

#site 370
#distance to NR1
#site370 <- filter(data, Site == "370")
#nat370 <- filter(site370, Reef_Type == "Natural")
#art370 <- filter(site370, Reef_Type == "Artificial")
#distance370 <- dist(cbind(site370$Longitude_DD, site370$Latitude_DD))

struc <- filter(data, Transect_Type == "Structural")
data370 <- filter(struc, Site == "370")

#env.end<- 29 #FOR SPECEIS
#sp.start<-30 #FOR SPECIES

#env_data370 <- data370[,1:env.end]


#species.data.370  <- data370[,sp.start:ncol(data370)]
#species.orig.370<-species.data.370 # fish data, no transform

fishabundance370 <- mutate(data370, Abundance = rowSums(data370[,30:ncol(data370)]))



#fishabundance370 <- mutate(fishabundance370, NR1 = )
#fishdist370 <- mutate(fishabundance370, Latitude_dist = dist(site370$Latitude_DD, ))
species.data.st <- transform_data (data = species.data.st, transform_type = "square_root_plus_number")
species.data.st.fall <- transform_data (data = species.data.st.fall, transform_type = "square_root_plus_number")
species.data.st.winter <- transform_data (data = species.data.st.winter, transform_type = "square_root_plus_number")
species.data.st.spring <- transform_data (data = species.data.st.spring, transform_type = "square_root_plus_number")
species.data.st.330 <- transform_data(data= species.data.st.330, transform_type = "square_root_plus_number")
species.data.st.345 <- transform_data(data= species.data.st.345, transform_type = "square_root_plus_number")
species.data.st.364 <- transform_data(data= species.data.st.364, transform_type = "square_root_plus_number")
species.data.st.370 <- transform_data(data= species.data.st.370, transform_type = "square_root_plus_number")
species.data.st.372 <- transform_data(data= species.data.st.372, transform_type = "square_root_plus_number")
species.data.st.378 <- transform_data(data= species.data.st.378, transform_type = "square_root_plus_number")

species.data.st.bcd <- bcdist(species.data.st, rmzero=FALSE)
species.data.st.fall.bcd <- bcdist(species.data.st.fall, rmzero=FALSE)
species.data.st.winter.bcd <- bcdist(species.data.st.winter, rmzero=FALSE)
species.data.st.spring.bcd <- bcdist(species.data.st.spring, rmzero=FALSE)
species.data.st.330.bcd <- bcdist(species.data.st.330, rmzero=FALSE)
species.data.st.345.bcd <- bcdist(species.data.st.345, rmzero=FALSE)
species.data.st.364.bcd <- bcdist(species.data.st.364, rmzero=FALSE)
species.data.st.370.bcd <- bcdist(species.data.st.370, rmzero=FALSE)
species.data.st.372.bcd <- bcdist(species.data.st.372, rmzero=FALSE)
species.data.st.378.bcd <- bcdist(species.data.st.378, rmzero=FALSE)

distance <- dist(cbind(data.st$Longitude_DD, data.st$Latitude_DD))
distancefall<- dist(cbind(data.st.fall$Longitude_DD, data.st.fall$Latitude_DD))
distancewinter<- dist(cbind(data.st.winter$Longitude_DD, data.st.winter$Latitude_DD))
distancespring<- dist(cbind(data.st.spring$Longitude_DD, data.st.spring$Latitude_DD))
distance330 <- dist(cbind(data.st.330$Longitude_DD, data.st.330$Latitude_DD))
distance345 <- dist(cbind(data.st.345$Longitude_DD, data.st.345$Latitude_DD))
distance364 <- dist(cbind(data.st.364$Longitude_DD, data.st.364$Latitude_DD))
distance370 <- dist(cbind(data.st.370$Longitude_DD, data.st.370$Latitude_DD))
distance372 <- dist(cbind(data.st.372$Longitude_DD, data.st.372$Latitude_DD))
distance378 <- dist(cbind(data.st.378$Longitude_DD, data.st.378$Latitude_DD))

#site 372

```

#exploring environmenatal variables

#not using this
```{r classification_trees}
library(rpart)
#grow a tree
#categorical (classification) method = "class", continuous (regression) methode = "anvoa"
data$Transect_Number <- as.character(data$Transect_Number)
data$Site <- as.character(data$Site)
data$Sampling_Period <- as.character(data$Sampling_Period)


help_new2 <- rpart(species.data ~ Transect_Number + Site + Sampling_Period + Temp_min + max_dep + Structure_Type + Reef_Type + Distance_To_Nearest_Land_ft, data, method = "anova")
#help_new2
#plot(help_new2, uniform=TRUE, 
#  	main="Classification Tree")
#text(help_new2, use.n=TRUE, all=TRUE, cex=.8)
printcp(help_new2)
plotcp(help_new2)
rsq.rpart(help_new2)
print(help_new2)
summary(help_new2)
plot(help_new2)
text(help_new2)
post(help_new2, title = "Classification Tree")

prune.help_new2 <- prune(help_new2, cp = help_new2$cptable[which.min(help_new2$cptable[,"xerror"]),"CP"])
plot(prune.help_new2, uniform=TRUE, 
  	main="Pruned Classification Tree")
text(prune.help_new2, use.n=TRUE, all=TRUE, cex=.8)
post(prune.help_new2, title = "Pruned Classification Tree")




help <- rpart(data, method = "anova")
#help
#summary(help)
#plot(help, uniform=TRUE, 
  #	main="Classification Tree")
#text(help, use.n=TRUE, all=TRUE, cex=.8)
printcp(help)
plotcp(help)
rsq.rpart(help)
print(help)
summary(help)
plot(help)
text(help)
post(help, title = "Classification Tree")

prune.help <- prune(help, cp = help$cptable[which.min(help$cptable[,"xerror"]),"CP"])
plot(prune.help, uniform=TRUE, 
  	main="Pruned Classification Tree")
text(prune.help, use.n=TRUE, all=TRUE, cex=.8)
post(prune.help, title = "Pruned Classification Tree")



cats <- rpart(species.data ~ Transect_Number + Site + Sampling_Period + Reef_Type, data, method = "anova")
printcp(cats)
plotcp(cats)
rsq.rpart(cats)
print(cats)
summary(cats)
plot(cats)
text(cats)
post(cats, title = "Classification Tree")

prune.cats <- prune(cats, cp = cats$cptable[which.min(cats$cptable[,"xerror"]),"CP"])
plot(prune.cats, uniform=TRUE, 
  	main="Pruned Classification Tree")
text(prune.cats, use.n=TRUE, all=TRUE, cex=.8)
post(prune.cats, title = "Pruned Classification Tree")

dogs <- rpart(species.data ~ Transect_Number + Sampling_Period, data, method = "anova")
printcp(dogs)
plotcp(dogs)
rsq.rpart(dogs)
print(dogs)
summary(dogs)
plot(dogs)
text(dogs)
post(dogs, title = "Classification Tree")

prune.dogs <- prune(dogs, cp = dogs$cptable[which.min(dogs$cptable[,"xerror"]),"CP"])
plot(prune.dogs, uniform=TRUE, 
  	main="Pruned Classification Tree")
text(prune.dogs, use.n=TRUE, all=TRUE, cex=.8)
post(prune.dogs, title = "Pruned Classification Tree")



help2 <- rpart(data, method = "class")
help2
plot(help2, uniform=TRUE, 
  	main="Classification Tree")
text(help2, use.n=TRUE, all=TRUE, cex=.8)

```

#univariate statistics/visulizations
```{r ggplot2}
library(ggplot2)
fishabundance <- mutate(data, Abundance = rowSums(data[,30:ncol(data)]))

#test <- summarySE(fishabundance, measurevar = "Abundance", groupvars = c("Transect_Number", "Sampling_Period"))

test <- summarySE(fishabundance, measurevar = "Abundance", groupvars = c("Transect_Number"))


ggplot(test, aes(x=as.factor(Transect_Number), y=Abundance)) +
  theme_classic()+
  geom_bar(position=position_dodge(), stat="identity", colour="black")+
  geom_errorbar(aes(ymin=Abundance-se, ymax=Abundance+se), width=.2, position=position_dodge(0.9))+
  scale_y_continuous(name="Average Fish Abundance", 
                     limits=c(0, 500), 
                     breaks=seq(0, 500,by=100)) + 
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="none", 
        axis.line.x = element_line(color="black", size = 0.5), 
        axis.line.y = element_line(color="black", size = 0.5))+ 
  scale_x_discrete(name = "Distance from Structure", labels = c("0" = "Structure", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))+
  ggtitle("Fish Abundance by Distance from Structure")+
annotate("text", x = 1, y = 460, label = "a", size = 5)+
annotate("text", x = 2, y = 180, label = "b", size = 5)+
annotate("text", x = 3, y = 63, label = "b", size = 5)+
annotate("text", x = 4, y = 27, label = "b", size = 5)

###############################################################################

# fill for extra variable (in this case season)
test1 <- summarySE(fishabundance, measurevar = "Abundance", groupvars = c("Transect_Number", "Sampling_Period"))
test1$Sampling_Period <- factor(test1$Sampling_Period, c("Fall", "Winter", "Spring"))
#order levels of treatment to appear orderly in plots


#ggplot(test1, aes(x=as.factor(Transect_Number), y=Abundance, fill=Sampling_Period)) +
 # theme_classic()+
  #geom_bar(position=position_dodge(), stat="identity", colour="black")+
 # geom_errorbar(aes(ymin=Abundance-se, ymax=Abundance+se), width=.2, position=position_dodge(0.9))+
#  scale_y_continuous(name="Average Fish Abundance", 
  #                   limits=c(0, 900), 
 #                    breaks=seq(0, 900,by=100)) + 
#  theme(axis.text=element_text(size=16, colour="black"), 
     #   axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
    #    axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
   #     legend.position="bottom",
  #      axis.line.x = element_line(color="black", size = 0.5), 
 #       axis.line.y = element_line(color="black", size = 0.5))+  
 # scale_x_discrete(name = "Transect Type", labels = c("0" = "Structural", "1" = "0-30 m", "2" = "30-60 #m", "3" = "60-90 m"))+
#ggtitle("Ave Fish Abundance per Transect Type per Season")


ann_text <- data.frame(Transect_Number = c(0,1,2,3),Abundance = c(850,450,150,50),lab = c("a", "abc","bc","bc"),Sampling_Period = factor("Fall",levels = c("Fall","Winter","Spring")))
ann_text_winter <- data.frame(Transect_Number = c(0,1,2,3),Abundance = c(565,245,100,40),lab = c("ab", "bc","bc","c"),Sampling_Period = factor("Winter",levels = c("Fall","Winter","Spring")))
ann_text_spring <- data.frame(Transect_Number = c(0,1,2,3),Abundance = c(115,50,40,40),lab = c("bc", "c","c","c"),Sampling_Period = factor("Spring",levels = c("Fall","Winter","Spring")))


#order levels of treatment to appear orderly in plots, move this higher
# facets
#can do fill within facet
ggplot(test1, aes(x=as.factor(Transect_Number), y=Abundance)) +
  theme_classic()+
  facet_wrap(~Sampling_Period, ncol=3)+
  geom_bar(position=position_dodge(), stat="identity", colour="black")+
  geom_errorbar(aes(ymin=Abundance-se, ymax=Abundance+se), width=.2, position=position_dodge(0.9))+
  scale_y_continuous(name="Average Fish Abundance", 
                     limits=c(0, 900), 
                     breaks=seq(0, 900,by=100)) + 
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="bottom",
        axis.line.x = element_line(color="black", size = 0.5), 
        axis.line.y = element_line(color="black", size = 0.5))+ 
  scale_x_discrete(name = "Distance from Structure", labels = c("0" = "Structure", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))+
ggtitle("Fish Abundance by Distance from Structure by Season")+
#annotate("text", x = 1, y = 850, label = "a", size = 5)+
#annotate("text", x = 2, y = 450, label = "ab", size = 5)+
#annotate("text", x = 3, y = 150, label = "b", size = 5)+
#annotate("text", x = 4, y = 50, label = "b", size = 5)+
geom_text(data = ann_text,aes(label =lab), size = 5)+
geom_text(data = ann_text_winter,aes(label =lab), size = 5)+  
geom_text(data = ann_text_spring,aes(label =lab), size = 5)  

#######################################################################################

test7 <- summarySE(fishabundance, measurevar = "Abundance", groupvars = "Sampling_Period")
test7$Sampling_Period <- factor(test7$Sampling_Period, c("Fall", "Winter", "Spring"))
ggplot(test7, aes(x=as.factor(Sampling_Period), y=Abundance)) +
  theme_classic()+
  geom_bar(position=position_dodge(), stat="identity", colour="black")+
  geom_errorbar(aes(ymin=Abundance-se, ymax=Abundance+se), width=.2, position=position_dodge(0.9))+
  scale_y_continuous(name="Average Fish Abundance", 
                     limits=c(0, 400), 
                     breaks=seq(0, 400,by=100)) + 
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="none", 
        axis.line.x = element_line(color="black", size = 0.5), 
        axis.line.y = element_line(color="black", size = 0.5))+ 
  scale_x_discrete(name = "Season")+#, labels = c("0" = "Structural", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))+
  ggtitle("Fish Abundance per Season")+
annotate("text", x = 1, y = 370, label = "a", size = 5)+
annotate("text", x = 2, y = 180, label = "ab", size = 5)+
annotate("text", x = 3, y = 40, label = "b", size = 5)
####################################################################################

#fishFall <- filter(fishabundance, Sampling_Period == "Fall")
#fishWinter <- filter(fishabundance, Sampling_Period == "Winter")
#fishSpring <- filter(fishabundance, Sampling_Period == "Spring")
  
test2 <- summarySE(fishabundance, measurevar = "Abundance", groupvars = c("Transect_Number", "Reef_Type"))

ggplot(test2, aes(x=as.factor(Transect_Number), y=Abundance, fill=Reef_Type)) +
  theme_classic()+
  geom_bar(position=position_dodge(), stat="identity", colour="black")+
  geom_errorbar(aes(ymin=Abundance-se, ymax=Abundance+se), width=.2, position=position_dodge(0.9))+
  scale_y_continuous(name="Average Fish Abundance", 
                     limits=c(0, 500), 
                     breaks=seq(0, 500,by=100)) + 
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="bottom") + 
  scale_x_discrete(name = "Transect Type", labels = c("0" = "Structural", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))
#***************************************************8
ann_text_art <- data.frame(Transect_Number = c(0,1,2,3),Abundance = c(520,220,80,20),lab = c("a", "ab","b","b"),Reef_Type = factor("Artificial",levels = c("Artificial","Natural")))
ann_text_nat <- data.frame(Transect_Number = c(0,1,2,3),Abundance = c(330,80,35,45),lab = c("ab", "ab","b","b"),Reef_Type = factor("Natural",levels = c("Artificial","Natural")))






ggplot(test2, aes(x=as.factor(Transect_Number), y=Abundance)) +
  theme_classic()+
  facet_wrap(~Reef_Type, ncol = 2) +
  geom_bar(position=position_dodge(), stat="identity", colour="black")+
  geom_errorbar(aes(ymin=Abundance-se, ymax=Abundance+se), width=.2, position=position_dodge(0.9))+
  scale_y_continuous(name="Average Fish Abundance", 
                     limits=c(0, 520), 
                     breaks=seq(0, 520,by=100)) + 
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="bottom", 
axis.line.x = element_line(color="black", size = 0.5), 
        axis.line.y = element_line(color="black", size = 0.5))+ 
  scale_x_discrete(name = "Distance from Structure", labels = c("0" = "Structure", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))+
ggtitle("Fish Abundance by Distance from Struture by Reef Type")+
geom_text(data = ann_text_art,aes(label =lab), size = 5)+
geom_text(data = ann_text_nat,aes(label =lab), size = 5)

#just reef type
test20 <- summarySE(fishabundance, measurevar = "Abundance", groupvars = c("Reef_Type"))

ggplot(test20, aes(x=as.factor(Reef_Type), y=Abundance)) +
  theme_classic()+
  #facet_wrap(~Site, ncol = 6) +
  geom_bar(position=position_dodge(), stat="identity", colour="black")+
  geom_errorbar(aes(ymin=Abundance-se, ymax=Abundance+se), width=.2, position=position_dodge(0.9))+
  scale_y_continuous(name="Average Fish Abundance", 
                     limits=c(0, 200), 
                     breaks=seq(0, 200,by=50)) + 
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="bottom",
        axis.line.x = element_line(color="black", size = 0.5), 
        axis.line.y = element_line(color="black", size = 0.5))+ 
  scale_x_discrete(name = "Reef Type") +#, labels = c("0" = "Structural", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))
ggtitle("Fish Abundance per Reef Type")+
annotate("text", x = 1, y = 170, label = "a", size = 5)+
annotate("text", x = 2, y = 95, label = "a", size = 5)

#**************************************************************
test3 <- summarySE(fishabundance, measurevar = "Abundance", groupvars = c("Transect_Number", "Site"))
#test1$Sampling_Period <- factor(test1$Sampling_Period, c("Fall", "Winter", "Spring"))
#order levels of treatment to appear orderly in plots

#********************************************************************
fishabundance$Site <- as.factor(fishabundance$Site)
ann_text_330 <- data.frame(Transect_Number = c(0,1,2,3),Abundance = c(2300,510,250,20),lab = c("a", "b","b","b"),Site = factor("330",levels = c("330","345","364","370","372","378")))

ann_text_345 <- data.frame(Transect_Number = c(0,1,2,3),Abundance = c(400,550,50,20),lab = c("b", "b","b","b"),Site = factor("345",levels = c("330","345","364","370","372","378")))
ann_text_364 <- data.frame(Transect_Number = c(0,1,2,3),Abundance = c(600,400,30,20),lab = c("b", "b","b","b"),Site = factor("364",levels = c("330","345","364","370","372","378")))
ann_text_370 <- data.frame(Transect_Number = c(0,1,2,3),Abundance = c(500,200,80,20),lab = c("b", "b","b","b"),Site = factor("370",levels = c("330","345","364","370","372","378")))
ann_text_372 <- data.frame(Transect_Number = c(0,1,2,3),Abundance = c(500,200,80,20),lab = c("b", "b","b","b"),Site = factor("372",levels = c("330","345","364","370","372","378")))
ann_text_378 <- data.frame(Transect_Number = c(0,1,2,3),Abundance = c(500,200,80,20),lab = c("b", "b","b","b"),Site = factor("378",levels = c("330","345","364","370","372","378")))

xpos <- c(0,1,2,3) 
ypos <- c(2200,500,100,20)
lab <- c("a", "b", "b", "b")
ldata <- data.frame(xpos, ypos, lab, Site = factor("330", levels= c("330","345","364","370","372","378")))


#ggplot(mtcars) + geom_bar(aes(x=cyl)) + facet_grid(~splitter) #+ 
 # geom_text(data=ldata, aes(x=xpos, y=ypos, 
     #                       label=lab, size=1), 
     #       vjust=2, parse=FALSE)

ggplot(test3, aes(x=as.factor(Transect_Number), y=Abundance)) +
  theme_classic()+
  facet_wrap(~Site, nrow = 1,ncol = 6) +
  geom_bar(position=position_dodge(), stat="identity", colour="black")+
  geom_errorbar(aes(ymin=Abundance-se, ymax=Abundance+se), width=.2, position=position_dodge(0.9))+
  scale_y_continuous(name="Average Fish Abundance", 
                     limits=c(0, 2500), 
                     breaks=seq(0, 2500,by=500)) + 
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="bottom", 
axis.line.x = element_line(color="black", size = 0.5), 
        axis.line.y = element_line(color="black", size = 0.5))+ 
  scale_x_discrete(name = "Distance from Structure", labels = c("0" = "Structure", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))+
ggtitle("Fish Abundance by Distance from Structure by Site")+

  
  geom_text(data= data.frame(x= 1, y = 2200, Site = "330"), aes(label = "a"))


#  geom_text(data=ldata, aes(x=xpos, y=ypos, 
                          #  label=lab, size=1))
#geom_text(aes(x, y, label=lab),
      #data=data.frame(x=c(0,1,2,3), y=c(2250, 500,300,100), lab=c("a","b","b", "b"), Site = "330"))
  
 # annotate("text", data = data.frame (x = c(0,1,2,3), y = c(2250,500,300,100), Site = "330", label = c("a","b","b","b"), size = 5))
           
           
geom_text(data = ann_text_330,aes(label =lab), size = 5)+
geom_text(data = ann_text_345,aes(label =lab), size = 5)+
geom_text(data = ann_text_364,aes(label =lab), size = 5)+
geom_text(data = ann_text_370,aes(label =lab), size = 5)+
geom_text(data = ann_text_372,aes(label =lab), size = 5)+
geom_text(data = ann_text_378,aes(label =lab), size = 5)






 


#################################################################################################
test4 <- summarySE(fishabundance, measurevar = "Abundance", groupvars = c("Site"))

ggplot(test4, aes(x=as.factor(Site), y=Abundance)) +
  theme_classic()+
  #facet_wrap(~Site, ncol = 6) +
  geom_bar(position=position_dodge(), stat="identity", colour="black")+
  geom_errorbar(aes(ymin=Abundance-se, ymax=Abundance+se), width=.2, position=position_dodge(0.9))+
  scale_y_continuous(name="Average Fish Abundance", 
                     limits=c(0, 600), 
                     breaks=seq(0, 600,by=100)) + 
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="bottom",
        axis.line.x = element_line(color="black", size = 0.5), 
        axis.line.y = element_line(color="black", size = 0.5))+ 
  scale_x_discrete(name = "Site") +#, labels = c("0" = "Structural", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))
ggtitle("Fish Abundance per Site")+
annotate("text", x = 1, y = 560, label = "a", size = 5)+
annotate("text", x = 2, y = 230, label = "ab", size = 5)+
annotate("text", x = 3, y = 190, label = "b", size = 5)+
annotate("text", x = 4, y = 70, label = "b", size = 5)+
annotate("text", x = 5, y = 170, label = "b", size = 5)+
annotate("text", x = 6, y = 40, label = "b", size = 5)


######################################################################################
test10 <- summarySE(fishabundance, measurevar = "Abundance", groupvars = c("Latitude_DD"))

ggplot(test10, aes(x = as.factor(Latitude_DD), y=Abundance)) +
  theme_classic()+
  #facet_wrap(~Site, ncol = 6) +
  geom_bar(position=position_dodge(), stat="identity", colour="black")+
  geom_errorbar(aes(ymin=Abundance-se, ymax=Abundance+se), width=.2, position=position_dodge(0.9))+
  scale_y_continuous(name="Average Fish Abundance", 
                     limits=c(0, 600), 
                     breaks=seq(0, 600,by=100)) + 
  theme(axis.text=element_text(size=16, colour="black"), 
        axis.title.x=element_text(size=16, colour="black", vjust=-.5), 
        axis.title.y=element_text(size=16, colour="black", vjust=1.3), 
        legend.position="bottom") + 
  scale_x_discrete(name = "Latitude") +#, labels = c("0" = "Structural", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"))
ggtitle("Fish Abundance per Latitude")


```

```{r ANOVA}
library(agricolae)
#abund, biom, S, shan
fishabundance <- mutate(data, Abundance = rowSums(data[,30:ncol(data)]))
fishabundance$Transect_Number <- as.factor(fishabundance$Transect_Number)
fishabundance$Site <- as.factor(fishabundance$Site)

fishbiomass <- mutate(databiom, Biomass = rowSums(databiom[,30:ncol(databiom)]))
fishbiomass$Transect_Number <- as.factor(fishbiomass$Transect_Number)
fishbiomass$Site <- as.factor(fishbiomass$Site)

#########################################################################################################

everything <- lm(Abundance ~ Transect_Number * Sampling_Period * Site * Reef_Type * DRR * Latitude_DD * Temp_min, data = fishabundance)
anova(everything)
summary(everything)

######################################################################################################
#ABUNDANCE
out.abudance <- lm(Abundance ~ Transect_Number, data = fishabundance)
anova(out.abudance)
summary(out.abudance)
hsd <- HSD.test(out.abudance, c("Transect_Number"))
hsd

#pair <- pairwise.t.test(fishabundance$Abundance, fishabundance$Transect_Number, p.adj = "none")
#pair

#BIOMASS
out.biomass <- lm(Biomass ~ Transect_Number, data = fishbiomass)
anova(out.biomass)
summary(out.biomass)
hsdbiom <- HSD.test(out.biomass, c("Transect_Number"))
hsdbiom

#SPECIES RICHNESS
out.S <- lm(S ~ Transect_Number, data = comm_mets)
anova(out.S)
summary(out.S)
hsdS <- HSD.test(out.S, c("Transect_Number"))
hsdS

#SHANNON'S DIVERSITY
out.shan <- lm(shan ~ Transect_Number, data = comm_mets)
anova(out.shan)
summary(out.shan)
hsdshan <- HSD.test(out.shan, c("Transect_Number"))
hsdshan
######################################################################
mod2 <- lm(Abundance ~ Transect_Number+ Sampling_Period, data = fishabundance)
anova(mod2)
summary(mod2)

mod2 <- lm(Abundance ~ Sampling_Period* Transect_Number, data = fishabundance)
anova(mod2)
summary(mod2)


library(agricolae)
hsd2.samp <- HSD.test(mod2, c("Sampling_Period", "Transect_Number"))
hsd2.samp

out.biomass2 <- lm(Biomass ~ Transect_Number * Sampling_Period, data = fishbiomass)
anova(out.biomass2)
summary(out.biomass2)
hsdbiom2 <- HSD.test(out.biomass2, c("Transect_Number", "Sampling_Period"))
hsdbiom2



mod2.5 <- lm(Abundance ~ Sampling_Period, data = fishabundance)
anova(mod2.5)
summary(mod2.5)
hsd2.5 <- HSD.test(mod2.5, "Sampling_Period")
hsd2.5

#library(agricolae)
#hsd2.samp <- HSD.test(mod2, "Transect_Number:Sampling_PeriodSpring")
#hsd2.samp
#hsd2.tran <- HSD.test(mod2, "Transect_Number")
#hsd2.tran

pair2 <- pairwise.t.test(fishabundance$Abundance, fishabundance$Transect_Number, p.adj = "none")
pair2
#########################################################################################
mod3 <- lm(Abundance ~ Transect_Number+ Reef_Type, data = fishabundance)
anova(mod3)
summary(mod3)

library(agricolae)
hsd3.reef <- HSD.test(mod3, "Reef_Type")
hsd3.reef

hsd3.tran <- HSD.test(mod3, "Transect_Number")
hsd3.tran

###################################################################
mod4 <- lm(Abundance ~ Transect_Number * Site, data = fishabundance)
anova(mod4)
summary(mod4)

library(agricolae)
hsd4.site <- HSD.test(mod4, "Site")
hsd4.site

hsd4.site.transect <- HSD.test(mod4, c("Transect_Number", "Site"))
hsd4.site.transect

mod4.5 <-lm(Abundance ~ Site, data = fishabundance)
anova(mod4.5)
summary(mod4.5)

hsd4.5 <- HSD.test(mod4.5, "Site")
hsd4.5
#############################################################3

mod5 <- lm(Abundance ~ Distance_To_Nearest_Land_ft, data = fishabundance)
anova(mod5)
summary(mod5)

library(agricolae)
hsd5.land <- HSD.test(mod5, "Distance_To_Nearest_Land_ft")
hsd5.land


##############################################################################
mod6 <- lm(Abundance ~ Visibility_Min_ft, data = fishabundance)
anova(mod6)
summary(mod6)

library(agricolae)
hsd6.vis <- HSD.test(mod6, "Visibility_Min_ft")
hsd6.vis
####################################################
mod7 <- lm(Abundance ~ Latitude_DD, data = fishabundance)
anova(mod7)
summary(mod7)

library(agricolae)
hsd7.lat <- HSD.test(mod7, "Latitude_DD")
hsd7.lat
##########################################################################
mod9 <- lm(Abundance ~ Longitude_DD, data = fishabundance)
anova(mod9)
summary(mod9)

library(agricolae)
hsd9.long <- HSD.test(mod9, "Longitude_DD")
hsd9.long
################################################################################

mod8 <- lm(Abundance ~ DRR, data = fishabundance)
anova(mod8)
summary(mod8)

library(agricolae)
hsd8.drr <- HSD.test(mod8, "DRR")
hsd8.drr
############################################################
mod11 <- lm(Abundance ~ Transect_Number*Reef_Type, data = fishabundance)
anova(mod11)
summary(mod11)

library(agricolae)
hsd11.reef <- HSD.test(mod11, c("Transect_Number", "Reef_Type"))
hsd11.reef

mod11biom <- lm(Biomass ~ Transect_Number*Reef_Type, data = fishbiomass)
anova(mod11biom)
summary(mod11biom)

library(agricolae)
hsd11.reef.biom <- HSD.test(mod11biom, c("Transect_Number", "Reef_Type"))
hsd11.reef.biom


###########################################################
mod13 <- lm(Abundance ~ Reef_Type, data = fishabundance)
anova(mod13)
summary(mod13)

library(agricolae)
hsd13.reef <- HSD.test(mod13, c("Reef_Type"))
hsd13.reef

mod13biom <- lm(Biomass ~ Reef_Type, data = fishbiomass)
anova(mod13biom)
summary(mod13biom)

library(agricolae)
hsd13.reef.biom <- HSD.test(mod13biom, c("Reef_Type"))
hsd13.reef.biom



```

#not using
```{r Post_hoc_comparisons}

```

#multivariate statistics/visualizations
```{r PERMANOVA}

# permanova to test for effect of relief and complexity

#library(ecodist)
    #species.bcd<-distance(as.matrix(species.data), method="bray")
    #head(species.bcd)
#environmental data from PCA and filtered for structural
    
#env_data.bcd <- filter(env_data.structural, env_data.structural$DRR != 'N/A')
#env_data.filter <- filter(env_data.bcd, Transect_Type == "Structural")
#env_data.filter <- as.matrix(env_data.filter)    
#species.bcd_df <- as.matrix(species.bcd_df)

#set.seed(318)
#library(vegan)
#permanova<-adonis(species.bcd_df ~ Temp_max, env_data.filter, permutations = 1000, method = "bray")
#permanova
#***********************************************
#MANOVA
t0 <- filter(data, Transect_Type == "Structural")
radiating <- filter(data, Transect_Type == "Radiating")
t1 <- filter(radiating, Transect_Number == '1')
t2 <- filter(radiating, Transect_Number == '2')
t3 <- filter(radiating, Transect_Number == '3')

t0 <- as.matrix(t0)
t1 <- as.matrix(t1)
all.transects <- cbind (t0, t1,t2, t3)



#********************************************
env_data$Transect_Number <- as.factor(env_data$Transect_Number)
set.seed(318)
permanova.transect<-adonis(species.data ~ Transect_Number, env_data, permutations = 999, method = "bray")
permanova.transect2<-adonis2(species.data ~ Transect_Number, env_data, permutations = 999, method = "bray", by = "terms")
permanova.transect2

  permanova.transect
  
  summary(permanova.transect)
#*****************************************  
permanova.transect$aov.tab
permanova.transect$coefficients
permanova.transect$coef.sites
permanova.transect$f.perms
permanova.transect$model.matrix
permanova.transect$terms


densityplot(permustats(permanova.transect))
#*********************************************
  
perm.trans.sea <- adonis(species.data ~ Transect_Number * Sampling_Period, env_data, permutation = 999, method = "bray")
perm.trans.sea
summary(perm.trans.sea)

perm.samp <- adonis(species.data ~ Sampling_Period, env_data, permutation = 999, method = "bray")
perm.samp
summary(perm.samp)

perm.trans.site <- adonis(species.data ~ Transect_Number * Site, env_data, permutation = 999, method = "bray")
perm.trans.site
summary(perm.trans.site)

perm.site <- adonis(species.data ~ Site, env_data, permutation = 999, method = "bray")
perm.site
summary(perm.site)

perm.trans.reef <- adonis(species.data ~ Transect_Number * Reef_Type, env_data, permutation = 999, method = "bray")
perm.trans.reef
summary(perm.trans.reef)

perm.reef <- adonis(species.data ~ Reef_Type, env_data, permutation = 999, method = "bray")
perm.reef
summary(perm.reef)

data.drr <- filter(data, DRR != "NA")
env_data.drr <- data.drr[,1:env.end]
 
species.data.drr<-data.drr[,sp.start:ncol(data.drr)] # fish data
species.orig.drr<-species.data.drr # fish data, no transform

#species.data <- transform_data (data = species.data, transform_type = "square_root")
#species.data <- transform_data (data = species.data, transform_type = "cube_root")
#species.data <- transform_data (data = species.data, transform_type = "pres_abs")
#we need to look at this with Avery
species.data.drr <- transform_data (data = species.data.drr, transform_type = "square_root_plus_number")

perm.trans.drr <- adonis(species.data.drr ~ Transect_Number * DRR, env_data, permutation = 999, method = "bray")
perm.trans.drr
summary(perm.trans.drr)

perm.drr <- adonis(species.data.drr ~ DRR, env_data, permutation = 999, method = "bray")
perm.drr
summary(perm.drr)


perm.trans.temp <- adonis(species.data.drr ~ Transect_Number * Temp_min, env_data, permutation = 999, method = "bray")
perm.trans.temp
summary(perm.trans.temp)

perm.temp <- adonis(species.data.drr ~ Temp_min, env_data, permutation = 999, method = "bray")
perm.temp
summary(perm.temp)

perm.trans.lat <- adonis(species.data ~ Transect_Number * Latitude_DD, env_data, permutation = 999, method = "bray")
perm.trans.lat
summary(perm.trans.lat)

perm.lat <- adonis(species.data ~ Latitude_DD, env_data, permutation = 999, method = "bray")
perm.lat
summary(perm.lat)
#******************************************************************
  
#set.seed(318)
#library(vegan)
#permanova<-adonis(species.bcd ~ Reef_Type*Depth_general*temp_avg, env_data, permutations = 1000, method = "bray")
#permanova
# Depth and reef type are significant


library(vegan)
permanova<-adonis(species.bcd ~ temp_avg, env_data, permutations = 1000, method = "bray")
permanova

library(vegan)
permanova<-adonis(species.bcd ~ Reef_type*avg_dep*DRR*ver_rel*temp_avg, env_data, permutations = 1000, method = "bray")
permanova
# reef type, drr, temp are all significant!

permanova<-adonis(species.data ~ver_rel, env_data, permutations = 1000, method = "bray")
# vertical relief and drr are significant for community according to permanova, but doesn't account for any variability

permanova<-adonis(species.bcd ~ Reef_type * ver_rel, env_data, permutations = 1000, method = "bray")
# vertical relief and drr are significant for community according to permanova, but doesn't account for any variability

permanova<-adonis(species.bcd~drr*temp_avg*Site, env.data, permutations =1000, method="bray")
permanova

permanova<-adonis(species.data ~ Reef_type*drr, env.data, permutations = 10000, method = "bray")
permanova
# reef type and drr are significant

permanova<-adonis(species.bcd ~ Reef_type * drr * avg_dep * sed_avg, env.data, permutations = 1000, method = "bray")
permanova
# See that interactions aren't significant, so build as additive model instead

permanova<-adonis(species.bcd ~ Reef_type + drr + avg_dep + sed_avg, env.data, permutations = 1000, method = "bray")
permanova
# See that all are significant!

permanova<-adonis(species.data ~ sed_stdv, env_data, permutations = 1000, method = "bray")

permanova<-adonis(species.bcd ~ Reef_type*ver_rel*drr*avg_dep*Samp*Location*sed_avg, env.data, permutations = 1000, method = "bray")
permanova
# full model --> doesn't seem to indicate much.... 

# This is the permanova output table
permanova$aov.tab

# Other output
summary(permanova)
permanova$coefficients
permanova$coef.sites
permanova$f.perms
permanova$model.matrix
permanova$terms

densityplot(permanova)

```

#not using
```{r ANOSIM}

# Goal to find differences between and among groups 

library(ecodist)
    species.bcd<-distance(as.matrix(species.data), method="bray")
    head(species.bcd)

library(vegan)
set.seed(318)


ano_reef<-anosim(species.data, env_data$Reef_Type, permutations = 1000, distance = "bray")  
ano_reef
  plot(ano_reef)
  summary(ano_reef)
  # result: community composition based on abundance is significantly different by reef type
  
  
#env_data$Transect_Number <- as.numeric(env_data$Transect_Number)

ano_transectnumber<-anosim(species.data, env_data$Transect_Number, permutations = 1000, distance = "bray")
  ano_transectnumber
  plot(ano_transectnumber)
  summary(ano_transectnumber)
  
ano_transect_season <- anosim(species.data, env_data$Transect_Number :
env_data$Sampling_Period, permutations = 1000, distance = "bray")
ano_transect_season
plot(ano_transect_season)
summary(ano_transect_season)
#what might make this work????
  
set.seed(318)
ano_depth<-anosim(species.data, env_data$Depth_general, permutations = 1000, distance = "bray")
  ano_depth
  plot(ano_depth)
  summary(ano_depth)

ano_reef_depth <- anosim(species.data, env_data$Depth_general : env_data$Reef_type, permutations = 1000, distance = "bray")
ano_reef_depth
plot(ano_reef_depth)
summary(ano_reef_depth)


ano_site<-anosim(species.data, env_data$Site, permutations = 1000, distance = "bray")
  ano_site
  plot(ano_site)
  summary(ano_site)

ano_samp<-anosim(species.data, env_data$Sample, permutations = 1000, distance = "bray")
  ano_samp
  plot(ano_samp)
  summary(ano_samp)

## Guidelines for interpretation. From Lauren Yeager's Community Analysis course in spring 2014.
  # Null hypothesis is that no difference in community structure among groups
  # ANOSIM is based on similarity matrix and is a non-parametric permutation procedure
  # R ranges between -1 and 1
    # R = 1 if all replicates w/i one group are more similar to each other than any replicate from a different group
    # R approx 0 if null hypothesis true
    # R <0 if there are more differences among samples within a group than between groups

```

```{r SIMPER}
# Goal: Use similarity percentages to find out 'who' is responsible for the differences

# Load library
library(vegan)
groups_transect <- paste(as.character(env_data$Transect_Number))
groups_transect <- as.factor(groups_transect)
simp_transect <- simper(species.data, groups_transect)
simp_transect
summary(simp_transect, ordered = TRUE)

groups_season <- paste(as.character(env_data$Sampling_Period))
groups_season <- as.factor(groups_season)
simp_season <- simper(species.data, groups_season)
simp_season
summary(simp_season, ordered = TRUE)

groups_site <- paste(as.character(env_data$Site))
groups_site <- as.factor(groups_site)
simp_site <- simper(species.data, groups_site)
simp_site
summary(simp_site, ordered = TRUE)

groups_reef <- paste(as.character(env_data$Reef_Type))
groups_reef <- as.factor(groups_reef)
simp_reef <- simper(species.data, groups_reef)
simp_reef
summary(simp_reef, ordered = TRUE)


  
#groups_reef_depth <- paste(as.character(env_data$Reef_type), as.character(env_data$Depth_general))
#groups <- as.factor(groups_reef_depth)
# Run SIMPER analysis with factor of reef type
#simp_reef_depth<-simper(species.data,  # community data matrix
 #           groups) # factor describing group structure (needs at least 2 levels)
#simp_reef_depth # gives contributions of most influential species
#summary(simp_reef_depth, ordered=TRUE) # provides summary output such that cumulative contributions are ordered by species contrib

# Simper by depth zone
#simp_depth <- simper(species.data, env_data$Depth_general)
#simp_depth
#summary(simp_depth, ordered = TRUE)

# Run SIMPER analysis with factor of sampling season

#years<-cbind (species.data, env_data)
#yr1 <- filter(years, Sample == c("S1", "S2", "S3"))
#yr2 <- filter(years, Sample == c("S4", "S5", "S6"))
#summers <- filter(years, Sample == c("S1", "S4"))
#falls <- filter(years, Sample == c("S2", "S5"))
#springs <- filter(years, Sample == c("S3", "S6"))

#simp_yr1<-simper(yr1[,1:120],  # community data matrix
 #           yr1$Sample) # factor describing group structure (needs at least 2 levels)
#simp_yr1 # gives contributions of most influential species
#summary(simp_samp, ordered=TRUE) # provides summary output such that cumulative contributions are ordered by species contrib
#summary(simp_yr1, ordered = TRUE)

#ano_samp<-anosim(springs[,1:120], springs$Sample, permutations = 1000, distance = "bray")
 # ano_samp
  #plot(ano_samp)
#  summary(ano_samp)
  
```  

```{r indicator_species}
library(indicspecies)

groups_transect <- env_data$Transect_Number
groups_transect <- as.factor(groups_transect)
B=strassoc(species.orig, cluster=groups_transect,func="B")
indval_transect <- multipatt(species.orig, groups_transect, control=how(nperm=999))
summary(indval_transect, indvalcomp = TRUE)


groups_site <- env_data$Site
groups_site <- as.factor(groups_site)
B=strassoc(species.orig, cluster=groups_site,func="B")
indval_site <- multipatt(species.orig, groups_site, control= how(nperm = 999))
summary(indval_site)

groups_season <- env_data$Sampling_Period
groups_season <- as.factor(groups_season)
B=strassoc(species.orig, cluster=groups_season,func="B")
indval_season <- multipatt(species.orig, groups_season, control = how(nperm = 999))
summary(indval_season)

groups_reef <- env_data$Reef_Type
groups_reef <- as.factor(groups_reef)
B=strassoc(species.orig, cluster=groups_reef,func="B")
indval_reef <- multipatt(species.orig, groups_reef, control = how(nperm = 999))
summary(indval_reef)

# Define classification groups as reef type
#groups_reef <- env_data$Reef_type
#groups<-groups_reef

# Define classification groups as sites
#groups_site <- env_data$Site
#groups_site

# Define classification groups as season
#groups_samp <- env_data$Sample
#groups_samp

# Define classification groups as season x reef type
#groups_int<-env.data$Sample:env.data$Reef_type
#groups_int

# Define classification groups as relative depth
#groups_depth <- env_data$Depth_general
#groups <- groups_depth

#groups_reef_depth <- paste(as.character(env_data$Reef_type), as.character(env_data$Depth_general))
#groups <- as.factor(groups_reef_depth)

# Run indicator species analysis using multipatt
#indval_reef <- multipatt(species.data, groups_reef, control=how(nperm=999))
#indval_site <- multipatt(species.data, groups_site, control=how(nperm=999))
#indval_samp <- multipatt(species.data, groups_samp, control=how(nperm=999))
#indval_int <- multipatt(species.data, groups_int, control=how(nperm=999))

#summary(indval_reef)
#summary(indval_site)
#summary(indval_samp)
#summary(indval_int)

# obtain classification using multivariate CART model
library(mvpart)
fit <- mvpart(data.matrix(species.data)~avg_dep + DRR + ver_rel + sed_stdv + temp_avg, env_data)
summary(fit) # fits multivariate tree with particular variables of interest
groups <- fit$where # group composition based on terminal nodes

## obtain classification using fuzzy clustering
library(cluster)
k<-3 # pick number of clusters
spe.fuz <- fanny(species.data, k=k, memb.exp=1.5)
summary(spe.fuz)
spefuz.g <- spe.fuz$clustering
# site membership
spe.fuz$membership
# nearest crisp clustering
groups <- spe.fuz$clustering

# run indicator species analysis with site group combinations
indval = multipatt(species.data, groups, control=how(nperm=999))
summary(indval) # obtain list of indicator for each site group
summary(indval, indvalcomp=TRUE) # displays indicator components of A and B
summary(indval, alpha = 1) # indicator species analysis for all species (alpha is 1 rather than 0.05); this still has some species missing that belong to all groups
indval$sign #visualize missing species that belong to all groups (those with an NA)

# exclude site group combinations because difficult to interpret ecologically
indvalori = multipatt(species.data, groups, duleg = TRUE, control = how(nperm=999)) # just does single sites or groups rather than combinations
summary(indvalori)

# species combinations as indicators of site groups
combos = combinespecies(species.data, max.order = 2)$XC
indvalcombo = multipatt(combos, groups, duleg=TRUE, control=how(nperm=999))
summary(indvalcombo, invalcomp=TRUE)

# species combinations whose frequency in group 2 in larger than 20%
B = strassoc(species.data, cluster = groups, func = "B")
sel = which(B[,2]>0.2)
sel
sc = indicators(X=species.data[,sel], cluster = groups, group = "Artificial Deep", verbose = TRUE, At=0.5, Bt=0.2)
print(sc, sqrtIVt = 0.6)

# prune indicators to reduce 
sc2 = pruneindicators(sc, At=0.8, Bt=0.2, verbose = TRUE)
print(sc2) # so these are great indicators for the site group that was coded in; also shows their coverage --> the indicators together cover ___% of the sites belonging to the target group!! 
  
```

```{r new_nMDS}
## code adapted from D. Urban's spring 2013 Landscape Ecology & Management Course (nms_etc.R) and Vegan Tutorial ##

library(vegan)
set.seed(318) 

species.metaMDS <- metaMDS(species.data, distance = "bray", k=2, trymax = 2000, autotransform = FALSE) 
  # performs nMDS; arguments are as follows:
  # 1st argument: input data; these data should already be transformed if autotransform is set to FALSE
  # 2nd argument: dissimilarity index
  # 3rd argument: k is number of dimensions
  # 4th argument: trymax is maximum number of random starts used to search for a stable solution (iterations)
  # 5th argument: the function does NOT autotransform data, rather it assumes your 1st argument is transformed correctly

stressplot(species.metaMDS) # Shepard plot

species.metaMDS$stress # stress value

plot(species.metaMDS) # rough plot
text(species.metaMDS$species[,1:2],rownames(species.metaMDS$species),cex=0.8,col="red") # add species labels to the plot (weighted averages)

## references
# https://cran.r-project.org/web/packages/vegan/vignettes/intro-vegan.pdf
# https://jonlefcheck.net/2012/10/24/nmds-tutorial-in-r/
# http://strata.uga.edu/6370/lecturenotes/multidimensionalScaling.html

# extract info neccessary for polished plotting
scores <- species.metaMDS$points # scores
species.nms <- cbind(scores, env_data) # datset with scores and env data

# weighted averages for species 
species.wa <- data.frame(species.metaMDS$species) 
species.wa <- cbind(row.names(species.wa), species.wa) 
library(plyr)
species.wa <- rename(species.wa, c("row.names(species.wa)"="species_code"))
#added and named the sp code column, the first column w/ sp names is visually but NOT functionally there 

stress <- species.metaMDS$stress # save stress value
library(ecodist)

species.bcd <- bcdist(species.data, rmzero=FALSE)###### CR added this

nms.xod1 <- dist(species.nms[,1]) # pearson correlation 
nms.xod2 <- dist(species.nms[,1:2]) # pearson correlation
r1<-cor(species.bcd,nms.xod1)
r2.1<-r1^2; r2.1
# axis 2 is 2-D minus 1-D solution:
r2<-cor(species.bcd,nms.xod2)
r2.2<-r2^2; 
r2.2<-r2.2-r2.1

# now plot it
NMDS = data.frame(MDS1 = species.nms[,1], MDS2 = species.nms[,2]) # data frame to work with
  yl<-paste("NMS 2 ", '(', as.character(round(r2.2, digits=2)*100), '%', ')', sep='') # y axis label
  xl<-paste("NMS 1 ", '(', as.character(round(r2.1, digits=2)*100), '%', ')', sep='') # x axis label
  title<-paste(" ", 'stress = ', as.character(round(stress, digits=2)), '', sep='') # title
  library(colorspace)
  
species.nms$Transect_Number <- as.factor(species.nms$Transect_Number)
  
   library(ggplot2) 
  ggplot()+
    coord_equal()+ # axes sizes equal
    theme_bw()+ # basic theme
    geom_point(data = NMDS, 
               aes(x = MDS1, y = MDS2, color = species.nms$Transect_Number), size = 5) +
  stat_ellipse(data = NMDS, 
                 aes(x=MDS1,y=MDS2,colour=species.nms$Transect_Number),
                 level = 0.50, linetype=2, size =1)+
  #geom_text(data=species.wa,
             # aes(x=species.wa[,2],y=species.wa[,3],label=species_code),
             # alpha=0.9, # adds weighted averages for species
             # position=position_jitter(width=0.1,height=0.2))+
    scale_y_continuous(name=yl) + # names y axis
    scale_x_continuous(name=xl) + # names x axis
    theme(axis.text=element_text(size=16), 
          axis.title=element_text(size=16), 
          legend.text=element_text(color="black", size=16), 
          legend.title=element_text(color="black", size = 16), 
          legend.position="bottom") + 
      scale_colour_manual(name = "Distance from Structure", labels = c("0" = "Structure", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"),
                       values = c("0" = "indianred2", "1" = "seagreen", "2" = "chartreuse", "3"= "darkturquoise"))+
      ggtitle(title)
  
  species.nms$Site <- as.factor(species.nms$Site)
  species.nms$Sampling_Period <- as.factor(species.nms$Sampling_Period)
  
species.nms$Sampling_Period <- factor(species.nms$Sampling_Period, c("Fall", "Winter", "Spring"))

  
library(ggplot2) 
  ggplot()+
    coord_equal()+ # axes sizes equal
    theme_bw()+ # basic theme
    #geom_point(data = NMDS, 
             # aes(x = MDS1, y = MDS2, color = species.nms$Sampling_Period), size = 5) +
  stat_ellipse(data = NMDS, 
                 aes(x=MDS1,y=MDS2,colour=species.nms$Sampling_Period),
                 level = 0.50, linetype=2, size =1)+
  #geom_text(data=species.wa,
             # aes(x=species.wa[,2],y=species.wa[,3],label=species_code),
             # alpha=0.9, # adds weighted averages for species
             # position=position_jitter(width=0.1,height=0.2))+
    scale_y_continuous(name=yl) + # names y axis
    scale_x_continuous(name=xl) + # names x axis
    theme(axis.text=element_text(size=16), 
          axis.title=element_text(size=16), 
          legend.text=element_text(color="black", size=16), 
          legend.title=element_text(color="black", size = 16), 
          legend.position="bottom") + 
      scale_colour_manual(name = "Season",#, labels = c("0" = "Structure", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"),
                     values = c("Fall" = "indianred2", "Winter" = "Seagreen", "Spring" = "darkturquoise"))+
  #   scale_colour_manual(name = "Site") +
    #, #labels = c("0" = "Structure", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"),
                      # values = c("330" = "indianred2", "345" = "seagreen", "2" = "chartreuse", "3"= "darkturquoise"))+
      ggtitle(title)
  
species.nms$Site <- as.factor(species.nms$Site)
 
  
library(ggplot2) 
  ggplot()+
    coord_equal()+ # axes sizes equal
    theme_bw()+ # basic theme
    geom_point(data = NMDS, 
              aes(x = MDS1, y = MDS2, color = species.nms$Site), size = 5) +
  stat_ellipse(data = NMDS, 
                 aes(x=MDS1,y=MDS2,colour=species.nms$Site),
                 level = 0.50, linetype=2, size =1)+
  #geom_text(data=species.wa,
             # aes(x=species.wa[,2],y=species.wa[,3],label=species_code),
             # alpha=0.9, # adds weighted averages for species
             # position=position_jitter(width=0.1,height=0.2))+
    scale_y_continuous(name=yl) + # names y axis
    scale_x_continuous(name=xl) + # names x axis
    theme(axis.text=element_text(size=16), 
          axis.title=element_text(size=16), 
          legend.text=element_text(color="black", size=16), 
          legend.title=element_text(color="black", size = 16), 
          legend.position="bottom") + 
      #scale_colour_manual(name = "Site",#, labels = c("0" = "Structure", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"),
                   #  values = c("330" = "indianred2", "345" = "Seagreen", "364" = "darkturquoise", "370" = "chartreuse", "372" = "coral", "378" = "magenta"))+
  #   scale_colour_manual(name = "Site") +
    #, #labels = c("0" = "Structure", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"),
                      # values = c("330" = "indianred2", "345" = "seagreen", "2" = "chartreuse", "3"= "darkturquoise"))+
    
    scale_colour_discrete(name= "Site")+
      ggtitle(title)
  
  
species.nms$Reef_Type <- as.factor(species.nms$Reef_Type)
  
library(ggplot2) 
  ggplot()+
    coord_equal()+ # axes sizes equal
    theme_bw()+ # basic theme
    geom_point(data = NMDS, 
              aes(x = MDS1, y = MDS2, color = species.nms$Reef_Type), size = 5) +
  stat_ellipse(data = NMDS, 
                 aes(x=MDS1,y=MDS2,colour=species.nms$Reef_Type),
                 level = 0.50, linetype=2, size =1)+
  #geom_text(data=species.wa,
             # aes(x=species.wa[,2],y=species.wa[,3],label=species_code),
             # alpha=0.9, # adds weighted averages for species
             # position=position_jitter(width=0.1,height=0.2))+
    scale_y_continuous(name=yl) + # names y axis
    scale_x_continuous(name=xl) + # names x axis
    theme(axis.text=element_text(size=16), 
          axis.title=element_text(size=16), 
          legend.text=element_text(color="black", size=16), 
          legend.title=element_text(color="black", size = 16), 
          legend.position="bottom") + 
      #scale_colour_manual(name = "Site",#, labels = c("0" = "Structure", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"),
                   #  values = c("330" = "indianred2", "345" = "Seagreen", "364" = "darkturquoise", "370" = "chartreuse", "372" = "coral", "378" = "magenta"))+
  #   scale_colour_manual(name = "Site") +
    #, #labels = c("0" = "Structure", "1" = "0-30 m", "2" = "30-60 m", "3" = "60-90 m"),
                      # values = c("330" = "indianred2", "345" = "seagreen", "2" = "chartreuse", "3"= "darkturquoise"))+
    
    scale_colour_discrete(name= "Reef Type")+
      ggtitle(title)
  
  
  #ggplot()+
   # coord_equal()+ # axes sizes equal
    #theme_bw()+ # basic theme
  #  geom_point(data = NMDS, 
   #            aes(x = MDS1, y = MDS2, color = species.nms$Transect_Number), 
    #           size=5) + # adds sample points
  #  geom_text(data=species.wa,
   #           aes(x=species.wa[,2],y=species.wa[,3],label=species_code),
    #          alpha=0.9, # adds weighted averages for species
     #         position=position_jitter(width=0.1,height=0.2))+
  #  stat_ellipse(data = NMDS, 
   #              aes(x=MDS1,y=MDS2,colour=species.nms$Reef_type),
    #             level = 0.50, linetype=2, size =1) + # adds ellipses for 95% confidence intervals
 #   scale_y_continuous(name=yl) + # names y axis
  #  scale_x_continuous(name=xl) + # names x axis
   # theme(axis.text=element_text(size=16), 
    #      axis.title=element_text(size=16), 
     #     legend.text=element_text(color="black", size=16), 
      #    legend.title=element_text(color="black", size = 16), 
       #   legend.position="bottom") + 
  #  scale_colour_manual(name = "Reef Type", 
  #                      values = c("Artificial" = "indianred2", "Natural" = "darkturquoise"))+
 #   scale_shape_manual (name="Reef Type", 
  #                      values = c("Artificial" = 17, "Natural" = 16))+
   # ggtitle(title)

# if get error saying removed rows (geom_text), check to make sure no N/A values in dataframe....
  
```

```{r nMDS}
library(ecodist)
library(vegan)
library(ggplot2)
# nmds calculations
out.nms <- calc_nms_ord(species.data = species.data)

# if from function
species.nms <- out.nms[[1]] # nmds scores
r2.2 <- out.nms[[2]] # r^2 for NMS 2
r2.1 <- out.nms[[3]] # r^2 for NMS 1
stress <- out.nms[[4]] # stress value

species.wa <- get_wght_avg_spec(species.nms, species.data) # species weighted average scores
#vect.vf <- get_env_vectors (species.nms, env_data) # environmental vectors that have pval < 0.05
hull.data.reefs  <-get_convex_hulls_reefs(species.nms) # convex hulls for reef type
#hull.data.depths <- get_convex_hulls_depth(species.nms) # convex hulls for depth categories


# Plots
#plot_nmds_reef_type(species.nms, species.wa) 
plot_nmds_transect_number(species.nms, species.wa)

#plot_nmds_transect_number(species.nms)
#plot_nmds_depth (species.nms)
#plot_nmds_complexity_reef_type(species.nms)

```

```{r PCA}

### Exploratory data analysis

library(dplyr)
summary(env_data)
names(env_data)

# remove rows where no water level logger data (NA values for temp, depth, and drr)

env_data <- filter(env_data, env_data$DRR != 'N/A')

#nat <- filter(env_data, env_data$Reef_Type == 'Natural')
#art <- filter(env_data, env_data$Reef_Type == 'Artificial')
#art_no_na<- filter(art, art$DMF_Area_sqft != 'N/A')

#env_data <-rbind(nat, art_no_na) # for all reefs
#env_data <- art_no_na # for ARTIFICIAL reefs

# pick env variables to do PCA with 
#env.data.pca<-env_data[,c(23, 9, 16, 14)] # select variables of interest for ARTIFICIAL
env.data.pca<-env_data[,c(10, 15, 25)] # select variables of interest for NATURAL or ALL

#env.data.pca$DMF_Area_sqft <- as.numeric(env.data.pca$DMF_Area_sqft)
env.data.pca$Temp_min <- as.numeric(env.data.pca$Temp_min)
env.data.pca$DRR <- as.numeric(env.data.pca$DRR)
env.data.pca$Latitude_DD <- as.numeric(env.data.pca$Latitude_DD)
#env.data.pca$avg_dep <- as.numeric(env.data.pca$avg_dep)
# convert the ENV data to z-scores
# this relavitizes the environemtnal data
# default is to center (subtract column means) and scale (divide by st dev)
env.z <- scale(as.matrix(env.data.pca))  

# Recall cor, cor.test, and pairs from previously ...
# you should already have env17 from the Mantel lab

env.cor <- cor(env.data.pca) # check for correlated variables
#cor.test(env.data.pca$avg_dep,env.data.pca$DRR)
#cor.test(env.data.pca$avg_dep,env.data.pca$Temp_min)


pairs(env.data.pca) # look for nonlinear relationships, eg xDepth sDepth
  # see that ver_rel and drr are correlated so can exclude one of them

# test normality
apply(env.data.pca,2,shapiro.test) 

# check for normal distribution
hist(env.data.pca$DRR)
hist(env.data.pca$Temp_min)
hist(env.data.pca$Latitude_DD)
#hist(env.data.pca$sed_stdv)
#hist(env.data.pca$avg_dep)
#hist(env.data.pca$DMF_Area_sqft)
#env.data.pca$Temp_avg <- as.numeric(env.data.pca$Temp_avg)
#hist(env.data.pca$Temp_avg)

# transform to correct skewed distributions
env.data.pca$DRR<-sqrt(env.data.pca$DRR)
hist(env.data.pca$DRR) #still not normal
#env.data.pca$sed_stdv<-sqrt(env.data.pca$sed_stdv)
#env.data.pca$avg_dep<-sqrt(env.data.pca$avg_dep)
#hist(env.data.pca$avg_dep)
#env.data.pca$DMF_Area_sqft<-sqrt(env.data.pca$DMF_Area_sqft)
#hist(env.data.pca$DMF_Area_sqft)
env.data.pca$Temp_min<-sqrt(env.data.pca$Temp_min)
hist(env.data.pca$Temp_min)
env.data.pca$Latitude_DD<-sqrt(env.data.pca$Latitude_DD)
hist(env.data.pca$Latitude_DD)

### PCA ----------

#make sure violations of assumptions aren't egregious before you begin PCA (which we did before)
set.seed(318)
# Do the PCA ...
# Here we have to use a correlation matrix because the variables
# are in different units:
env.pca <- princomp(env.data.pca, cor=T, scores=T)
#env.pca <- princomp(env.z, cor=T, scores=T)
  #cor=T to use correlation matrix (z-scores)
  #cor=F to use covariance matrix
  #scores = T means to calculate sample scores on new principal components for ordination

# Summary shows you the eigenvalues; print does the same:
summary(env.pca) 
#these are square roots of eigenvalues
#first pca has 76% of variance, next has 24% of variance
print(env.pca)

#eigenvalues
env.pca$sdev->env.pca.sdev
#write.csv(env.pca.sdev, "Inverts_Algae/2_Post-R_Data/env_pca_sdev.csv")

# Plot produces a scree plot of the eigenvalues per PC:
plot(env.pca)

# Print the loadings, to see which variables go with each PC:
print(env.pca$loadings) 
#these are regression coefficients 
# Print just the first 4, to 3 decimal places, and suppressing
# any loadings less than ABS(0.2) (this might not work):
#print(env.pca$loadings[,1:4],digits=3,cutoff=0.2)
print(env.pca$loadings,digits=3,cutoff=0.2)
# for lab report, can export this as a .csv file
# here we want to scan the loadings
#env17_pca_loadings<-print(env.pca$loadings[,1:4],digits=3,cutoff=0.2)
env_pca_loadings<-print(env.pca$loadings,digits=3,cutoff=0.2)
#write.csv(env_pca_loadings, "Inverts_Algae/2_Post-R_Data/env_pca_loadings.csv")

attributes(env.pca)  # shows objects in pca

# Biplot shows correlation vectors
# between the PCs and the original variables:
biplot(env.pca) 
# a bi plot plots two axes. It is a plot that puts two things on it in ordination world. One is a plot of sample scores. Second is the correlation vectors that it adds to the sample scores. Correlation vectors are red arrows, one for each environemntal variable. Length of arrow is scaled to magnitude of correlation. Can also look at raw numbers instead of plot if need to. These help you figure out what PCs refer to so you can know what to call your axes (e.g. soil chemistry, elevation, etc)
# The same, but plot asterisks for the plots (easier to see);
# here 99 is the number of samples:

# Plot the samples in the new PC space (defaults to PC 1 & 2):
plot(env.pca$scores) 
# An alternative, if you want to see different axes:
env.pca.scores <- as.data.frame(env.pca$scores)
names(env.pca.scores) # shows you that they are labelled Comp.1 etc

## Rename environmental variables
detach("package:dplyr", unload=TRUE)
library(plyr)
#env.data.pca<-rename(env.data.pca, c("DMF_Area_sqft"="Area", "avg_dep"="Depth", "DRR"="Complexity", "Temp_avg"="Temperature"))
env.data.pca<-rename(env.data.pca, c("Latitude_DD"="Latitude", "DRR"="Complexity", "Temp_min"="Temperature"))

# a table of correlations between PCs and the original variables: #HELP NOT WORKING
library(ecodist)
#env.data.pca <- na.omit(env.data.pca)
cor2m(env.pca.scores,env.data.pca)
# even tidier:
env.pca.cor2m <- cor2m(env.pca.scores,env.data.pca)
print(env.pca.cor2m, digits=3)

## Plot it!
plot_pca_reef_type() 
env_data$Transect_Number <- as.character(env_data$Transect_Number) #don't forget to add as.character if using numeric
plot_pca_transect_number()
#env_data$Site <- as.numeric(env_data$Site)
#env_data$Site <- filter(env_data, env_data$Site != "342")
env_data$Site <- as.factor(env_data$Site)
plot_pca_site()
#env_data$Sampling_Period <- as.character(env_data$Sampling_Period)
env_data$Sampling_Period <- factor(env_data$Sampling_Period, c("Fall", "Winter", "Spring"))

plot_pca_sampling_period()
#plot_pca_reef_type_depth()
#plot_pca_depth()
#plot_pca_depth_sed()
#plot_pca_depth_comp()

#AR number
#unique site
#season

```

  